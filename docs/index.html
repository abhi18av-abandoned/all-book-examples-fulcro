<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Tony Kay">
<link rel="icon" type="image/x-icon" href="assets/favicon.ico">
<title>Fulcro DevGuide All Examples</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>Fulcro DevGuide All Examples</h1>
<div class="details">
<span id="author" class="author">Tony Kay</span><br>
<span id="revnumber">version 37,</span>
<span id="revdate">August 25, 2019</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<style>
@media screen {
  button.inspector {
    float: right;
    right: 0px;
    font-size: 10pt;
    margin-bottom: 6px;
    padding: 6px;
    border-radius: 14px;
  }
}
@media print {
  button.inspector {display: none;}
}
.example {
  clear: both;
  margin-left: auto;
  margin-right: auto;
  position: relative;
  min-height: 400px;
  background-color: lightgray;
  border: 3px groove white;
  border-radius: 5px;
  padding: 5px;
}
.narrow.example { width: 50%; }
.wide.example { width: 80%; }
.short.example { min-height: 200px; }
.tall.example { min-height: 800px; }
</style>

<!-- div for server controls -->
<div id="server-controls"> </div>
<div class="exampleblock">
<div class="title">Example 1. <a id="SampleExample"></a><a href="#SampleExample">Sample Example</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('example-1')">Focus Inspector</button>
<div class="short narrow example" id="example-1"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.example-1</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]))

(defmutation bump-number [ignored]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state update <span class="symbol">:ui/number</span> <span class="keyword">inc</span>)))

(defsc Root [this {<span class="symbol">:ui/keys</span> [number]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/number</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:ui/number</span> <span class="integer">0</span>}}
  (dom/div
    (dom/h4 <span class="string"><span class="delimiter">&quot;</span><span class="content">This is an example.</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(bump-number {})])}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">You've clicked this button </span><span class="delimiter">&quot;</span></span> number <span class="string"><span class="delimiter">&quot;</span><span class="content"> times.</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 2. <a id="HTMLConverter"></a><a href="#HTMLConverter">HTML Converter</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('html-converter')">Focus Inspector</button>
<div class="short wide example" id="html-converter"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.html-converter</span>
  (<span class="symbol">:require</span>
    <span class="error">#</span>?(<span class="symbol">:cljs</span> [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
       <span class="symbol">:clj</span>  [com.fulcrologic.fulcro.dom-server <span class="symbol">:as</span> dom])
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.dom.html-entities <span class="symbol">:as</span> ent]
    [taoensso.timbre <span class="symbol">:as</span> log]
    [camel-snake-kebab.core <span class="symbol">:as</span> csk]
    [hickory.core <span class="symbol">:as</span> hc]
    [clojure.set <span class="symbol">:as</span> <span class="keyword">set</span>]
    [clojure.pprint <span class="symbol">:refer</span> [pprint]]
    [clojure.string <span class="symbol">:as</span> <span class="keyword">str</span>]))

(<span class="keyword">def</span> <span class="function">attr-renames</span> {<span class="symbol">:class</span>        <span class="symbol">:className</span>
                   <span class="symbol">:for</span>          <span class="symbol">:htmlFor</span>
                   <span class="symbol">:tabindex</span>     <span class="symbol">:tabIndex</span>
                   <span class="symbol">:viewbox</span>      <span class="symbol">:viewBox</span>
                   <span class="symbol">:spellcheck</span>   <span class="symbol">:spellcheck</span>
                   <span class="symbol">:autocorrect</span>  <span class="symbol">:autoCorrect</span>
                   <span class="symbol">:autocomplete</span> <span class="symbol">:autoComplete</span>})

(<span class="keyword">defn</span> <span class="function">fix-style</span> [style]
  (<span class="keyword">try</span>
    (<span class="keyword">let</span> [lines     (str/split style <span class="regexp"><span class="delimiter">#&quot;</span><span class="content">;</span><span class="delimiter">&quot;</span></span>)
          style-map (<span class="keyword">into</span> {} (<span class="keyword">map</span> (<span class="keyword">fn</span> [line]
                                    (<span class="keyword">let</span> [[k v] (str/split line <span class="regexp"><span class="delimiter">#&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span>)]
                                      [(csk/-&gt;camelCase (<span class="keyword">keyword</span> k)) (str/trim v)])) lines))]

      style-map)
    (<span class="keyword">catch</span> <span class="error">#</span>?(<span class="symbol">:cljs</span> <span class="symbol">:default</span> <span class="symbol">:clj</span> Exception) e
      style)))

(<span class="keyword">defn</span> <span class="function">classes-&gt;keyword</span> [className]
  (<span class="keyword">when</span> (<span class="keyword">seq</span> (str/trim className))
    (<span class="keyword">let</span> [classes (keep (<span class="keyword">fn</span> [e] (<span class="keyword">when</span> (<span class="keyword">seq</span> e) e)) (str/split className <span class="regexp"><span class="delimiter">#&quot;</span><span class="content">  *</span><span class="delimiter">&quot;</span></span>))
          kw      (<span class="keyword">keyword</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span> (str/join <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span> classes)))]
      kw)))

(<span class="keyword">defn-</span> <span class="function">chars-&gt;entity</span> [<span class="keyword">ns</span> <span class="namespace">chars</span>]
  (<span class="keyword">if</span> (<span class="keyword">=</span> <span class="char">\#</span> (<span class="keyword">first</span> <span class="keyword">chars</span>))
    (<span class="keyword">apply</span> <span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">&amp;</span><span class="delimiter">&quot;</span></span> (<span class="keyword">conj</span> <span class="keyword">chars</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">;</span><span class="delimiter">&quot;</span></span>))                        <span class="comment">; skip it. needs (parse int, convert base, format to 4-digit code)</span>
    (<span class="keyword">if</span> (<span class="keyword">seq</span> <span class="keyword">ns</span>)
      (<span class="keyword">symbol</span> <span class="keyword">ns</span> (<span class="keyword">apply</span> <span class="keyword">str</span> <span class="keyword">chars</span>))
      (<span class="keyword">symbol</span> (<span class="keyword">apply</span> <span class="keyword">str</span> <span class="keyword">chars</span>)))))

(<span class="keyword">defn-</span> <span class="function">parse-entity</span> [stream result {<span class="symbol">:keys</span> [entity-ns] <span class="symbol">:as</span> options}]
  (<span class="keyword">loop</span> [s stream <span class="keyword">chars</span> []]
    (<span class="keyword">let</span> [c (<span class="keyword">first</span> s)]
      (<span class="keyword">case</span> c
        (<span class="char">\;</span> <span class="predefined-constant">nil</span>) [(<span class="keyword">rest</span> s) (<span class="keyword">if</span> (<span class="keyword">seq</span> <span class="keyword">chars</span>)
                             (<span class="keyword">conj</span> result (chars-&gt;entity entity-ns <span class="keyword">chars</span>))
                             result)]
        (<span class="keyword">recur</span> (<span class="keyword">rest</span> s) (<span class="keyword">conj</span> <span class="keyword">chars</span> c))))))

(<span class="keyword">defn-</span> <span class="function">html-string-&gt;react-string</span> [html-str {<span class="symbol">:keys</span> [ignore-entities?] <span class="symbol">:as</span> options}]
  (<span class="keyword">if</span> ignore-entities?
    html-str
    (<span class="keyword">loop</span> [s html-str result []]
      (<span class="keyword">let</span> [c (<span class="keyword">first</span> s)
            [new-stream new-result] (<span class="keyword">case</span> c
                                      <span class="predefined-constant">nil</span> [<span class="predefined-constant">nil</span> result]
                                      <span class="char">\&amp;</span> (parse-entity (<span class="keyword">rest</span> s) result options)
                                      [(<span class="keyword">rest</span> s) (<span class="keyword">conj</span> result c)])]
        (<span class="keyword">if</span> new-stream
          (<span class="keyword">recur</span> new-stream new-result)
          (<span class="keyword">let</span> [segments (partition-by <span class="keyword">char?</span> new-result)
                result   (mapv (<span class="keyword">fn</span> [s]
                                 (<span class="keyword">if</span> (<span class="keyword">char?</span> (<span class="keyword">first</span> s))
                                   (<span class="keyword">apply</span> <span class="keyword">str</span> s)
                                   (<span class="keyword">first</span> s))) segments)]
            result))))))

(<span class="keyword">defn</span> <span class="function">element-&gt;call</span>
  ([elem]
   (element-&gt;call elem {}))
  ([elem {<span class="symbol">:keys</span> [ns-alias keep-empty-attrs?] <span class="symbol">:as</span> options}]
   (<span class="keyword">cond</span>
     (<span class="keyword">and</span> (<span class="keyword">string?</span> elem)
       (<span class="keyword">let</span> [elem (str/trim elem)]
         (<span class="keyword">or</span>
           (<span class="keyword">=</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> elem)
           (<span class="keyword">and</span>
             (str/starts-with? elem <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;!--</span><span class="delimiter">&quot;</span></span>)
             (str/ends-with? elem <span class="string"><span class="delimiter">&quot;</span><span class="content">--&gt;</span><span class="delimiter">&quot;</span></span>))
           (<span class="keyword">re-matches</span> <span class="regexp"><span class="delimiter">#&quot;</span><span class="content">^[ </span><span class="content">\n</span><span class="content">]*$</span><span class="delimiter">&quot;</span></span> elem)))) <span class="predefined-constant">nil</span>
     (<span class="keyword">string?</span> elem) (html-string-&gt;react-string (str/trim elem) options)
     (<span class="keyword">vector?</span> elem) (<span class="keyword">let</span> [tag               (<span class="keyword">name</span> (<span class="keyword">first</span> elem))
                          raw-props         (<span class="keyword">second</span> elem)
                          classkey          (<span class="keyword">when</span> (<span class="keyword">contains?</span> raw-props <span class="symbol">:class</span>)
                                              (classes-&gt;keyword (<span class="symbol">:class</span> raw-props)))
                          attrs             (cond-&gt; (set/rename-keys raw-props attr-renames)
                                              (<span class="keyword">contains?</span> raw-props <span class="symbol">:class</span>) (<span class="keyword">dissoc</span> <span class="symbol">:className</span>)
                                              (<span class="keyword">contains?</span> raw-props <span class="symbol">:style</span>) (update <span class="symbol">:style</span> fix-style))
                          children          (keep (<span class="keyword">fn</span> [c] (element-&gt;call c options)) (<span class="keyword">drop</span> <span class="integer">2</span> elem))
                          expanded-children (<span class="keyword">reduce</span>
                                              (<span class="keyword">fn</span> [acc c]
                                                (<span class="keyword">if</span> (<span class="keyword">vector?</span> c)
                                                  (<span class="keyword">into</span> [] (<span class="keyword">concat</span> acc c))
                                                  (<span class="keyword">conj</span> acc c)))
                                              []
                                              children)]
                      (<span class="keyword">concat</span> (<span class="keyword">list</span>) (keep <span class="keyword">identity</span>
                                       [(<span class="keyword">if</span> (<span class="keyword">seq</span> ns-alias)
                                          (<span class="keyword">symbol</span> ns-alias tag)
                                          (<span class="keyword">symbol</span> tag))
                                        (<span class="keyword">when</span> classkey classkey)
                                        (<span class="keyword">if</span> keep-empty-attrs?
                                          attrs
                                          (<span class="keyword">when</span> (<span class="keyword">seq</span> attrs) attrs))]) expanded-children))
     <span class="symbol">:otherwise</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">defn</span> <span class="function">html-&gt;clj-dom</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Convert an HTML fragment (containing just one tag) into a corresponding Dom cljs.

  Options is a map that can contain:

  - `ns-alias`: The primary DOM namespace alias to use.  If not set, the calls will not be namespaced.
  - `keep-empty-attrs?`: Boolean (default false). Output (dom/p {} ...) vs (dom/p ...).
  - `entity-ns`: String (defaults to </span><span class="content">\&quot;</span><span class="content">ent</span><span class="content">\&quot;</span><span class="content">). When named HTML entities are found they are converted to the Fulcro
    HTML entity ns symbols that stand for the correct unicode (e.g. </span><span class="content">\&quot;</span><span class="content">&amp;quot;</span><span class="content">\&quot;</span><span class="content"> -&gt; `ent/quot`). This is the ns alias
    for those.
  - `ignore-entities?`: Boolean (default false). If true, entities in strings will not be touched.
  </span><span class="delimiter">&quot;</span></span>
  ([html-fragment options]
   (<span class="keyword">let</span> [hiccup-list (<span class="keyword">map</span> hc/as-hiccup (hc/parse-fragment html-fragment))
         options     (cond-&gt; options
                       (<span class="keyword">not</span> (<span class="keyword">contains?</span> options <span class="symbol">:entity-ns</span>)) (<span class="keyword">assoc</span> <span class="symbol">:entity-ns</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">ent</span><span class="delimiter">&quot;</span></span>))]
     (<span class="keyword">let</span> [result (keep (<span class="keyword">fn</span> [e] (element-&gt;call e options)) hiccup-list)]
       (<span class="keyword">if</span> (<span class="keyword">&lt;</span> <span class="integer">1</span> (<span class="keyword">count</span> result))
         (<span class="keyword">vec</span> result)
         (<span class="keyword">first</span> result)))))
  ([html-fragment]
   (html-&gt;clj-dom html-fragment {<span class="symbol">:ns-alias</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">dom</span><span class="delimiter">&quot;</span></span>})))

(defmutation convert [p]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [html (<span class="keyword">get-in</span> @state [<span class="symbol">:top</span> <span class="symbol">:conv</span> <span class="symbol">:html</span>])
          cljs (html-&gt;clj-dom html)]
      (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span> [<span class="symbol">:top</span> <span class="symbol">:conv</span> <span class="symbol">:cljs</span>] {<span class="symbol">:code</span> cljs}))))

(defsc HTMLConverter [this {<span class="symbol">:keys</span> [html cljs]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:html</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;div id=</span><span class="content">\&quot;</span><span class="content">3</span><span class="content">\&quot;</span><span class="content"> class=</span><span class="content">\&quot;</span><span class="content">b</span><span class="content">\&quot;</span><span class="content">&gt;&lt;p&gt;Paragraph&lt;/p&gt;&lt;/div&gt;</span><span class="delimiter">&quot;</span></span> <span class="symbol">:cljs</span> {<span class="symbol">:code</span> (<span class="keyword">list</span>)}})
   <span class="symbol">:query</span>         [<span class="symbol">:cljs</span> <span class="symbol">:html</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:top</span> <span class="symbol">:conv</span>])}
  (dom/div {<span class="symbol">:className</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>}
    (dom/textarea {<span class="symbol">:cols</span>     <span class="integer">80</span> <span class="symbol">:rows</span> <span class="integer">10</span>
                   <span class="symbol">:onChange</span> (<span class="keyword">fn</span> [evt] (m/set-string! this <span class="symbol">:html</span> <span class="symbol">:event</span> evt))
                   <span class="symbol">:value</span>    html})
    (dom/button <span class="symbol">:.</span>c-button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [evt]
                                       (comp/transact! this `[(convert {})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Convert</span><span class="delimiter">&quot;</span></span>)
    (dom/pre {} (<span class="keyword">with-out-str</span> (pprint (<span class="symbol">:code</span> cljs))))))

(<span class="keyword">def</span> <span class="function">ui-html-convert</span> (comp/factory HTMLConverter))

(defsc Root [this {<span class="symbol">:keys</span> [converter]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:converter</span> {}}
   <span class="symbol">:query</span>         [{<span class="symbol">:converter</span> (comp/get-query HTMLConverter)}]}
  (ui-html-convert converter))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 3. <a id="InputFocusandReactRefsLifecycle"></a><a href="#InputFocusandReactRefsLifecycle">Input Focus and React Refs Lifecycle</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('focus-example')">Focus Inspector</button>
<div class="short narrow example" id="focus-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.focus-example</span>
  (<span class="symbol">:require</span> [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
            [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
            [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
            [goog.object <span class="symbol">:as</span> gobj]))

(defsc ClickToEditField [this {<span class="symbol">:keys</span> [value editing?]}]
  {<span class="symbol">:initial-state</span>      {<span class="symbol">:value</span>    <span class="string"><span class="delimiter">&quot;</span><span class="content">ABC</span><span class="delimiter">&quot;</span></span>
                        <span class="symbol">:db/id</span>    <span class="integer">1</span>
                        <span class="symbol">:editing?</span> <span class="predefined-constant">false</span>}
   <span class="symbol">:query</span>              [<span class="symbol">:db/id</span> <span class="symbol">:value</span> <span class="symbol">:editing?</span>]
   <span class="symbol">:ident</span>              [<span class="symbol">:field/by-id</span> <span class="symbol">:db/id</span>]
   <span class="symbol">:initLocalState</span>     (<span class="keyword">fn</span> [this _]
                         {<span class="symbol">:save-ref</span> (<span class="keyword">fn</span> [r] (gobj/set this <span class="string"><span class="delimiter">&quot;</span><span class="content">input-ref</span><span class="delimiter">&quot;</span></span> r))})
   <span class="symbol">:componentDidUpdate</span> (<span class="keyword">fn</span> [this prev-props _]
                         (<span class="keyword">when</span> (<span class="keyword">and</span> (<span class="keyword">not</span> (<span class="symbol">:editing?</span> prev-props)) (<span class="symbol">:editing?</span> (comp/props this)))
                           (<span class="keyword">when-let</span> [input-field (gobj/get this <span class="string"><span class="delimiter">&quot;</span><span class="content">input-ref</span><span class="delimiter">&quot;</span></span>)]
                             (<span class="keyword">.</span>focus input-field))))}
  (<span class="keyword">let</span> [save-ref (comp/get-state this <span class="symbol">:save-ref</span>)]
    (dom/div
      <span class="comment">; trigger a focus based on a state change (componentDidUpdate)</span>
      (dom/a {<span class="symbol">:onClick</span> #(m/toggle! this <span class="symbol">:editing?</span>)}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Click to focus (if not already editing): </span><span class="delimiter">&quot;</span></span>)
      (dom/input {<span class="symbol">:value</span>    value
                  <span class="symbol">:onChange</span> #(m/set-string! this <span class="symbol">:event</span> %)
                  <span class="symbol">:ref</span>      save-ref})
      <span class="comment">; do an explicit focus</span>
      (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> []
                              (<span class="keyword">when-let</span> [input-field (gobj/get this <span class="string"><span class="delimiter">&quot;</span><span class="content">input-ref</span><span class="delimiter">&quot;</span></span>)]
                                (<span class="keyword">.</span>focus input-field)
                                (<span class="keyword">.</span>setSelectionRange input-field <span class="integer">0</span> (<span class="keyword">..</span> input-field -value -length))))}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Highlight All</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">def</span> <span class="function">ui-click-to-edit</span> (comp/factory ClickToEditField))

(defsc Root [this {<span class="symbol">:keys</span> [field] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:field</span> (comp/get-query ClickToEditField)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:field</span> {}}}
  (ui-click-to-edit field))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 4. <a id="D3"></a><a href="#D3">D3</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('ui-d3')">Focus Inspector</button>
<div class="short narrow example" id="ui-d3"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.d3-example</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    <span class="comment">;; REQUIRES shadow-cljs, with &quot;d3&quot; in package.json</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">d3</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> d3]
    [goog.object <span class="symbol">:as</span> gobj]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]))

(<span class="keyword">defn</span> <span class="function">render-squares</span> [dom-node props]
  (<span class="keyword">let</span> [svg       (<span class="keyword">-&gt;</span> d3 (<span class="keyword">.</span>select dom-node))
        data      (clj-&gt;js (<span class="symbol">:squares</span> props))
        selection (<span class="keyword">-&gt;</span> svg
                    (<span class="keyword">.</span>selectAll <span class="string"><span class="delimiter">&quot;</span><span class="content">rect</span><span class="delimiter">&quot;</span></span>)
                    (<span class="keyword">.</span>data data (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-id d))))]
    (<span class="keyword">-&gt;</span> selection
      <span class="keyword">.</span>enter
      (<span class="keyword">.</span>append <span class="string"><span class="delimiter">&quot;</span><span class="content">rect</span><span class="delimiter">&quot;</span></span>)
      (<span class="keyword">.</span>style <span class="string"><span class="delimiter">&quot;</span><span class="content">fill</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-color d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
      <span class="keyword">.</span>transition
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-x d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-y d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">width</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-size d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">height</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-size d))))
    (<span class="keyword">-&gt;</span> selection
      <span class="keyword">.</span>exit
      <span class="keyword">.</span>transition
      (<span class="keyword">.</span>style <span class="string"><span class="delimiter">&quot;</span><span class="content">opacity</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
      <span class="keyword">.</span><span class="keyword">remove</span>)
    <span class="predefined-constant">false</span>))

(defsc D3Thing [this props]
  {<span class="symbol">:componentDidMount</span>     (<span class="keyword">fn</span> [this]
                            (<span class="keyword">when-let</span> [dom-node (gobj/get this <span class="string"><span class="delimiter">&quot;</span><span class="content">svg</span><span class="delimiter">&quot;</span></span>)]
                              (render-squares dom-node (comp/props this))))
   <span class="symbol">:shouldComponentUpdate</span> (<span class="keyword">fn</span> [this next-props next-state]
                            (<span class="keyword">when-let</span> [dom-node (gobj/get this <span class="string"><span class="delimiter">&quot;</span><span class="content">svg</span><span class="delimiter">&quot;</span></span>)]
                              (render-squares dom-node next-props))
                            <span class="predefined-constant">false</span>)}
  (dom/svg {<span class="symbol">:style</span>   {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">rgb(240,240,240)</span><span class="delimiter">&quot;</span></span>}
            <span class="symbol">:width</span>   <span class="integer">200</span> <span class="symbol">:height</span> <span class="integer">200</span>
            <span class="symbol">:ref</span>     (<span class="keyword">fn</span> [r] (gobj/set this <span class="string"><span class="delimiter">&quot;</span><span class="content">svg</span><span class="delimiter">&quot;</span></span> r))
            <span class="symbol">:viewBox</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0 0 1000 1000</span><span class="delimiter">&quot;</span></span>}))

(<span class="keyword">def</span> <span class="function">d3-thing</span> (comp/factory D3Thing))

(<span class="keyword">defn</span> <span class="function">random-square</span> []
  {
   <span class="symbol">:id</span>    (<span class="keyword">rand-int</span> <span class="integer">10000000</span>)
   <span class="symbol">:x</span>     (<span class="keyword">rand-int</span> <span class="integer">900</span>)
   <span class="symbol">:y</span>     (<span class="keyword">rand-int</span> <span class="integer">900</span>)
   <span class="symbol">:size</span>  (<span class="keyword">+</span> <span class="integer">50</span> (<span class="keyword">rand-int</span> <span class="integer">300</span>))
   <span class="symbol">:color</span> (<span class="keyword">case</span> (<span class="keyword">rand-int</span> <span class="integer">5</span>)
            <span class="integer">0</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>
            <span class="integer">1</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>
            <span class="integer">2</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">orange</span><span class="delimiter">&quot;</span></span>
            <span class="integer">3</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">blue</span><span class="delimiter">&quot;</span></span>
            <span class="integer">4</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>)})

(defmutation add-square [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state update <span class="symbol">:squares</span> <span class="keyword">conj</span> (random-square))))

(defmutation clear-squares [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">assoc</span> <span class="symbol">:squares</span> [])))

(defsc Root [this props]
  {<span class="symbol">:query</span>         [<span class="symbol">:squares</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:squares</span> []}}
  (dom/div
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this
                             `[(add-square {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Add Random Square</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this
                             `[(clear-squares {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Clear</span><span class="delimiter">&quot;</span></span>)
    (dom/br)
    (dom/br)
    (d3-thing props)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 5. <a id="DrawinginaCanvas"></a><a href="#DrawinginaCanvas">Drawing in a Canvas</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('hover-example')">Focus Inspector</button>
<div class="short narrow example" id="hover-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.hover-example</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.mutations <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc initial-state]]
    [goog.object <span class="symbol">:as</span> gobj]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]))

(<span class="keyword">defn</span> <span class="function">change-size*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Change the size of the canvas by some (pos or neg) amount..</span><span class="delimiter">&quot;</span></span>
  [state-map amount]
  (<span class="keyword">let</span> [current-size (<span class="keyword">get-in</span> state-map [<span class="symbol">:child/by-id</span> <span class="integer">0</span> <span class="symbol">:size</span>])
        new-size     (<span class="keyword">+</span> amount current-size)]
    (<span class="keyword">assoc-in</span> state-map [<span class="symbol">:child/by-id</span> <span class="integer">0</span> <span class="symbol">:size</span>] new-size)))

<span class="comment">; Make the canvas smaller. This will cause</span>
(defmutation ^<span class="symbol">:intern</span> make-smaller [p]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state change-size* <span class="integer">-20</span>)))

(defmutation ^<span class="symbol">:intern</span> make-bigger [p]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state change-size* <span class="integer">20</span>)))

(defmutation ^<span class="symbol">:intern</span> update-marker [{<span class="symbol">:keys</span> [coords]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span> [<span class="symbol">:child/by-id</span> <span class="integer">0</span> <span class="symbol">:marker</span>] coords)))


(<span class="keyword">defn</span> <span class="function">event-&gt;dom-coords</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Translate a javascript evt to a clj [x y] within the given dom element.</span><span class="delimiter">&quot;</span></span>
  [evt dom-ele]
  (<span class="keyword">let</span> [cx (<span class="keyword">.</span>-clientX evt)
        cy (<span class="keyword">.</span>-clientY evt)
        BB (<span class="keyword">.</span>getBoundingClientRect dom-ele)
        x  (<span class="keyword">-</span> cx (<span class="keyword">.</span>-left BB))
        y  (<span class="keyword">-</span> cy (<span class="keyword">.</span>-top BB))]
    [x y]))

(<span class="keyword">defn</span> <span class="function">event-&gt;normalized-coords</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Translate a javascript evt to a clj [x y] within the given dom element as normalized (0 to 1) coordinates.</span><span class="delimiter">&quot;</span></span>
  [evt dom-ele]
  (<span class="keyword">let</span> [cx (<span class="keyword">.</span>-clientX evt)
        cy (<span class="keyword">.</span>-clientY evt)
        BB (<span class="keyword">.</span>getBoundingClientRect dom-ele)
        w  (<span class="keyword">-</span> (<span class="keyword">.</span>-right BB) (<span class="keyword">.</span>-left BB))
        h  (<span class="keyword">-</span> (<span class="keyword">.</span>-bottom BB) (<span class="keyword">.</span>-top BB))
        x  (<span class="keyword">/</span> (<span class="keyword">-</span> cx (<span class="keyword">.</span>-left BB))
             w)
        y  (<span class="keyword">/</span> (<span class="keyword">-</span> cy (<span class="keyword">.</span>-top BB))
             h)]
    [x y]))

(<span class="keyword">defn</span> <span class="function">render-hover-and-marker</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Render the graphics in the canvas. Pass the component props and state. </span><span class="delimiter">&quot;</span></span>
  [canvas props coords]
  (<span class="keyword">let</span> [marker             (<span class="symbol">:marker</span> props)
        size               (<span class="symbol">:size</span> props)
        real-marker-coords (mapv (<span class="keyword">partial</span> <span class="keyword">*</span> size) marker)
        <span class="comment">; See HTML5 canvas docs</span>
        ctx                (<span class="keyword">.</span>getContext canvas <span class="string"><span class="delimiter">&quot;</span><span class="content">2d</span><span class="delimiter">&quot;</span></span>)
        clear              (<span class="keyword">fn</span> []
                             (set! (<span class="keyword">.</span>-fillStyle ctx) <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>)
                             (<span class="keyword">.</span>fillRect ctx <span class="integer">0</span> <span class="integer">0</span> size size))
        drawHover          (<span class="keyword">fn</span> []
                             (set! (<span class="keyword">.</span>-strokeStyle ctx) <span class="string"><span class="delimiter">&quot;</span><span class="content">gray</span><span class="delimiter">&quot;</span></span>)
                             (<span class="keyword">.</span>strokeRect ctx (<span class="keyword">-</span> (<span class="keyword">first</span> coords) <span class="integer">5</span>) (<span class="keyword">-</span> (<span class="keyword">second</span> coords) <span class="integer">5</span>) <span class="integer">10</span> <span class="integer">10</span>))
        drawMarker         (<span class="keyword">fn</span> []
                             (set! (<span class="keyword">.</span>-strokeStyle ctx) <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
                             (<span class="keyword">.</span>strokeRect ctx (<span class="keyword">-</span> (<span class="keyword">first</span> real-marker-coords) <span class="integer">5</span>) (<span class="keyword">-</span> (<span class="keyword">second</span> real-marker-coords) <span class="integer">5</span>) <span class="integer">10</span> <span class="integer">10</span>))]
    (<span class="keyword">.</span>save ctx)
    (clear)
    (drawHover)
    (drawMarker)
    (<span class="keyword">.</span>restore ctx)))

(<span class="keyword">defn</span> <span class="function">place-marker</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Update the marker in app state. Derives normalized coordinates, and updates the marker in application state.</span><span class="delimiter">&quot;</span></span>
  [child evt]
  (<span class="keyword">let</span> [canvas (gobj/get child <span class="string"><span class="delimiter">&quot;</span><span class="content">canvas</span><span class="delimiter">&quot;</span></span>)]
    (comp/transact! child `[(update-marker
                              {<span class="symbol">:coords</span> ~(event-&gt;normalized-coords evt canvas)})])))

(<span class="keyword">defn</span> <span class="function">hover-marker</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Updates the hover location of a proposed marker using canvas coordinates. Hover location
   is stored in component local state (meaning that a low-level app database query will not
   run to do the render that responds to this change)</span><span class="delimiter">&quot;</span></span>
  [child evt]
  (<span class="keyword">let</span> [canvas         (gobj/get child <span class="string"><span class="delimiter">&quot;</span><span class="content">canvas</span><span class="delimiter">&quot;</span></span>)
        updated-coords (event-&gt;dom-coords evt canvas)]
    (comp/set-state! child {<span class="symbol">:coords</span> updated-coords})
    (render-hover-and-marker canvas (comp/props child) updated-coords)))

(defsc Child [this {<span class="symbol">:keys</span> [id size] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>          [<span class="symbol">:id</span> <span class="symbol">:size</span> <span class="symbol">:marker</span>]
   <span class="symbol">:initial-state</span>  (<span class="keyword">fn</span> [_] {<span class="symbol">:id</span> <span class="integer">0</span> <span class="symbol">:size</span> <span class="integer">50</span> <span class="symbol">:marker</span> [<span class="float">0.5</span> <span class="float">0.5</span>]})
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [<span class="symbol">:child/by-id</span> id])
   <span class="symbol">:initLocalState</span> (<span class="keyword">fn</span> [this _] {<span class="symbol">:coords</span> [<span class="integer">-50</span> <span class="integer">-50</span>]})}
  <span class="comment">; Remember that this &quot;render&quot; just renders the DOM (e.g. the canvas DOM element). The graphical</span>
  <span class="comment">; rendering within the canvas is done during event handling.</span>
  <span class="comment">; size comes from props. Transactions on size will cause the canvas to resize in the DOM</span>
  (<span class="keyword">when-let</span> [canvas (gobj/get this <span class="string"><span class="delimiter">&quot;</span><span class="content">canvas</span><span class="delimiter">&quot;</span></span>)]
    (render-hover-and-marker canvas props (comp/get-state this <span class="symbol">:coords</span>)))
  (dom/canvas {<span class="symbol">:width</span>       (<span class="keyword">str</span> size <span class="string"><span class="delimiter">&quot;</span><span class="content">px</span><span class="delimiter">&quot;</span></span>)
               <span class="symbol">:height</span>      (<span class="keyword">str</span> size <span class="string"><span class="delimiter">&quot;</span><span class="content">px</span><span class="delimiter">&quot;</span></span>)
               <span class="symbol">:onMouseDown</span> (<span class="keyword">fn</span> [evt] (place-marker this evt))
               <span class="symbol">:onMouseMove</span> (<span class="keyword">fn</span> [evt] (hover-marker this evt))
               <span class="comment">; This is a pure React mechanism for getting the underlying DOM element.</span>
               <span class="comment">; Note: when the DOM element changes this fn gets called with nil</span>
               <span class="comment">; (to help you manage memory leaks), then the new element</span>
               <span class="symbol">:ref</span>         (<span class="keyword">fn</span> [r]
                              (<span class="keyword">when</span> r
                                (gobj/set this <span class="string"><span class="delimiter">&quot;</span><span class="content">canvas</span><span class="delimiter">&quot;</span></span> r)
                                (render-hover-and-marker r props (comp/get-state this <span class="symbol">:coords</span>))))
               <span class="symbol">:style</span>       {<span class="symbol">:border</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1px solid black</span><span class="delimiter">&quot;</span></span>}}))

(<span class="keyword">def</span> <span class="function">ui-child</span> (comp/factory Child))

(defsc Root [this {<span class="symbol">:keys</span> [child]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:child</span> (comp/get-query Child)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:ui/react-key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">K</span><span class="delimiter">&quot;</span></span> <span class="symbol">:child</span> (comp/get-initial-state Child <span class="predefined-constant">nil</span>)})}
  (dom/div
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(make-bigger {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Bigger!</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(make-smaller {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Smaller!</span><span class="delimiter">&quot;</span></span>)
    (dom/br)
    (dom/br)
    (ui-child child)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 6. <a id="UsingExternalReactLibraries"></a><a href="#UsingExternalReactLibraries">Using External React Libraries</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('victory-example')">Focus Inspector</button>
<div class="short narrow example" id="victory-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.victory-example</span>
  (<span class="symbol">:require</span>
    [cljs.pprint <span class="symbol">:refer</span> [cl-format]]
    <span class="comment">;; REQUIRES shadow-cljs, with &quot;victory&quot; in package.json</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">victory</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> [VictoryChart VictoryAxis VictoryLine]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.algorithms.react-interop <span class="symbol">:as</span> interop]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [taoensso.timbre <span class="symbol">:as</span> log]))

(<span class="keyword">defn</span> <span class="function">us-dollars</span> [n]
  (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">$</span><span class="delimiter">&quot;</span></span> (cl-format <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">~:d</span><span class="delimiter">&quot;</span></span> n)))

(<span class="keyword">def</span> <span class="function">vchart</span> (interop/react-factory VictoryChart))
(<span class="keyword">def</span> <span class="function">vaxis</span> (interop/react-factory VictoryAxis))
(<span class="keyword">def</span> <span class="function">vline</span> (interop/react-factory VictoryLine))

<span class="comment">;; &quot; [ {:year 1991 :value 2345 } ...] &quot;</span>
(defsc YearlyValueChart [this {<span class="symbol">:keys</span> [label plot-data x-step]}]
  (<span class="keyword">let</span> [start-year (<span class="keyword">apply</span> <span class="keyword">min</span> (<span class="keyword">map</span> <span class="symbol">:year</span> plot-data))
        end-year   (<span class="keyword">apply</span> <span class="keyword">max</span> (<span class="keyword">map</span> <span class="symbol">:year</span> plot-data))
        years      (<span class="keyword">range</span> start-year (<span class="keyword">inc</span> end-year) x-step)
        dates      (mapv #(<span class="keyword">new</span> js/Date % <span class="integer">1</span> <span class="integer">2</span>) years)
        {<span class="symbol">:keys</span> [min-value
                max-value]} (<span class="keyword">reduce</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [min-value max-value] <span class="symbol">:as</span> acc}
                                         {<span class="symbol">:keys</span> [value] <span class="symbol">:as</span> n}]
                                      (<span class="keyword">assoc</span> acc
                                        <span class="symbol">:min-value</span> (<span class="keyword">min</span> min-value value)
                                        <span class="symbol">:max-value</span> (<span class="keyword">max</span> max-value value)))
                              {}
                              plot-data)
        min-value  (<span class="keyword">int</span> (<span class="keyword">*</span> <span class="float">0.8</span> min-value))
        max-value  (<span class="keyword">int</span> (<span class="keyword">*</span> <span class="float">1.2</span> max-value))
        points     (mapv (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [year value]}]
                           {<span class="symbol">:x</span> (<span class="keyword">new</span> js/Date year <span class="integer">1</span> <span class="integer">2</span>)
                            <span class="symbol">:y</span> value})
                     plot-data)]
    (vchart <span class="predefined-constant">nil</span>
      (vaxis {<span class="symbol">:label</span>      label
              <span class="symbol">:standalone</span> <span class="predefined-constant">false</span>
              <span class="symbol">:scale</span>      <span class="string"><span class="delimiter">&quot;</span><span class="content">time</span><span class="delimiter">&quot;</span></span>
              <span class="symbol">:tickFormat</span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>getFullYear d))
              <span class="symbol">:tickValues</span> dates})
      (vaxis {<span class="symbol">:dependentAxis</span> <span class="predefined-constant">true</span>
              <span class="symbol">:standalone</span>    <span class="predefined-constant">false</span>
              <span class="symbol">:tickFormat</span>    (<span class="keyword">fn</span> [y] (us-dollars y))
              <span class="symbol">:domain</span>        <span class="error">#</span>js [min-value max-value]})
      (vline {<span class="symbol">:data</span> points}))))

(<span class="keyword">def</span> <span class="function">yearly-value-chart</span> (comp/factory YearlyValueChart))

(defsc Root [this props]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:label</span>     <span class="string"><span class="delimiter">&quot;</span><span class="content">Yearly Value</span><span class="delimiter">&quot;</span></span>
                   <span class="symbol">:x-step</span>    <span class="integer">2</span>
                   <span class="symbol">:plot-data</span> [{<span class="symbol">:year</span> <span class="integer">1983</span> <span class="symbol">:value</span> <span class="integer">20</span>}
                               {<span class="symbol">:year</span> <span class="integer">1984</span> <span class="symbol">:value</span> <span class="integer">100</span>}
                               {<span class="symbol">:year</span> <span class="integer">1985</span> <span class="symbol">:value</span> <span class="integer">90</span>}
                               {<span class="symbol">:year</span> <span class="integer">1986</span> <span class="symbol">:value</span> <span class="integer">89</span>}
                               {<span class="symbol">:year</span> <span class="integer">1987</span> <span class="symbol">:value</span> <span class="integer">88</span>}
                               {<span class="symbol">:year</span> <span class="integer">1988</span> <span class="symbol">:value</span> <span class="integer">85</span>}
                               {<span class="symbol">:year</span> <span class="integer">1989</span> <span class="symbol">:value</span> <span class="integer">83</span>}
                               {<span class="symbol">:year</span> <span class="integer">1990</span> <span class="symbol">:value</span> <span class="integer">80</span>}
                               {<span class="symbol">:year</span> <span class="integer">1991</span> <span class="symbol">:value</span> <span class="integer">70</span>}
                               {<span class="symbol">:year</span> <span class="integer">1992</span> <span class="symbol">:value</span> <span class="integer">80</span>}
                               {<span class="symbol">:year</span> <span class="integer">1993</span> <span class="symbol">:value</span> <span class="integer">90</span>}
                               {<span class="symbol">:year</span> <span class="integer">1994</span> <span class="symbol">:value</span> <span class="integer">95</span>}
                               {<span class="symbol">:year</span> <span class="integer">1995</span> <span class="symbol">:value</span> <span class="integer">110</span>}
                               {<span class="symbol">:year</span> <span class="integer">1996</span> <span class="symbol">:value</span> <span class="integer">120</span>}
                               {<span class="symbol">:year</span> <span class="integer">1997</span> <span class="symbol">:value</span> <span class="integer">160</span>}
                               {<span class="symbol">:year</span> <span class="integer">1998</span> <span class="symbol">:value</span> <span class="integer">170</span>}
                               {<span class="symbol">:year</span> <span class="integer">1999</span> <span class="symbol">:value</span> <span class="integer">180</span>}
                               {<span class="symbol">:year</span> <span class="integer">2000</span> <span class="symbol">:value</span> <span class="integer">180</span>}
                               {<span class="symbol">:year</span> <span class="integer">2001</span> <span class="symbol">:value</span> <span class="integer">200</span>}]}}
  (dom/div
    (yearly-value-chart props)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 7. <a id="ReactMotion"></a><a href="#ReactMotion">React Motion – Function as a Child</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('motion-example')">Focus Inspector</button>
<div class="short narrow example" id="motion-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.react-interop.react-motion-example</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-motion</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> [Motion spring]]
            [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
            [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
            [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
            [com.fulcrologic.fulcro.algorithms.react-interop <span class="symbol">:as</span> interop]))

(<span class="keyword">def</span> <span class="function">ui-motion</span> (interop/react-factory Motion))

(defsc Block [this {<span class="symbol">:block/keys</span> [<span class="keyword">name</span>]} {<span class="symbol">:keys</span> [top]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:block/id</span> <span class="symbol">:block/name</span>]
   <span class="symbol">:ident</span>         <span class="symbol">:block/id</span>
   <span class="symbol">:initial-state</span> {<span class="symbol">:block/id</span>   <span class="integer">1</span>
                   <span class="symbol">:block/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A Block</span><span class="delimiter">&quot;</span></span>}}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:position</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">relative</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:top</span>      top}}
    (dom/div
      (dom/label <span class="string"><span class="delimiter">&quot;</span><span class="content">Name?</span><span class="delimiter">&quot;</span></span>)
      (dom/input {<span class="symbol">:value</span>    <span class="keyword">name</span>
                  <span class="symbol">:onChange</span> #(m/set-string! this <span class="symbol">:block/name</span> <span class="symbol">:event</span> %)}))))

(<span class="keyword">def</span> <span class="function">ui-block</span> (comp/factory Block {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

(defsc Demo [this {<span class="symbol">:keys</span> [ui/slid? block]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/slid?</span> {<span class="symbol">:block</span> (comp/get-query Block)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:ui/slid?</span> <span class="predefined-constant">false</span> <span class="symbol">:block</span> {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>}}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:control</span> <span class="symbol">:demo</span>])}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:overflow</span>      <span class="string"><span class="delimiter">&quot;</span><span class="content">hidden</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:height</span>        <span class="string"><span class="delimiter">&quot;</span><span class="content">150px</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:margin</span>        <span class="string"><span class="delimiter">&quot;</span><span class="content">5px</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:padding</span>       <span class="string"><span class="delimiter">&quot;</span><span class="content">5px</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:border</span>        <span class="string"><span class="delimiter">&quot;</span><span class="content">1px solid black</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:border-radius</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">10px</span><span class="delimiter">&quot;</span></span>}}
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (m/toggle! this <span class="symbol">:ui/slid?</span>))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Toggle</span><span class="delimiter">&quot;</span></span>)
    (ui-motion {<span class="symbol">:style</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span> (spring (<span class="keyword">if</span> slid? <span class="integer">175</span> <span class="integer">0</span>))}}
      (<span class="keyword">fn</span> [p]
        (<span class="keyword">let</span> [y (comp/isoget p <span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>)]
          <span class="comment">; The binding wrapper ensures that internal fulcro bindings are held within the lambda</span>
          (comp/with-parent-context this
            (dom/div <span class="symbol">:.</span>demo
              (ui-block (comp/computed block {<span class="symbol">:top</span> y})))))))))

(<span class="keyword">def</span> <span class="function">ui-demo</span> (comp/factory Demo))

(defsc Root [this {<span class="symbol">:root/keys</span> [demo] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:root/demo</span> (comp/get-query Demo)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:root/demo</span> {}}}
  (ui-demo demo))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 8. <a id="HOCGoogleMaps"></a><a href="#HOCGoogleMaps">HOC With Google Maps</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('google-maps-example')">Focus Inspector</button>
<div class="tall wide example" id="google-maps-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.react-interop.google-maps-example</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">google-maps-react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> maps <span class="symbol">:refer</span> [GoogleApiWrapper Map Marker]]
    [com.fulcrologic.fulcro.algorithms.react-interop <span class="symbol">:as</span> interop <span class="symbol">:refer</span> [react-factory]]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]))

<span class="comment">;; Fulcro wrapper factory for google-maps-react's Map component</span>
(<span class="keyword">def</span> <span class="function">ui-google-map</span> (react-factory Map))

<span class="comment">;; Another wrapper factory for Marker component</span>
(<span class="keyword">def</span> <span class="function">ui-map-marker</span> (react-factory Marker))

(defsc LocationView [this {<span class="symbol">:map/keys</span> [latitude longitude] <span class="symbol">:as</span> props} {<span class="symbol">:keys</span> [injected-props] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:query</span>         [<span class="symbol">:map/latitude</span> <span class="symbol">:map/longitude</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::location-view</span>])
   <span class="symbol">:initial-state</span> {<span class="symbol">:map/latitude</span> <span class="float">45.5051</span> <span class="symbol">:map/longitude</span> <span class="float">-122.6750</span>}}
  (dom/div
    (dom/div {<span class="symbol">:style</span> {<span class="symbol">:width</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">520px</span><span class="delimiter">&quot;</span></span> <span class="symbol">:height</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">520px</span><span class="delimiter">&quot;</span></span>}}
      <span class="comment">;; The API docs say the the HOC adds a &quot;google&quot; prop that should be passed to Map</span>
      (ui-google-map {<span class="symbol">:google</span>        (<span class="keyword">.</span>-google injected-props)
                      <span class="symbol">:zoom</span>          <span class="integer">5</span>
                      <span class="symbol">:initialCenter</span> {<span class="symbol">:lat</span> latitude <span class="symbol">:lng</span> longitude}
                      <span class="symbol">:style</span>         {<span class="symbol">:width</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">90%</span><span class="delimiter">&quot;</span></span> <span class="symbol">:height</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">90%</span><span class="delimiter">&quot;</span></span>}}
        (ui-map-marker {<span class="symbol">:position</span> {<span class="symbol">:lat</span> latitude <span class="symbol">:lng</span> longitude}})))))

(<span class="keyword">def</span> <span class="function">injectGoogle</span> (GoogleApiWrapper <span class="error">#</span>js {<span class="symbol">:apiKey</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">AIzaSyAM9PWfj-rJDnmyJvh8QNkO4pgGzy5s_Yg</span><span class="delimiter">&quot;</span></span>}))
(<span class="keyword">def</span> <span class="function">ui-location-view</span> (interop/hoc-factory LocationView injectGoogle))

(defsc Root [this {<span class="symbol">:root/keys</span> [location-view] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:root/location-view</span> (comp/get-query LocationView)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:root/location-view</span> {}}}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">A Map View</span><span class="delimiter">&quot;</span></span>)
    (ui-location-view this location-view)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 9. <a id="StripeExample"></a><a href="#StripeExample">HOC With Stripe Elements</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('stripe-example')">Focus Inspector</button>
<div class="short narrow example" id="stripe-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.react-interop.stripe-example</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-stripe-elements</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> stripe <span class="symbol">:refer</span> [StripeProvider Elements injectStripe
                                                CardNumberElement
                                                CardExpiryElement
                                                CardCvcElement]]
    [com.fulcrologic.fulcro.algorithms.react-interop <span class="symbol">:as</span> interop]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]))

(<span class="keyword">def</span> <span class="function">test-key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">pk_test_crQ5GM8nCR8tM06YZcgunnmZ00qjGWhSNV</span><span class="delimiter">&quot;</span></span>)

<span class="comment">;; Wrap the stripe UI components in interop factories</span>
(<span class="keyword">def</span> <span class="function">ui-stripe-provider</span> (interop/react-factory StripeProvider))
(<span class="keyword">def</span> <span class="function">ui-elements</span> (interop/react-factory Elements))
(<span class="keyword">def</span> <span class="function">ui-card-element</span> (interop/react-factory CardNumberElement))
(<span class="keyword">def</span> <span class="function">ui-exp-element</span> (interop/react-factory CardExpiryElement))
(<span class="keyword">def</span> <span class="function">ui-cvc-element</span> (interop/react-factory CardCvcElement))

(<span class="keyword">defn</span> <span class="function">handle-result</span> [result]
  (<span class="keyword">let</span> [{{<span class="symbol">:keys</span> [message]} <span class="symbol">:error</span>
         {<span class="symbol">:keys</span> [id]}      <span class="symbol">:token</span>} (js-&gt;clj result <span class="symbol">:keywordize-keys</span> <span class="predefined-constant">true</span>)]
    (<span class="keyword">when</span> message
      (js/alert (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Error: </span><span class="delimiter">&quot;</span></span> message)))
    (<span class="keyword">when</span> id
      (js/alert (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Created payment token </span><span class="delimiter">&quot;</span></span> id)))))

(defsc CCForm [this {<span class="symbol">:customer/keys</span> [<span class="keyword">name</span>] <span class="symbol">:as</span> props} {<span class="symbol">:keys</span> [injected-props] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:query</span>         [<span class="symbol">:customer/name</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:customer/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::ccform</span>])}
  <span class="comment">;; isoget is a util that gets props from js maps in cljs, or CLJ ones in clj</span>
  (<span class="keyword">let</span> [stripe (comp/isoget injected-props <span class="string"><span class="delimiter">&quot;</span><span class="content">stripe</span><span class="delimiter">&quot;</span></span>)]
    (dom/form <span class="symbol">:.</span>ui.form
      {<span class="symbol">:onSubmit</span> (<span class="keyword">fn</span> [e] (<span class="keyword">.</span>preventDefault e))}
      (dom/div <span class="symbol">:.</span>field
        (dom/label <span class="string"><span class="delimiter">&quot;</span><span class="content">Name</span><span class="delimiter">&quot;</span></span>)
        (dom/input {<span class="symbol">:value</span>    <span class="keyword">name</span>
                    <span class="symbol">:onChange</span> #(m/set-string! this <span class="symbol">:customer/name</span> <span class="symbol">:event</span> %)}))
      (dom/div <span class="symbol">:.</span>field
        (dom/label <span class="string"><span class="delimiter">&quot;</span><span class="content">Card Number</span><span class="delimiter">&quot;</span></span>)
        (ui-card-element {}))
      (dom/div <span class="symbol">:.</span>two.fields
        (dom/div <span class="symbol">:.</span>field
          (dom/label <span class="string"><span class="delimiter">&quot;</span><span class="content">Expired</span><span class="delimiter">&quot;</span></span>)
          (ui-exp-element {}))
        (dom/div <span class="symbol">:.</span>field
          (dom/label <span class="string"><span class="delimiter">&quot;</span><span class="content">CVC</span><span class="delimiter">&quot;</span></span>)
          (ui-cvc-element {})))
      (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [e]
                              <span class="comment">;; createToken is a calls to the low-level JS API</span>
                              (<span class="keyword">-&gt;</span> (<span class="keyword">.</span>createToken stripe <span class="error">#</span>js {<span class="symbol">:type</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">card</span><span class="delimiter">&quot;</span></span> <span class="symbol">:name</span> <span class="keyword">name</span>})
                                (<span class="keyword">.</span>then (<span class="keyword">fn</span> [result] (handle-result result)))
                                (<span class="keyword">.</span><span class="keyword">catch</span> (<span class="keyword">fn</span> [result] (handle-result result)))))}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Pay</span><span class="delimiter">&quot;</span></span>))))

<span class="comment">;; NOTE: The js library says you should call injectStripe(FormComponent) to get your wrapped component,</span>
<span class="comment">;; so use interop to do that:</span>
(<span class="keyword">def</span> <span class="function">ui-cc-form</span> (interop/hoc-factory CCForm injectStripe))

(defsc Root [this {<span class="symbol">:keys</span> [root/cc-form] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:root/cc-form</span> (comp/get-query CCForm)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:root/cc-form</span> {}}}
  (dom/div
    (dom/h2 <span class="string"><span class="delimiter">&quot;</span><span class="content">Payment Form</span><span class="delimiter">&quot;</span></span>)
    <span class="comment">;; Stripe documentation says to wrap a stripe provider around the whole thing, and use the</span>
    <span class="comment">;; HOC form.</span>
    (ui-stripe-provider <span class="error">#</span>js {<span class="symbol">:apiKey</span> test-key}
      (ui-elements <span class="error">#</span>js {}
        <span class="comment">;; NOTE: Remember to pass parent's `this` to the child when using an HOC factory.</span>
        (ui-cc-form this cc-form)))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 10. <a id="UnionstoSelectType"></a><a href="#UnionstoSelectType">Unions to Select Type</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('union-example-1')">Focus Inspector</button>
<div class="short narrow example" id="union-example-1"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.union-example-1</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom <span class="symbol">:refer</span> [div table td tr th tbody]]
    [com.fulcrologic.fulcro.routing.legacy-ui-routers <span class="symbol">:as</span> r <span class="symbol">:refer</span> [defsc-router]]
    [book.elements <span class="symbol">:as</span> ele]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [taoensso.timbre <span class="symbol">:as</span> log]))

(<span class="keyword">defn</span> <span class="function">person?</span> [props] (<span class="keyword">contains?</span> props <span class="symbol">:person/id</span>))
(<span class="keyword">defn</span> <span class="function">place?</span> [props] (<span class="keyword">contains?</span> props <span class="symbol">:place/id</span>))
(<span class="keyword">defn</span> <span class="function">thing?</span> [props] (<span class="keyword">contains?</span> props <span class="symbol">:thing/id</span>))

(<span class="keyword">defn</span> <span class="function">item-ident</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Generate an ident from a person, place, or thing.</span><span class="delimiter">&quot;</span></span>
  [props]
  (<span class="keyword">cond</span>
    (person? props) [<span class="symbol">:person/id</span> (<span class="symbol">:person/id</span> props)]
    (place? props) [<span class="symbol">:place/id</span> (<span class="symbol">:place/id</span> props)]
    (thing? props) [<span class="symbol">:thing/id</span> (<span class="symbol">:thing/id</span> props)]
    <span class="symbol">:else</span> (log/error <span class="string"><span class="delimiter">&quot;</span><span class="content">Cannot generate a valid ident. Invalid props.</span><span class="delimiter">&quot;</span></span> props)))

(<span class="keyword">defn</span> <span class="function">item-key</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Generate a distinct react key for a person, place, or thing</span><span class="delimiter">&quot;</span></span>
  [props] (<span class="keyword">str</span> (item-ident props)))

(<span class="keyword">defn</span> <span class="function">make-person</span> [id n] {<span class="symbol">:person/id</span> id <span class="symbol">:person/name</span> n})
(<span class="keyword">defn</span> <span class="function">make-place</span> [id n] {<span class="symbol">:place/id</span> id <span class="symbol">:place/name</span> n})
(<span class="keyword">defn</span> <span class="function">make-thing</span> [id n] {<span class="symbol">:thing/id</span> id <span class="symbol">:thing/label</span> n})

(defsc PersonDetail [this {<span class="symbol">:person/keys</span> [id <span class="keyword">name</span>] <span class="symbol">:as</span> props}]
  <span class="comment">; defsc-router expects there to be an initial state for each possible target. We'll cause this to be a &quot;no selection&quot;</span>
  <span class="comment">; state so that the detail screen that starts out will show &quot;Nothing selected&quot;. We initialize all three in case</span>
  <span class="comment">; we later re-order them in the defsc-router.</span>
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span>         [<span class="symbol">:person/id</span> <span class="symbol">:person/name</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:person/id</span> <span class="symbol">:no-selection</span>}}
  (dom/div
    (<span class="keyword">if</span> (<span class="keyword">=</span> id <span class="symbol">:no-selection</span>)
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing selected</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Details about person </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(defsc PlaceDetail [this {<span class="symbol">:place/keys</span> [id <span class="keyword">name</span>] <span class="symbol">:as</span> props}]
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span>         [<span class="symbol">:place/id</span> <span class="symbol">:place/name</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:place/id</span> <span class="symbol">:no-selection</span>}}
  (dom/div
    (<span class="keyword">if</span> (<span class="keyword">=</span> id <span class="symbol">:no-selection</span>)
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing selected</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Details about place </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(defsc ThingDetail [this {<span class="symbol">:thing/keys</span> [id label] <span class="symbol">:as</span> props}]
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span>         [<span class="symbol">:thing/id</span> <span class="symbol">:thing/label</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:thing/id</span> <span class="symbol">:no-selection</span>}}
  (dom/div
    (<span class="keyword">if</span> (<span class="keyword">=</span> id <span class="symbol">:no-selection</span>)
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing selected</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Details about thing </span><span class="delimiter">&quot;</span></span> label))))

(defsc PersonListItem [this
                       {<span class="symbol">:person/keys</span> [id <span class="keyword">name</span>] <span class="symbol">:as</span> props}
                       {<span class="symbol">:keys</span> [onSelect] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> [<span class="symbol">:person/id</span> <span class="symbol">:person/name</span>]}
  (dom/li {<span class="symbol">:onClick</span> #(onSelect (item-ident props))}
    (dom/a {} (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Person </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (comp/factory PersonListItem {<span class="symbol">:keyfn</span> item-key}))

(defsc PlaceListItem [this {<span class="symbol">:place/keys</span> [id <span class="keyword">name</span>] <span class="symbol">:as</span> props} {<span class="symbol">:keys</span> [onSelect] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> [<span class="symbol">:place/id</span> <span class="symbol">:place/name</span>]}
  (dom/li {<span class="symbol">:onClick</span> #(onSelect (item-ident props))}
    (dom/a {} (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Place </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content"> : </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(<span class="keyword">def</span> <span class="function">ui-place</span> (comp/factory PlaceListItem {<span class="symbol">:keyfn</span> item-key}))

(defsc ThingListItem [this {<span class="symbol">:thing/keys</span> [id label] <span class="symbol">:as</span> props} {<span class="symbol">:keys</span> [onSelect] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> [<span class="symbol">:thing/id</span> <span class="symbol">:thing/label</span>]}
  (dom/li {<span class="symbol">:onClick</span> #(onSelect (item-ident props))}
    (dom/a {} (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Thing </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content"> : </span><span class="delimiter">&quot;</span></span> label))))

(<span class="keyword">def</span> <span class="function">ui-thing</span> (comp/factory ThingListItem item-key))

(defsc-router ItemDetail [this props]
  {<span class="symbol">:router-id</span>      <span class="symbol">:detail-router</span>
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:default-route</span>  PersonDetail
   <span class="symbol">:router-targets</span> {<span class="symbol">:person/id</span> PersonDetail
                    <span class="symbol">:place/id</span>  PlaceDetail
                    <span class="symbol">:thing/id</span>  ThingDetail}}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">No route</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">def</span> <span class="function">ui-item-detail</span> (comp/factory ItemDetail))

(defsc ItemUnion [this props]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> (<span class="keyword">fn</span> [] {<span class="symbol">:person/id</span> (comp/get-query PersonListItem)
                  <span class="symbol">:place/id</span>  (comp/get-query PlaceListItem)
                  <span class="symbol">:thing/id</span>  (comp/get-query ThingListItem)})}
  (<span class="keyword">cond</span>
    (person? props) (ui-person props)
    (place? props) (ui-place props)
    (thing? props) (ui-thing props)
    <span class="symbol">:else</span> (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid ident used in app state.</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-item-union</span> (comp/factory ItemUnion {<span class="symbol">:keyfn</span> item-key}))

(defsc ItemList [this {<span class="symbol">:keys</span> [items]} {<span class="symbol">:keys</span> [onSelect]}]
  {
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p]
                    <span class="comment">; These would normally be loaded...but for demo purposes we just hand code a few</span>
                    {<span class="symbol">:items</span> [(make-person <span class="integer">1</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Tony</span><span class="delimiter">&quot;</span></span>)
                             (make-thing <span class="integer">2</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Toaster</span><span class="delimiter">&quot;</span></span>)
                             (make-place <span class="integer">3</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New York</span><span class="delimiter">&quot;</span></span>)
                             (make-person <span class="integer">4</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>)
                             (make-thing <span class="integer">5</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Pillow</span><span class="delimiter">&quot;</span></span>)
                             (make-place <span class="integer">6</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Canada</span><span class="delimiter">&quot;</span></span>)]})
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:lists/id</span> <span class="symbol">:singleton</span>])
   <span class="symbol">:query</span>         [{<span class="symbol">:items</span> (comp/get-query ItemUnion)}]}
  (dom/ul <span class="symbol">:.</span>ui.list
    (<span class="keyword">map</span> (<span class="keyword">fn</span> [i] (ui-item-union (comp/computed i {<span class="symbol">:onSelect</span> onSelect}))) items)))

(<span class="keyword">def</span> <span class="function">ui-item-list</span> (comp/factory ItemList))

(defsc Root [this {<span class="symbol">:keys</span> [item-list item-detail]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:item-list</span> (comp/get-query ItemList)}
                   {<span class="symbol">:item-detail</span> (comp/get-query ItemDetail)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] (<span class="keyword">merge</span>
                            (r/routing-tree
                              (r/make-route <span class="symbol">:detail</span> [(r/router-instruction <span class="symbol">:detail-router</span> [<span class="symbol">:param/kind</span> <span class="symbol">:param/id</span>])]))
                            {<span class="symbol">:item-list</span>   (comp/get-initial-state ItemList <span class="predefined-constant">nil</span>)
                             <span class="symbol">:item-detail</span> (comp/get-initial-state ItemDetail <span class="predefined-constant">nil</span>)}))}
  (<span class="keyword">let</span> [<span class="comment">; This is the only thing to do: Route the to the detail screen with the given route params!</span>
        showDetail (<span class="keyword">fn</span> [[kind id]]
                     (comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:detail</span> <span class="symbol">:route-params</span> {<span class="symbol">:kind</span> ~kind <span class="symbol">:id</span> ~id}})]))]
    <span class="comment">; devcards, embed in iframe so we can use bootstrap css easily</span>
    (div {<span class="symbol">:key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">example-frame-key</span><span class="delimiter">&quot;</span></span>}
      (dom/style <span class="string"><span class="delimiter">&quot;</span><span class="content">.boxed {border: 1px solid black}</span><span class="delimiter">&quot;</span></span>)
      (table <span class="symbol">:.</span>ui.table {}
        (tbody
          (tr
            (th <span class="string"><span class="delimiter">&quot;</span><span class="content">Items</span><span class="delimiter">&quot;</span></span>)
            (th <span class="string"><span class="delimiter">&quot;</span><span class="content">Detail</span><span class="delimiter">&quot;</span></span>))
          (tr
            (td (ui-item-list (comp/computed item-list {<span class="symbol">:onSelect</span> showDetail})))
            (td (ui-item-detail item-detail))))))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 11. <a id="RecursiveDemo1"></a><a href="#RecursiveDemo1">Recursive Demo 1</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('recursive-demo-1')">Focus Inspector</button>
<div class="short narrow example" id="recursive-demo-1"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.recursive-demo-1</span>
  (<span class="symbol">:require</span> [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
            [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]))

(<span class="keyword">defn</span> <span class="function">make-person</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Make a person data map with optional children.</span><span class="delimiter">&quot;</span></span>
  [id <span class="keyword">name</span> children]
  (cond-&gt; {<span class="symbol">:db/id</span> id <span class="symbol">:person/name</span> <span class="keyword">name</span>}
    children (<span class="keyword">assoc</span> <span class="symbol">:person/children</span> children)))

(<span class="keyword">declare</span> <span class="function">ui-person</span>)

<span class="comment">; The ... in the query means there will be children of the same type, of arbitrary depth</span>
<span class="comment">; it is equivalent to (comp/get-query Person), but calling get query on yourself would</span>
<span class="comment">; lead to infinite compiler recursion.</span>
(defsc Person [this {<span class="symbol">:keys</span> [<span class="symbol">:person/name</span> <span class="symbol">:person/children</span>]}]
  {<span class="symbol">:query</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span> {<span class="symbol">:person/children</span> '<span class="keyword">..</span><span class="keyword">.</span>}])
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p]
                    (make-person <span class="integer">1</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>
                      [(make-person <span class="integer">2</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Suzy</span><span class="delimiter">&quot;</span></span> [])
                       (make-person <span class="integer">3</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Billy</span><span class="delimiter">&quot;</span></span> [])
                       (make-person <span class="integer">4</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Rae</span><span class="delimiter">&quot;</span></span>
                         [(make-person <span class="integer">5</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Ian</span><span class="delimiter">&quot;</span></span>
                            [(make-person <span class="integer">6</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Zoe</span><span class="delimiter">&quot;</span></span> [])])])]))
   <span class="symbol">:ident</span>         [<span class="symbol">:person/id</span> <span class="symbol">:db/id</span>]}
  (dom/div
    (dom/h4 <span class="keyword">name</span>)
    (<span class="keyword">when</span> (<span class="keyword">seq</span> children)
      (dom/div
        (dom/ul
          (<span class="keyword">map</span> (<span class="keyword">fn</span> [p]
                 (ui-person p))
            children))))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (comp/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [person-of-interest]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:person-of-interest</span> {}}
   <span class="symbol">:query</span>         [{<span class="symbol">:person-of-interest</span> (comp/get-query Person)}]}
  (dom/div
    (ui-person person-of-interest)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 12. <a id="RecursiveDemo2"></a><a href="#RecursiveDemo2">Recursive Demo 2</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('recursive-demo-2')">Focus Inspector</button>
<div class="short narrow example" id="recursive-demo-2"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.recursive-demo-2</span>
  (<span class="symbol">:require</span> [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
            [com.fulcrologic.fulcro.mutations <span class="symbol">:refer</span> [defmutation]]
            [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]))

(<span class="keyword">declare</span> <span class="function">ui-person</span>)

(defmutation make-older [{<span class="symbol">:keys</span> [id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">update-in</span> [<span class="symbol">:person/id</span> id <span class="symbol">:person/age</span>] <span class="keyword">inc</span>)))

(defsc Person [this {<span class="symbol">:keys</span> [db/id person/name person/spouse person/age]}]
  {<span class="symbol">:query</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span> <span class="symbol">:person/age</span> {<span class="symbol">:person/spouse</span> <span class="integer">1</span>}]) <span class="comment">; force limit the depth</span>
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p]
                    <span class="comment">; this does look screwy...you can nest the same map in the recursive position,</span>
                    <span class="comment">; and it'll just merge into the one that was previously normalized during normalization.</span>
                    <span class="comment">; You need to do this or you won't get the loop in the database.</span>
                    {<span class="symbol">:db/id</span>         <span class="integer">1</span>
                     <span class="symbol">:person/name</span>   <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>
                     <span class="symbol">:person/age</span>    <span class="integer">20</span>
                     <span class="symbol">:person/spouse</span> {<span class="symbol">:db/id</span>         <span class="integer">2</span>
                                     <span class="symbol">:person/name</span>   <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>
                                     <span class="symbol">:person/age</span>    <span class="integer">22</span>
                                     <span class="symbol">:person/spouse</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>}}})
   <span class="symbol">:ident</span>         [<span class="symbol">:person/id</span> <span class="symbol">:db/id</span>]}
  (dom/div
    (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Name:</span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>)
    (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Age:</span><span class="delimiter">&quot;</span></span> age
      (dom/button {<span class="symbol">:onClick</span>
                   #(comp/transact! this `[(make-older {<span class="symbol">:id</span> ~id})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Make Older</span><span class="delimiter">&quot;</span></span>))
    (<span class="keyword">when</span> spouse
      (dom/ul
        (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Spouse:</span><span class="delimiter">&quot;</span></span> (ui-person spouse))))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (comp/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [person-of-interest]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:person-of-interest</span> {}}
   <span class="symbol">:query</span>         [{<span class="symbol">:person-of-interest</span> (comp/get-query Person)}]}
  (dom/div
    (ui-person person-of-interest)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 13. <a id="RecursiveDemo3"></a><a href="#RecursiveDemo3">Recursive Demo 3</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('recursive-demo-3')">Focus Inspector</button>
<div class="short narrow example" id="recursive-demo-3"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.recursive-demo-3</span>
  (<span class="symbol">:require</span> [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
            [com.fulcrologic.fulcro.mutations <span class="symbol">:refer</span> [defmutation]]
            [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]))

(<span class="keyword">declare</span> <span class="function">ui-person</span>)

(defmutation make-older [{<span class="symbol">:keys</span> [id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">update-in</span> [<span class="symbol">:person/id</span> id <span class="symbol">:person/age</span>] <span class="keyword">inc</span>)))

<span class="comment">; We use computed to track the depth. Targeted refreshes will retain the computed they got on</span>
<span class="comment">; the most recent render. This allows us to detect how deep we are.</span>
(defsc Person [this
               {<span class="symbol">:keys</span> [db/id person/name person/spouse person/age]} <span class="comment">; props</span>
               {<span class="symbol">:keys</span> [render-depth] <span class="symbol">:or</span> {render-depth <span class="integer">0</span>}}] <span class="comment">; computed</span>
  {<span class="symbol">:query</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span> <span class="symbol">:person/age</span> {<span class="symbol">:person/spouse</span> <span class="integer">1</span>}]) <span class="comment">; force limit the depth</span>
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p]
                    {<span class="symbol">:db/id</span>         <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">20</span>
                     <span class="symbol">:person/spouse</span> {<span class="symbol">:db/id</span>         <span class="integer">2</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>
                                     <span class="symbol">:person/age</span>    <span class="integer">22</span>
                                     <span class="symbol">:person/spouse</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>}}})
   <span class="symbol">:ident</span>         [<span class="symbol">:person/id</span> <span class="symbol">:db/id</span>]}
  (dom/div
    (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Name:</span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>)
    (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Age:</span><span class="delimiter">&quot;</span></span> age
      (dom/button {<span class="symbol">:onClick</span>
                   #(comp/transact! this `[(make-older {<span class="symbol">:id</span> ~id})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Make Older</span><span class="delimiter">&quot;</span></span>))
    (<span class="keyword">when</span> (<span class="keyword">and</span> (<span class="keyword">=</span> <span class="integer">0</span> render-depth) spouse)
      (dom/ul
        (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Spouse:</span><span class="delimiter">&quot;</span></span>
          <span class="comment">; recursively render, but increase the render depth so we can know when a</span>
          <span class="comment">; targeted UI refresh would accidentally push the UI deeper.</span>
          (ui-person (comp/computed spouse {<span class="symbol">:render-depth</span> (<span class="keyword">inc</span> render-depth)})))))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (comp/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [person-of-interest]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:person-of-interest</span> {}}
   <span class="symbol">:query</span>         [{<span class="symbol">:person-of-interest</span> (comp/get-query Person)}]}
  (dom/div
    (ui-person person-of-interest)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 14. <a id="RecursiveDemo4"></a><a href="#RecursiveDemo4">Recursive Demo 4</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('recursive-demo-bullets')">Focus Inspector</button>
<div class="short narrow example" id="recursive-demo-bullets"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.recursive-demo-bullets</span>
  (<span class="symbol">:require</span> [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
            [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
            [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
            [clojure.string <span class="symbol">:as</span> <span class="keyword">str</span>]))

(<span class="keyword">declare</span> <span class="function">ui-item</span>)

(defsc Item [this {<span class="symbol">:keys</span> [ui/checked? item/label item/subitems]}]
  {<span class="symbol">:query</span> (<span class="keyword">fn</span> [] [<span class="symbol">:ui/checked?</span> <span class="symbol">:db/id</span> <span class="symbol">:item/label</span> {<span class="symbol">:item/subitems</span> '<span class="keyword">..</span><span class="keyword">.</span>}])
   <span class="symbol">:ident</span> [<span class="symbol">:item/by-id</span> <span class="symbol">:db/id</span>]}
  (dom/li
    (dom/input {<span class="symbol">:type</span>     <span class="string"><span class="delimiter">&quot;</span><span class="content">checkbox</span><span class="delimiter">&quot;</span></span>
                <span class="symbol">:checked</span>  (<span class="keyword">if</span> (boolean? checked?) checked? <span class="predefined-constant">false</span>)
                <span class="symbol">:onChange</span> #(m/toggle! this <span class="symbol">:ui/checked?</span>)})
    label
    (<span class="keyword">when</span> subitems
      (dom/ul
        (<span class="keyword">map</span> ui-item subitems)))))

(<span class="keyword">def</span> <span class="function">ui-item</span> (comp/factory Item {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc ItemList [this {<span class="symbol">:keys</span> [db/id list/items] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> {<span class="symbol">:list/items</span> (comp/get-query Item)}]
   <span class="symbol">:ident</span> [<span class="symbol">:list/by-id</span> <span class="symbol">:db/id</span>]}
  (dom/ul
    (<span class="keyword">map</span> ui-item items)))

(<span class="keyword">def</span> <span class="function">ui-item-list</span> (comp/factory ItemList {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [<span class="keyword">list</span>]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p]
                    {<span class="symbol">:list</span> {<span class="symbol">:db/id</span>      <span class="integer">1</span>
                            <span class="symbol">:list/items</span> [{<span class="symbol">:db/id</span> <span class="integer">2</span> <span class="symbol">:item/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>
                                          <span class="symbol">:item/subitems</span>
                                                 [{<span class="symbol">:db/id</span>      <span class="integer">7</span>
                                                   <span class="symbol">:item/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A.1</span><span class="delimiter">&quot;</span></span>
                                                   <span class="symbol">:item/subitems</span>
                                                               [{<span class="symbol">:db/id</span>         <span class="integer">8</span>
                                                                 <span class="symbol">:item/label</span>    <span class="string"><span class="delimiter">&quot;</span><span class="content">A.1.1</span><span class="delimiter">&quot;</span></span>
                                                                 <span class="symbol">:item/subitems</span> []}]}]}
                                         {<span class="symbol">:db/id</span>      <span class="integer">3</span>
                                          <span class="symbol">:item/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>
                                          <span class="symbol">:item/subitems</span>
                                                      [{<span class="symbol">:db/id</span> <span class="integer">6</span> <span class="symbol">:item/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B.1</span><span class="delimiter">&quot;</span></span>}]}
                                         {<span class="symbol">:db/id</span>         <span class="integer">4</span>
                                          <span class="symbol">:item/label</span>    <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span>
                                          <span class="symbol">:item/subitems</span> []}
                                         {<span class="symbol">:db/id</span>         <span class="integer">5</span>
                                          <span class="symbol">:item/label</span>    <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>
                                          <span class="comment">; just for fun..nest a dupe under D</span>
                                          <span class="symbol">:item/subitems</span> [{<span class="symbol">:db/id</span> <span class="integer">6</span> <span class="symbol">:item/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B.1</span><span class="delimiter">&quot;</span></span>}]}]}})
   <span class="symbol">:query</span>         [{<span class="symbol">:list</span> (comp/get-query ItemList)}]}
  (dom/div
    (ui-item-list <span class="keyword">list</span>)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 15. <a id="InitialState"></a><a href="#InitialState">Initial State</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('initial-app-state')">Focus Inspector</button>
<div class="short narrow example" id="initial-app-state"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.initial-app-state</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]))

(<span class="keyword">defmethod</span> <span class="function">m/mutate</span> 'nav/settings [{<span class="symbol">:keys</span> [state]} sym params]
  {<span class="symbol">:action</span> (<span class="keyword">fn</span> [] (<span class="keyword">swap!</span> state <span class="keyword">assoc</span> <span class="symbol">:panes</span> [<span class="symbol">:settings</span> <span class="symbol">:singleton</span>]))})

(<span class="keyword">defmethod</span> <span class="function">m/mutate</span> 'nav/main [{<span class="symbol">:keys</span> [state]} sym params]
  {<span class="symbol">:action</span> (<span class="keyword">fn</span> [] (<span class="keyword">swap!</span> state <span class="keyword">assoc</span> <span class="symbol">:panes</span> [<span class="symbol">:main</span> <span class="symbol">:singleton</span>]))})

(defsc ItemLabel [this {<span class="symbol">:keys</span> [value]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [value]}] {<span class="symbol">:value</span> value})
   <span class="symbol">:query</span>         [<span class="symbol">:value</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:labels/by-value</span> value])}
  (dom/p value))

(<span class="keyword">def</span> <span class="function">ui-label</span> (comp/factory ItemLabel {<span class="symbol">:keyfn</span> <span class="symbol">:value</span>}))

<span class="comment">;; Foo and Bar are elements of a mutli-type to-many union relation (each leaf can be a Foo or a Bar). We use params to</span>
<span class="comment">;; allow initial state to put more than one in place and have them be unique.</span>
(defsc Foo [this {<span class="symbol">:keys</span> [label]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:type</span> <span class="symbol">:id</span> {<span class="symbol">:label</span> (comp/get-query ItemLabel)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id label]}] {<span class="symbol">:id</span> id <span class="symbol">:type</span> <span class="symbol">:foo</span> <span class="symbol">:label</span> (comp/get-initial-state ItemLabel {<span class="symbol">:value</span> label})})}
  (dom/div
    (dom/h2 <span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>)
    (ui-label label)))

(<span class="keyword">def</span> <span class="function">ui-foo</span> (comp/factory Foo {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

(defsc Bar [this {<span class="symbol">:keys</span> [label]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:type</span> <span class="symbol">:id</span> {<span class="symbol">:label</span> (comp/get-query ItemLabel)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id label]}] {<span class="symbol">:id</span> id <span class="symbol">:type</span> <span class="symbol">:bar</span> <span class="symbol">:label</span> (comp/get-initial-state ItemLabel {<span class="symbol">:value</span> label})})}
  (dom/div
    (dom/h2 <span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>)
    (ui-label label)))

(<span class="keyword">def</span> <span class="function">ui-bar</span> (comp/factory Bar {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

<span class="comment">;; This is the to-many union component. It is the decision maker (it has no state or rendering of it's own)</span>
<span class="comment">;; The initial state of this component is the to-many (vector) value of various children</span>
<span class="comment">;; The render just determines which thing it is, and passes on the that renderer</span>
(defsc ListItem [this {<span class="symbol">:keys</span> [id <span class="keyword">type</span>] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] [(comp/get-initial-state Bar {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}) (comp/get-initial-state Foo {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>}) (comp/get-initial-state Bar {<span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span>})])
   <span class="symbol">:query</span>         (<span class="keyword">fn</span> [] {<span class="symbol">:foo</span> (comp/get-query Foo) <span class="symbol">:bar</span> (comp/get-query Bar)}) <span class="comment">; use lambda for unions</span>
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="keyword">type</span> id])}                        <span class="comment">; lambda for unions</span>
  (<span class="keyword">case</span> <span class="keyword">type</span>
    <span class="symbol">:foo</span> (ui-foo props)
    <span class="symbol">:bar</span> (ui-bar props)
    (dom/p <span class="string"><span class="delimiter">&quot;</span><span class="content">No Item renderer!</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-list-item</span> (comp/factory ListItem {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

<span class="comment">;; Settings and Main are the target &quot;Panes&quot; of a to-one union (e.g. imagine tabs...we use buttons as the tab switching in</span>
<span class="comment">;; this example). The initial state looks very much like any other component, as does the rendering.</span>
(defsc Settings [this {<span class="symbol">:keys</span> [label]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:type</span> <span class="symbol">:settings</span> <span class="symbol">:id</span> <span class="symbol">:singleton</span> <span class="symbol">:label</span> (comp/get-initial-state ItemLabel {<span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Settings</span><span class="delimiter">&quot;</span></span>})})
   <span class="symbol">:query</span>         [<span class="symbol">:type</span> <span class="symbol">:id</span> {<span class="symbol">:label</span> (comp/get-query ItemLabel)}]}
  (ui-label label))

(<span class="keyword">def</span> <span class="function">ui-settings</span> (comp/factory Settings {<span class="symbol">:keyfn</span> <span class="symbol">:type</span>}))

(defsc Main [this {<span class="symbol">:keys</span> [label]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:type</span> <span class="symbol">:main</span> <span class="symbol">:id</span> <span class="symbol">:singleton</span> <span class="symbol">:label</span> (comp/get-initial-state ItemLabel {<span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Main</span><span class="delimiter">&quot;</span></span>})})
   <span class="symbol">:query</span>         [<span class="symbol">:type</span> <span class="symbol">:id</span> {<span class="symbol">:label</span> (comp/get-query ItemLabel)}]}
  (ui-label label))

(<span class="keyword">def</span> <span class="function">ui-main</span> (comp/factory Main {<span class="symbol">:keyfn</span> <span class="symbol">:type</span>}))

<span class="comment">;; This is a to-one union component. Again, it has no state of its own or rendering. The initial state is the single</span>
<span class="comment">;; child that should appear. Fulcro (during startup) will detect this component, and then use the query to figure out</span>
<span class="comment">;; what other children (the ones that have initial-state defined) should be placed into app state.</span>
(defsc PaneSwitcher [this {<span class="symbol">:keys</span> [id <span class="keyword">type</span>] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] (comp/get-initial-state Main <span class="predefined-constant">nil</span>))
   <span class="symbol">:query</span>         (<span class="keyword">fn</span> [] {<span class="symbol">:settings</span> (comp/get-query Settings) <span class="symbol">:main</span> (comp/get-query Main)})
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="keyword">type</span> id])}
  (<span class="keyword">case</span> <span class="keyword">type</span>
    <span class="symbol">:settings</span> (ui-settings props)
    <span class="symbol">:main</span> (ui-main props)
    (dom/p <span class="string"><span class="delimiter">&quot;</span><span class="content">NO PANE!</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-panes</span> (comp/factory PaneSwitcher {<span class="symbol">:keyfn</span> <span class="symbol">:type</span>}))

<span class="comment">;; The root. Everything just composes to here (state and query)</span>
<span class="comment">;; Note, in core (where we create the app) there is no need to say anything about initial state!</span>
(defsc Root [this {<span class="symbol">:keys</span> [panes items]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:panes</span> (comp/get-initial-state PaneSwitcher <span class="predefined-constant">nil</span>)
                                <span class="symbol">:items</span> (comp/get-initial-state ListItem <span class="predefined-constant">nil</span>)})
   <span class="symbol">:query</span>         [{<span class="symbol">:items</span> (comp/get-query ListItem)}
                   {<span class="symbol">:panes</span> (comp/get-query PaneSwitcher)}]}
  (dom/div
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [evt] (comp/transact! this '[(nav/settings)]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Go to settings</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [evt] (comp/transact! this '[(nav/main)]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Go to main</span><span class="delimiter">&quot;</span></span>)

    (ui-panes panes)

    (dom/h1 <span class="string"><span class="delimiter">&quot;</span><span class="content">Heterogenous list:</span><span class="delimiter">&quot;</span></span>)

    (dom/ul
      (mapv ui-list-item items))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 16. <a id="TargetingMutationReturnValues"></a><a href="#TargetingMutationReturnValues">Targeting Mutation Return Values</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('server-targeting-return-values-into-app-state')">Focus Inspector</button>
<div class="short narrow example" id="server-targeting-return-values-into-app-state"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.server-targeting-return-values-into-app-state</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.algorithms.data-targeting <span class="symbol">:as</span> targeting]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="error">#</span>_#_#_(<span class="keyword">def</span> <span class="function">ids</span> (<span class="keyword">atom</span> <span class="integer">1</span>))

    (server/defmutation trigger-error [_]
      (action [env]
        {<span class="symbol">:error</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">something bad</span><span class="delimiter">&quot;</span></span>}))

    (server/defmutation create-entity [{<span class="symbol">:keys</span> [db/id]}]
      (action [env]
        (<span class="keyword">let</span> [real-id (<span class="keyword">swap!</span> ids <span class="keyword">inc</span>)]
          {<span class="symbol">:db/id</span>        real-id
           <span class="symbol">:entity/label</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Entity </span><span class="delimiter">&quot;</span></span> real-id)
           <span class="symbol">:tempids</span>      {id real-id}})))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
(<span class="keyword">declare</span> <span class="function">Item</span> Entity)

(defmutation trigger-error
  <span class="string"><span class="delimiter">&quot;</span><span class="content">This mutation causes an unstructured error (just a map), but targets that value
   to the field `:error-message` on the component that invokes it.</span><span class="delimiter">&quot;</span></span>
  [_]
  (remote [{<span class="symbol">:keys</span> [ast <span class="keyword">ref</span>]}]
    (m/with-target ast (<span class="keyword">conj</span> <span class="keyword">ref</span> <span class="symbol">:error-message</span>))))

(defmutation create-entity
  <span class="string"><span class="delimiter">&quot;</span><span class="content">This mutation simply creates a new entity, but targets it to a specific location
  (in this case the `:child` field of the invoking component).</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [where?] <span class="symbol">:as</span> params}]
  (remote [{<span class="symbol">:keys</span> [ast <span class="keyword">ref</span> state]}]
    (<span class="keyword">let</span> [path-to-target (<span class="keyword">conj</span> <span class="keyword">ref</span> <span class="symbol">:children</span>)
          <span class="comment">; replacement cannot succeed if there is nothing present...turn those into appends</span>
          no-items?      (<span class="keyword">empty?</span> (<span class="keyword">get-in</span> @state path-to-target))
          where?         (<span class="keyword">if</span> (<span class="keyword">and</span> no-items? (<span class="keyword">=</span> <span class="symbol">:replace-first</span> where?))
                           <span class="symbol">:append</span>
                           where?)]
      (cond-&gt; (<span class="keyword">-&gt;</span> ast
                <span class="comment">; always set what kind of thing is coming back</span>
                (m/returning state Entity)
                <span class="comment">; strip the where?...it is for local use only (not server)</span>
                (m/with-params (<span class="keyword">dissoc</span> params <span class="symbol">:where?</span>)))
        <span class="comment">; Add the targeting...based on where?</span>
        (<span class="keyword">=</span> <span class="symbol">:append</span> where?) (m/with-target (targeting/append-to path-to-target)) <span class="comment">; where to put it</span>
        (<span class="keyword">=</span> <span class="symbol">:prepend</span> where?) (m/with-target (targeting/prepend-to path-to-target))
        (<span class="keyword">=</span> <span class="symbol">:replace-first</span> where?) (m/with-target (targeting/replace-at (<span class="keyword">conj</span> path-to-target <span class="integer">0</span>)))))))

(defsc Entity [this {<span class="symbol">:keys</span> [entity/label]}]
  {<span class="symbol">:ident</span> [<span class="symbol">:entity/by-id</span> <span class="symbol">:db/id</span>]
   <span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:entity/label</span>]}
  (dom/div label))

(<span class="keyword">def</span> <span class="function">ui-entity</span> (comp/factory Entity {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc Item [this {<span class="symbol">:keys</span> [db/id error-message children]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:error-message</span> {<span class="symbol">:children</span> (comp/get-query Entity)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="symbol">:param/id</span> <span class="symbol">:children</span> []}
   <span class="symbol">:ident</span>         [<span class="symbol">:item/by-id</span> <span class="symbol">:db/id</span>]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:float</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:width</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">200px</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:margin</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">5px</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:border</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1px solid black</span><span class="delimiter">&quot;</span></span>}}
    (dom/h4 (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Item </span><span class="delimiter">&quot;</span></span> id))
    (<span class="keyword">when</span> error-message
      (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">The generated error was: </span><span class="delimiter">&quot;</span></span> (<span class="keyword">pr-str</span> error-message)))
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [evt] (comp/transact! this `[(trigger-error {})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Trigger Error</span><span class="delimiter">&quot;</span></span>)
    (dom/h6 <span class="string"><span class="delimiter">&quot;</span><span class="content">Children</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">map</span> ui-entity children)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [evt] (comp/transact! this `[(create-entity {<span class="symbol">:where?</span> <span class="symbol">:prepend</span> <span class="symbol">:db/id</span> ~(comp/tempid)})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Prepend one!</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [evt] (comp/transact! this `[(create-entity {<span class="symbol">:where?</span> <span class="symbol">:append</span> <span class="symbol">:db/id</span> ~(comp/tempid)})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Append one!</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [evt] (comp/transact! this `[(create-entity {<span class="symbol">:where?</span> <span class="symbol">:replace-first</span> <span class="symbol">:db/id</span> ~(comp/tempid)})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Replace first one!</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-item</span> (comp/factory Item {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [root/items]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:root/items</span> (comp/get-query Item)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:root/items</span> [{<span class="symbol">:id</span> <span class="integer">1</span>} {<span class="symbol">:id</span> <span class="integer">2</span>} {<span class="symbol">:id</span> <span class="integer">3</span>}]}}
  (dom/div
    (mapv ui-item items)
    (dom/br {<span class="symbol">:style</span> {<span class="symbol">:clear</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">both</span><span class="delimiter">&quot;</span></span>}})))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 17. <a id="Parent-ChildOwnership"></a><a href="#Parent-ChildOwnership">Parent-Child Ownership</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('parent-child-ownership-relations')">Focus Inspector</button>
<div class="short narrow example" id="parent-child-ownership-relations"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.parent-child-ownership-relations</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.algorithms.merge <span class="symbol">:as</span> <span class="keyword">merge</span>]
    [taoensso.timbre <span class="symbol">:as</span> log]))

<span class="comment">; Not using an atom, so use a tree for app state (will auto-normalize via ident functions)</span>
(<span class="keyword">def</span> <span class="function">initial-state</span> {<span class="symbol">:ui/react-key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">abc</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:main-list</span>    {<span class="symbol">:list/id</span>    <span class="integer">1</span>
                                   <span class="symbol">:list/name</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">My List</span><span class="delimiter">&quot;</span></span>
                                   <span class="symbol">:list/items</span> [{<span class="symbol">:item/id</span> <span class="integer">1</span> <span class="symbol">:item/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}
                                                {<span class="symbol">:item/id</span> <span class="integer">2</span> <span class="symbol">:item/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>}]}})

(m/defmutation delete-item
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation: Delete an item from a list</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [list-id id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Deleting item</span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content">from list</span><span class="delimiter">&quot;</span></span> list-id)
    (<span class="keyword">swap!</span> state
      (<span class="keyword">fn</span> [s]
        (<span class="keyword">-&gt;</span> s
          (update <span class="symbol">:items</span> <span class="keyword">dissoc</span> id)
          (merge/remove-ident* [<span class="symbol">:items</span> id] [<span class="symbol">:lists</span> list-id <span class="symbol">:list/items</span>]))))))

(defsc Item [this
             {<span class="symbol">:keys</span> [item/id item/label] <span class="symbol">:as</span> props}
             {<span class="symbol">:keys</span> [on-delete] <span class="symbol">:as</span> computed}]              ;; <b class="conum">(1)</b>
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id label]}] {<span class="symbol">:item/id</span> id <span class="symbol">:item/label</span> label})
   <span class="symbol">:query</span>         [<span class="symbol">:item/id</span> <span class="symbol">:item/label</span>]
   <span class="symbol">:ident</span>         [<span class="symbol">:items</span> <span class="symbol">:item/id</span>]}
  (dom/li label (dom/button {<span class="symbol">:onClick</span> #(on-delete id)} <span class="string"><span class="delimiter">&quot;</span><span class="content">X</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-list-item</span> (comp/factory Item {<span class="symbol">:keyfn</span> <span class="symbol">:item/id</span>}))

(defsc ItemList [this {<span class="symbol">:list/keys</span> [id <span class="keyword">name</span> items]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:list/id</span>    <span class="integer">1</span>
                           <span class="symbol">:list/name</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">List 1</span><span class="delimiter">&quot;</span></span>
                           <span class="symbol">:list/items</span> [(comp/get-initial-state Item {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>})
                                        (comp/get-initial-state Item {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>})]})
   <span class="symbol">:query</span>         [<span class="symbol">:list/id</span> <span class="symbol">:list/name</span> {<span class="symbol">:list/items</span> (comp/get-query Item)}]
   <span class="symbol">:ident</span>         [<span class="symbol">:lists</span> <span class="symbol">:list/id</span>]}
  (<span class="keyword">let</span> [delete-item (<span class="keyword">fn</span> [item-id] (comp/transact! this [(delete-item {<span class="symbol">:list-id</span> id <span class="symbol">:id</span> item-id})])) ;; <b class="conum">(2)</b>
        item-props  (<span class="keyword">fn</span> [i] (comp/computed i {<span class="symbol">:on-delete</span> delete-item}))]
    (dom/div
      (dom/h4 <span class="keyword">name</span>)
      (dom/ul
        (<span class="keyword">map</span> #(ui-list-item (item-props %)) items)))))

(<span class="keyword">def</span> <span class="function">ui-list</span> (comp/factory ItemList))

(defsc Root [this {<span class="symbol">:keys</span> [main-list]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:main-list</span> (comp/get-initial-state ItemList {})})
   <span class="symbol">:query</span>         [{<span class="symbol">:main-list</span> (comp/get-query ItemList)}]}
  (dom/div (ui-list main-list)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 18. <a id="TreetoDBwithQueries"></a><a href="#TreetoDBwithQueries">Tree to DB with Queries</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('tree-to-db')">Focus Inspector</button>
<div class="short narrow example" id="tree-to-db"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.tree-to-db</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [devcards.util.edn-renderer <span class="symbol">:refer</span> [html-edn]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.algorithms.normalize <span class="symbol">:as</span> fnorm]))

(defsc SubQuery [t p]
  {<span class="symbol">:ident</span> [<span class="symbol">:sub/by-id</span> <span class="symbol">:id</span>]
   <span class="symbol">:query</span> [<span class="symbol">:id</span> <span class="symbol">:data</span>]})

(defsc TopQuery [t p]
  {<span class="symbol">:ident</span> [<span class="symbol">:top/by-id</span> <span class="symbol">:id</span>]
   <span class="symbol">:query</span> [<span class="symbol">:id</span> {<span class="symbol">:subs</span> (comp/get-query SubQuery)}]})

(defmutation normalize-from-to-result [ignored-params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [result (fnorm/tree-&gt;db TopQuery (<span class="symbol">:from</span> @state) <span class="predefined-constant">true</span>)]
      (<span class="keyword">swap!</span> state <span class="keyword">assoc</span> <span class="symbol">:result</span> result))))

(defmutation reset [ignored-params] (action [{<span class="symbol">:keys</span> [state]}] (<span class="keyword">swap!</span> state <span class="keyword">dissoc</span> <span class="symbol">:result</span>)))

(defsc Root [this {<span class="symbol">:keys</span> [from result]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:from</span> <span class="symbol">:result</span>]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params]
                    <span class="comment">; some data we're just shoving into the database from root...***not normalized***</span>
                    {<span class="symbol">:from</span> {<span class="symbol">:id</span> <span class="symbol">:top-1</span> <span class="symbol">:subs</span> [{<span class="symbol">:id</span> <span class="symbol">:sub-1</span> <span class="symbol">:data</span> <span class="integer">1</span>} {<span class="symbol">:id</span> <span class="symbol">:sub-2</span> <span class="symbol">:data</span> <span class="integer">2</span>}]}})}
  (dom/div
    (dom/div
      (dom/h4 <span class="string"><span class="delimiter">&quot;</span><span class="content">Pretend Incoming Tree</span><span class="delimiter">&quot;</span></span>)
      (html-edn from))
    (dom/div
      (dom/h4 <span class="string"><span class="delimiter">&quot;</span><span class="content">Normalized Result (click below to normalize)</span><span class="delimiter">&quot;</span></span>)
      (<span class="keyword">when</span> result
        (html-edn result)))
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (comp/transact! this `[(normalize-from-to-result {})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Normalized (Run tree-&gt;db)</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (comp/transact! this `[(reset {})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Clear Result</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 19. <a id="MergingwithaComponent"></a><a href="#MergingwithaComponent">Merging with a Component</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('merge-component')">Focus Inspector</button>
<div class="short narrow example" id="merge-component"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.merge-component</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.algorithms.merge <span class="symbol">:as</span> <span class="keyword">merge</span>]))

(defsc Counter [this {<span class="symbol">:keys</span> [counter/id counter/n] <span class="symbol">:as</span> props} {<span class="symbol">:keys</span> [onClick] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:query</span> [<span class="symbol">:counter/id</span> <span class="symbol">:counter/n</span>]
   <span class="symbol">:ident</span> [<span class="symbol">:counter/by-id</span> <span class="symbol">:counter/id</span>]}
  (dom/div <span class="symbol">:.</span>counter
    (dom/span <span class="symbol">:.</span>counter-label
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Current count for counter </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content">:  </span><span class="delimiter">&quot;</span></span>))
    (dom/span <span class="symbol">:.</span>counter-value n)
    (dom/button {<span class="symbol">:onClick</span> #(onClick id)} <span class="string"><span class="delimiter">&quot;</span><span class="content">Increment</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-counter</span> (comp/factory Counter {<span class="symbol">:keyfn</span> <span class="symbol">:counter/id</span>}))

<span class="comment">; the * suffix is just a notation to indicate an implementation of something..in this case the guts of a mutation</span>
(<span class="keyword">defn</span> <span class="function">increment-counter*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Increment a counter with ID counter-id in a Fulcro database.</span><span class="delimiter">&quot;</span></span>
  [database counter-id]
  (<span class="keyword">update-in</span> database [<span class="symbol">:counter/by-id</span> counter-id <span class="symbol">:counter/n</span>] <span class="keyword">inc</span>))

(defmutation increment-counter [{<span class="symbol">:keys</span> [id] <span class="symbol">:as</span> params}]
  <span class="comment">; The local thing to do</span>
  (action [{<span class="symbol">:keys</span> [state] <span class="symbol">:as</span> env}]
    (<span class="keyword">swap!</span> state increment-counter* id))
  <span class="comment">; The remote thing to do. True means &quot;the same (abstract) thing&quot;. False (or omitting it) means &quot;nothing&quot;</span>
  (remote [env] <span class="predefined-constant">true</span>))

(defsc CounterPanel [this {<span class="symbol">:keys</span> [counters]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:counters</span> []})
   <span class="symbol">:query</span>         [{<span class="symbol">:counters</span> (comp/get-query Counter)}]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:panels/by-kw</span> <span class="symbol">:counter</span>])}
  (<span class="keyword">let</span> [click-callback (<span class="keyword">fn</span> [id] (comp/transact! this
                                  `[(increment-counter {<span class="symbol">:id</span> ~id}) <span class="symbol">:counter/by-id</span>]))]
    (dom/div
      <span class="comment">; embedded style: kind of silly in a real app, but doable</span>
      (dom/style <span class="string"><span class="delimiter">&quot;</span><span class="content">.counter { width: 400px; padding-bottom: 20px; }
                  button { margin-left: 10px; }</span><span class="delimiter">&quot;</span></span>)
      <span class="comment">; computed lets us pass calculated data to our component's 3rd argument. It has to be</span>
      <span class="comment">; combined into a single argument or the factory would not be React-compatible (not would it be able to handle</span>
      <span class="comment">; children).</span>
      (<span class="keyword">map</span> #(ui-counter (comp/computed % {<span class="symbol">:onClick</span> click-callback})) counters))))

(<span class="keyword">def</span> <span class="function">ui-counter-panel</span> (comp/factory CounterPanel))

(<span class="keyword">defonce</span> <span class="function">timer-id</span> (<span class="keyword">atom</span> <span class="integer">0</span>))
(<span class="keyword">declare</span> <span class="function">sample-of-counter-app-with-merge-component-fulcro-app</span>)

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; The code of interest...</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
(<span class="keyword">defn</span> <span class="function">add-counter</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">NOTE: A function callable from anywhere as long as you have a reconciler...</span><span class="delimiter">&quot;</span></span>
  [app counter]
  (merge/merge-component! app Counter counter
    <span class="symbol">:append</span> [<span class="symbol">:panels/by-kw</span> <span class="symbol">:counter</span> <span class="symbol">:counters</span>]))

(defsc Root [this {<span class="symbol">:keys</span> [panel]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:panel</span> (comp/get-query CounterPanel)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:panel</span> {}}}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:border</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1px solid black</span><span class="delimiter">&quot;</span></span>}}
    <span class="comment">; NOTE: A plain function...pretend this is happening outside of the UI...we're doing it here so we can embed it in the book...</span>
    (dom/button {<span class="symbol">:onClick</span> #(add-counter (comp/any-&gt;app this) {<span class="symbol">:counter/id</span> <span class="integer">4</span> <span class="symbol">:counter/n</span> <span class="integer">22</span>})} <span class="string"><span class="delimiter">&quot;</span><span class="content">Simulate Data Import</span><span class="delimiter">&quot;</span></span>)
    (dom/hr)
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters:</span><span class="delimiter">&quot;</span></span>
    (ui-counter-panel panel)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 20. <a id="LoadingDataBasics"></a><a href="#LoadingDataBasics">Loading Data Basics</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('loading-data-basics')">Focus Inspector</button>
<div class="short narrow example" id="loading-data-basics"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.loading-data-basics</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]))

(defsc Person [this {<span class="symbol">:person/keys</span> [id <span class="keyword">name</span> age] <span class="symbol">:server/keys</span> [time-ms] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span> [<span class="symbol">:person/id</span> <span class="symbol">:person/name</span> <span class="symbol">:person/age</span> <span class="symbol">:server/time-ms</span>]
   <span class="symbol">:ident</span> <span class="symbol">:person/id</span>}
  (dom/li
    (<span class="keyword">str</span> <span class="keyword">name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content"> (last queried at </span><span class="delimiter">&quot;</span></span> time-ms <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> []
                            <span class="comment">; Load relative to an ident (of this component).</span>
                            <span class="comment">; This will refresh the entity in the db. The helper function</span>
                            <span class="comment">; (df/refresh! this) is identical to this, but shorter to write.</span>
                            (df/load! this (comp/get-ident this) Person))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Update</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-person</span> (comp/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc People [this {<span class="symbol">:list/keys</span> [people]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:list/id</span> <span class="symbol">:param/id</span> <span class="symbol">:list/people</span> []}
   <span class="symbol">:query</span>         [<span class="symbol">:list/id</span> {<span class="symbol">:list/people</span> (comp/get-query Person)}]
   <span class="symbol">:ident</span>         <span class="symbol">:list/id</span>}
  (dom/ul
    (<span class="keyword">map</span> ui-person people)))

(<span class="keyword">def</span> <span class="function">ui-people</span> (comp/factory People {<span class="symbol">:keyfn</span> <span class="symbol">:people/kind</span>}))

(defsc Root [this {<span class="symbol">:root/keys</span> [<span class="keyword">list</span>]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {<span class="symbol">:root/list</span> (comp/get-initial-state People {<span class="symbol">:id</span> <span class="symbol">:people</span>})})
   <span class="symbol">:query</span>         [{<span class="symbol">:root/list</span> (comp/get-query People)}]}
  (dom/div
    (dom/button
      {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> []
                  (df/load! this <span class="symbol">:all-people</span> Person {<span class="symbol">:target</span> [<span class="symbol">:list/id</span> <span class="symbol">:people</span> <span class="symbol">:list/people</span>]}))}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Load People</span><span class="delimiter">&quot;</span></span>)
    (dom/h4 <span class="string"><span class="delimiter">&quot;</span><span class="content">People in Database</span><span class="delimiter">&quot;</span></span>)
    (ui-people <span class="keyword">list</span>)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 21. <a id="Parallelvs.SequentialLoading"></a><a href="#Parallelvs.SequentialLoading">Parallel vs. Sequential Loading</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('parallel-vs-sequential-loading')">Focus Inspector</button>
<div class="short narrow example" id="parallel-vs-sequential-loading"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.parallel-vs-sequential-loading</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    [taoensso.timbre <span class="symbol">:as</span> log]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(pc/defresolver long-query-resolver [_ _]
  {<span class="symbol">::pc/output</span> [<span class="symbol">:background/long-query</span>]}
  {<span class="symbol">:background/long-query</span> <span class="integer">42</span>})

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
(defsc Child [this {<span class="symbol">:keys</span> [id <span class="keyword">name</span> background/long-query] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span> (<span class="keyword">fn</span> [] [<span class="symbol">:id</span> <span class="symbol">:name</span> <span class="symbol">:background/long-query</span> [df/marker-table '_]])
   <span class="symbol">:ident</span> [<span class="symbol">:background.child/by-id</span> <span class="symbol">:id</span>]}
  (<span class="keyword">let</span> [status (<span class="keyword">get-in</span> props [df/marker-table [<span class="symbol">:fetching</span> id]])]
    (dom/div {<span class="symbol">:style</span> {<span class="symbol">:display</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">inline</span><span class="delimiter">&quot;</span></span> <span class="symbol">:float</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span> <span class="symbol">:width</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">200px</span><span class="delimiter">&quot;</span></span>}}
      (dom/button {<span class="symbol">:onClick</span> #(df/load-field! this <span class="symbol">:background/long-query</span> {<span class="symbol">:parallel</span> <span class="predefined-constant">true</span>
                                                                          <span class="symbol">:marker</span>   [<span class="symbol">:fetching</span> id]})} <span class="string"><span class="delimiter">&quot;</span><span class="content">Load stuff parallel</span><span class="delimiter">&quot;</span></span>)
      (dom/button {<span class="symbol">:onClick</span> #(df/load-field! this <span class="symbol">:background/long-query</span> {<span class="symbol">:marker</span> [<span class="symbol">:fetching</span> id]})} <span class="string"><span class="delimiter">&quot;</span><span class="content">Load stuff sequential</span><span class="delimiter">&quot;</span></span>)
      (dom/div
        <span class="keyword">name</span>
        (<span class="keyword">if</span> (df/loading? status)
          (dom/span <span class="string"><span class="delimiter">&quot;</span><span class="content">Loading...</span><span class="delimiter">&quot;</span></span>)
          (dom/span long-query))))))

(<span class="keyword">def</span> <span class="function">ui-child</span> (comp/factory Child {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [children] <span class="symbol">:as</span> props}]
  <span class="comment">; cheating a little...raw props used for child, instead of embedding them there.</span>
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:children</span> [{<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>} {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>} {<span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span>}]})
   <span class="symbol">:query</span>         [{<span class="symbol">:children</span> (comp/get-query Child)}]}
  (dom/div
    (mapv ui-child children)
    (dom/br {<span class="symbol">:style</span> {<span class="symbol">:clear</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">both</span><span class="delimiter">&quot;</span></span>}}) (dom/br)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 22. <a id="MorphingExample"></a><a href="#MorphingExample">Morphing Example</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('morphing-example')">Focus Inspector</button>
<div class="short narrow example" id="morphing-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.server.morphing-example</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [book.macros <span class="symbol">:refer</span> [defexample]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.algorithms.normalize <span class="symbol">:as</span> fnorm]
    [com.fulcrologic.fulcro.algorithms.merge <span class="symbol">:as</span> <span class="keyword">merge</span>]))

(defsc CategoryQuery [this props]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:category/name</span>]
   <span class="symbol">:ident</span> [<span class="symbol">:categories/by-id</span> <span class="symbol">:db/id</span>]})

(defsc ItemQuery [this props]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:item/name</span> {<span class="symbol">:item/category</span> (comp/get-query CategoryQuery)}]
   <span class="symbol">:ident</span> [<span class="symbol">:items/by-id</span> <span class="symbol">:db/id</span>]})

(<span class="keyword">def</span> <span class="function">sample-server-response</span>
  {<span class="symbol">:all-items</span> [{<span class="symbol">:db/id</span> <span class="integer">5</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-42</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}}
               {<span class="symbol">:db/id</span> <span class="integer">6</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-92</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}}
               {<span class="symbol">:db/id</span> <span class="integer">7</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-32</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}}
               {<span class="symbol">:db/id</span> <span class="integer">8</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-52</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">2</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>}}]})

(<span class="keyword">def</span> <span class="function">component-query</span> [{<span class="symbol">:all-items</span> (comp/get-query ItemQuery)}])

(<span class="keyword">def</span> <span class="function">hand-written-query</span> [{<span class="symbol">:all-items</span> [<span class="symbol">:db/id</span> <span class="symbol">:item/name</span>
                                      {<span class="symbol">:item/category</span> [<span class="symbol">:db/id</span> <span class="symbol">:category/name</span>]}]}])

(defsc ToolbarItem [this {<span class="symbol">:keys</span> [item/name]}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:item/name</span>]
   <span class="symbol">:ident</span> [<span class="symbol">:items/by-id</span> <span class="symbol">:db/id</span>]}
  (dom/li <span class="keyword">name</span>))

(<span class="keyword">def</span> <span class="function">ui-toolbar-item</span> (comp/factory ToolbarItem {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc ToolbarCategory [this {<span class="symbol">:keys</span> [category/name category/items]}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:category/name</span> {<span class="symbol">:category/items</span> (comp/get-query ToolbarItem)}]
   <span class="symbol">:ident</span> [<span class="symbol">:categories/by-id</span> <span class="symbol">:db/id</span>]}
  (dom/li
    <span class="keyword">name</span>
    (dom/ul
      (<span class="keyword">map</span> ui-toolbar-item items))))

(<span class="keyword">def</span> <span class="function">ui-toolbar-category</span> (comp/factory ToolbarCategory {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defmutation group-items-reset [params]
  (action [{<span class="symbol">:keys</span> [app state]}]
    (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                   (<span class="keyword">-&gt;</span> s
                     (<span class="keyword">dissoc</span> <span class="symbol">:categories/by-id</span> <span class="symbol">:toolbar/categories</span>)
                     (merge/merge* component-query sample-server-response))))))

(<span class="keyword">defn</span> <span class="function">add-to-category</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a new db with the given item added into that item's category.</span><span class="delimiter">&quot;</span></span>
  [db item]
  (<span class="keyword">let</span> [category-ident (<span class="symbol">:item/category</span> item)
        item-location  (<span class="keyword">conj</span> category-ident <span class="symbol">:category/items</span>)]
    (<span class="keyword">update-in</span> db item-location (fnil <span class="keyword">conj</span> []) (comp/ident ItemQuery item))))

(<span class="keyword">defn</span> <span class="function">group-items*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a new db with all of the items sorted by name and grouped into their categories.</span><span class="delimiter">&quot;</span></span>
  [db]
  (<span class="keyword">let</span> [sorted-items   (<span class="keyword">-&gt;&gt;</span> db <span class="symbol">:items/by-id</span> <span class="keyword">vals</span> (<span class="keyword">sort-by</span> <span class="symbol">:item/name</span>))
        category-ids   (<span class="keyword">-&gt;</span> db (<span class="symbol">:categories/by-id</span>) <span class="keyword">keys</span>)
        clear-items    (<span class="keyword">fn</span> [db id] (<span class="keyword">assoc-in</span> db [<span class="symbol">:categories/by-id</span> id <span class="symbol">:category/items</span>] []))
        db             (<span class="keyword">reduce</span> clear-items db category-ids)
        db             (<span class="keyword">reduce</span> add-to-category db sorted-items)
        all-categories (<span class="keyword">-&gt;&gt;</span> db <span class="symbol">:categories/by-id</span> <span class="keyword">vals</span> (mapv #(comp/ident CategoryQuery %)))]
    (<span class="keyword">assoc</span> db <span class="symbol">:toolbar/categories</span> all-categories)))

(defmutation ^<span class="symbol">:intern</span> group-items [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state group-items*)))

(defsc Toolbar [this {<span class="symbol">:keys</span> [toolbar/categories]}]
  {<span class="symbol">:query</span> [{<span class="symbol">:toolbar/categories</span> (comp/get-query ToolbarCategory)}]}
  (dom/div
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(group-items {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Trigger Post Mutation</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(group-items-reset {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Reset</span><span class="delimiter">&quot;</span></span>)
    (dom/ul
      (<span class="keyword">map</span> ui-toolbar-category categories))))

(defexample <span class="string"><span class="delimiter">&quot;</span><span class="content">Morphing Data</span><span class="delimiter">&quot;</span></span> Toolbar <span class="string"><span class="delimiter">&quot;</span><span class="content">morphing-example</span><span class="delimiter">&quot;</span></span> <span class="symbol">:initial-db</span> (fnorm/tree-&gt;db component-query sample-server-response <span class="predefined-constant">true</span>))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 23. <a id="Premerge-usingpostmutations"></a><a href="#Premerge-usingpostmutations">Pre merge - using post mutations</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('pre-merge-postmutations')">Focus Inspector</button>
<div class="short narrow example" id="pre-merge-postmutations"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.post-mutation-countdown</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">all-counters</span>
  [{<span class="symbol">::counter-id</span> <span class="integer">1</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}])

(pc/defresolver counter-resolver [env {<span class="symbol">::keys</span> [counter-id]}]
  {<span class="symbol">::pc/input</span>  #{<span class="symbol">::counter-id</span>}
   <span class="symbol">::pc/output</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span>]}
  (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [id]} (<span class="keyword">-&gt;</span> env <span class="symbol">:ast</span> <span class="symbol">:params</span>)]
    (<span class="keyword">first</span> (<span class="keyword">filter</span> #(<span class="keyword">=</span> id (<span class="symbol">::counter-id</span> %)) all-counters))))

(<span class="keyword">def</span> <span class="function">resolvers</span> [counter-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(m/defmutation initialize-counter [{<span class="symbol">::keys</span> [counter-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">update-in</span> [<span class="symbol">::counter-id</span> counter-id] #(<span class="keyword">merge</span> {<span class="symbol">:ui/count</span> <span class="integer">5</span>} %))))

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label]
                        <span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">:ui/count</span>]}
  (dom/div
    (dom/h4 counter-label)
    (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
      (dom/button {<span class="symbol">:disabled</span> done?
                   <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
        (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>))))))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [counter]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {})
   <span class="symbol">:query</span>         [{<span class="symbol">:counter</span> (comp/get-query Countdown)}]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">if</span> (<span class="keyword">seq</span> counter)
      (ui-countdown counter)
      (dom/button {<span class="symbol">:onClick</span> #(df/load! this [<span class="symbol">::counter-id</span> <span class="integer">1</span>] Countdown
                               {<span class="symbol">:target</span>               [<span class="symbol">:counter</span>]
                                <span class="symbol">:post-mutation</span>        `initialize-counter
                                <span class="symbol">:post-mutation-params</span> {<span class="symbol">::counter-id</span> <span class="integer">1</span>}})}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Load one counter</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">defn</span> <span class="function">initialize</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">To be used in :started-callback to pre-load things.</span><span class="delimiter">&quot;</span></span>
  [app])</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 24. <a id="Premerge-usingpostmutationstomany"></a><a href="#Premerge-usingpostmutationstomany">Pre merge - using post mutations to many</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('pre-merge-postmutations-many')">Focus Inspector</button>
<div class="short narrow example" id="pre-merge-postmutations-many"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.post-mutation-countdown-many</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">all-counters</span>
  [{<span class="symbol">::counter-id</span> <span class="integer">1</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">2</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">3</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">4</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>}])

(pc/defresolver counter-resolver [env _]
  {<span class="symbol">::pc/output</span> [{<span class="symbol">::all-counters</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span>]}]}
  {<span class="symbol">::all-counters</span> all-counters})

(<span class="keyword">def</span> <span class="function">resolvers</span> [counter-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(m/defmutation initialize-counters [_]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state
      (<span class="keyword">fn</span> [state]
        (<span class="keyword">reduce</span>
          (<span class="keyword">fn</span> [state <span class="keyword">ref</span>]
            (<span class="keyword">update-in</span> state <span class="keyword">ref</span> #(<span class="keyword">merge</span> {<span class="symbol">:ui/count</span> <span class="integer">5</span>} %)))
          state
          (<span class="keyword">get</span> state <span class="symbol">::all-counters</span>))))))

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label]
                        <span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">:ui/count</span>]}
  (dom/div
    (dom/h4 counter-label)
    (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
      (dom/button {<span class="symbol">:disabled</span> done?
                   <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
        (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>))))))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Root [this {<span class="symbol">::keys</span> [all-counters]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {})
   <span class="symbol">:query</span>         [{<span class="symbol">::all-counters</span> (comp/get-query Countdown)}]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">if</span> (<span class="keyword">seq</span> all-counters)
      (dom/div {<span class="symbol">:style</span> {<span class="symbol">:display</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">flex</span><span class="delimiter">&quot;</span></span> <span class="symbol">:alignItems</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">center</span><span class="delimiter">&quot;</span></span> <span class="symbol">:justifyContent</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">space-between</span><span class="delimiter">&quot;</span></span>}}
        (mapv ui-countdown all-counters))
      (dom/button {<span class="symbol">:onClick</span> #(df/load! this <span class="symbol">::all-counters</span> Countdown
                               {<span class="symbol">:post-mutation</span> `initialize-counters})}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Load many counters</span><span class="delimiter">&quot;</span></span>))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 25. <a id="Premerge"></a><a href="#Premerge">Pre merge</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('countdown-single')">Focus Inspector</button>
<div class="short narrow example" id="countdown-single"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.countdown</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">all-counters</span>
  [{<span class="symbol">::counter-id</span> <span class="integer">1</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}])

(pc/defresolver counter-resolver [env {<span class="symbol">::keys</span> [counter-id]}]
  {<span class="symbol">::pc/input</span>  #{<span class="symbol">::counter-id</span>}
   <span class="symbol">::pc/output</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span>]}
  (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [id]} (<span class="keyword">-&gt;</span> env <span class="symbol">:ast</span> <span class="symbol">:params</span>)]
    (<span class="keyword">first</span> (<span class="keyword">filter</span> #(<span class="keyword">=</span> id (<span class="symbol">::counter-id</span> %)) all-counters))))

(<span class="keyword">def</span> <span class="function">resolvers</span> [counter-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label]
                        <span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">:ui/count</span>]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">merge</span>
                  {<span class="symbol">:ui/count</span> <span class="integer">5</span>}
                  current-normalized
                  data-tree))}
  (dom/div
    (dom/h4 counter-label)
    (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
      (dom/button {<span class="symbol">:disabled</span> done?
                   <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
        (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>))))))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [counter]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {})
   <span class="symbol">:query</span>         [{<span class="symbol">:counter</span> (comp/get-query Countdown)}]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">if</span> (<span class="keyword">seq</span> counter)
      (ui-countdown counter)
      (dom/button {<span class="symbol">:onClick</span> #(df/load! this [<span class="symbol">::counter-id</span> <span class="integer">1</span>] Countdown {<span class="symbol">:target</span> [<span class="symbol">:counter</span>]})}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Load one counter</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">defn</span> <span class="function">initialize</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">To be used in :started-callback to pre-load things.</span><span class="delimiter">&quot;</span></span>
  [app])</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 26. <a id="Premerge-tomany"></a><a href="#Premerge-tomany">Pre merge - to many</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('countdown-many')">Focus Inspector</button>
<div class="short narrow example" id="countdown-many"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.countdown-many</span>
  (<span class="symbol">:require</span>
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">all-counters</span>
  [{<span class="symbol">::counter-id</span> <span class="integer">1</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">2</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">3</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">4</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>}])

(pc/defresolver counter-resolver [env _]
  {<span class="symbol">::pc/output</span> [{<span class="symbol">::all-counters</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span>]}]}
  {<span class="symbol">::all-counters</span> all-counters})

(<span class="keyword">def</span> <span class="function">resolvers</span> [counter-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label]
                        <span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">:ui/count</span>]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">merge</span>
                  {<span class="symbol">:ui/count</span> <span class="integer">5</span>}
                  current-normalized
                  data-tree))}
  (dom/div
    (dom/h4 counter-label)
    (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
      (dom/button {<span class="symbol">:disabled</span> done?
                   <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
        (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>))))))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Root [this {<span class="symbol">::keys</span> [all-counters]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {})
   <span class="symbol">:query</span>         [{<span class="symbol">::all-counters</span> (comp/get-query Countdown)}]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">if</span> (<span class="keyword">seq</span> all-counters)
      (dom/div {<span class="symbol">:style</span> {<span class="symbol">:display</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">flex</span><span class="delimiter">&quot;</span></span> <span class="symbol">:alignItems</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">center</span><span class="delimiter">&quot;</span></span> <span class="symbol">:justifyContent</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">space-between</span><span class="delimiter">&quot;</span></span>}}
        (mapv ui-countdown all-counters))
      (dom/button {<span class="symbol">:onClick</span> #(df/load! this <span class="symbol">::all-counters</span> Countdown)}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Load many counters</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">defn</span> <span class="function">initialize</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">To be used in :started-callback to pre-load things.</span><span class="delimiter">&quot;</span></span>
  [app])</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 27. <a id="Premerge-withinitial"></a><a href="#Premerge-withinitial">Pre merge - with initial</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('countdown-with-initial')">Focus Inspector</button>
<div class="short narrow example" id="countdown-with-initial"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.countdown-with-initial</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    [com.fulcrologic.fulcro.algorithms.merge <span class="symbol">:as</span> <span class="keyword">merge</span>]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">all-counters</span>
  [{<span class="symbol">::counter-id</span> <span class="integer">1</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">2</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span> <span class="symbol">::counter-initial</span> <span class="integer">10</span>}
   {<span class="symbol">::counter-id</span> <span class="integer">3</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span> <span class="symbol">::counter-initial</span> <span class="integer">2</span>}
   {<span class="symbol">::counter-id</span> <span class="integer">4</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>}])

(pc/defresolver counter-resolver [env _]
  {<span class="symbol">::pc/output</span> [{<span class="symbol">::all-counters</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">::counter-initial</span>]}]}
  {<span class="symbol">::all-counters</span> all-counters})

(<span class="keyword">def</span> <span class="function">resolvers</span> [counter-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">default-count</span> <span class="integer">5</span>)

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label counter-initial]
                        <span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">::counter-initial</span> <span class="symbol">:ui/count</span>]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">merge</span>
                  <span class="comment">; </span><b class="conum">(1)</b>
                  {<span class="symbol">:ui/count</span> (<span class="keyword">or</span> (merge/nilify-not-found (<span class="symbol">::counter-initial</span> data-tree)) default-count)}
                  current-normalized
                  data-tree))}
  (dom/div
    (dom/h4 (<span class="keyword">str</span> counter-label <span class="string"><span class="delimiter">&quot;</span><span class="content"> [</span><span class="delimiter">&quot;</span></span> (<span class="keyword">or</span> counter-initial default-count) <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>))
    (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
      (dom/button {<span class="symbol">:disabled</span> done?
                   <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
        (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>))))))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Root [this {<span class="symbol">::keys</span> [all-counters]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {})
   <span class="symbol">:query</span>         [{<span class="symbol">::all-counters</span> (comp/get-query Countdown)}]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">if</span> (<span class="keyword">seq</span> all-counters)
      (dom/div {<span class="symbol">:style</span> {<span class="symbol">:display</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">flex</span><span class="delimiter">&quot;</span></span> <span class="symbol">:alignItems</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">center</span><span class="delimiter">&quot;</span></span> <span class="symbol">:justifyContent</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">space-between</span><span class="delimiter">&quot;</span></span>}}
        (mapv ui-countdown all-counters))
      (dom/button {<span class="symbol">:onClick</span> #(df/load! this <span class="symbol">::all-counters</span> Countdown)}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Load many counters</span><span class="delimiter">&quot;</span></span>))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 28. <a id="Premerge-extractedui"></a><a href="#Premerge-extractedui">Pre merge - extracted ui</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('countdown-extracted')">Focus Inspector</button>
<div class="short narrow example" id="countdown-extracted"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.countdown-extracted</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.algorithms.merge <span class="symbol">:as</span> <span class="keyword">merge</span>]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">all-counters</span>
  [{<span class="symbol">::counter-id</span> <span class="integer">1</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">2</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span> <span class="symbol">::counter-initial</span> <span class="integer">10</span>}
   {<span class="symbol">::counter-id</span> <span class="integer">3</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span> <span class="symbol">::counter-initial</span> <span class="integer">2</span>}
   {<span class="symbol">::counter-id</span> <span class="integer">4</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>}])

(pc/defresolver counter-resolver [env _]
  {<span class="symbol">::pc/output</span> [{<span class="symbol">::all-counters</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span>]}]}
  {<span class="symbol">::all-counters</span> all-counters})

(<span class="keyword">def</span> <span class="function">resolvers</span> [counter-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">default-count</span> <span class="integer">5</span>)

(defsc CountdownButton [this {<span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">:ui/id</span> <span class="symbol">:ui/id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">:ui/id</span> <span class="symbol">:ui/count</span>]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">merge</span>
                  <span class="comment">; </span><b class="conum">(1)</b>
                  {<span class="symbol">:ui/id</span>    (random-uuid)
                   <span class="symbol">:ui/count</span> default-count}
                  current-normalized
                  data-tree))}
  (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
    (dom/button {<span class="symbol">:disabled</span> done?
                 <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
      (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>)))))

(<span class="keyword">def</span> <span class="function">ui-countdown-button</span> (comp/factory CountdownButton {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label counter-initial]
                        <span class="symbol">:ui/keys</span> [counter]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">::counter-initial</span>
               {<span class="symbol">:ui/counter</span> (comp/get-query CountdownButton)}]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">let</span> [initial (merge/nilify-not-found (<span class="symbol">::counter-initial</span> data-tree))]
                  (<span class="keyword">merge</span>
                    <span class="comment">; </span><b class="conum">(2)</b>
                    {<span class="symbol">:ui/counter</span> (cond-&gt; {} initial (<span class="keyword">assoc</span> <span class="symbol">:ui/count</span> initial))}
                    current-normalized
                    data-tree)))}
  (dom/div
    (dom/h4 (<span class="keyword">str</span> counter-label <span class="string"><span class="delimiter">&quot;</span><span class="content"> [</span><span class="delimiter">&quot;</span></span> (<span class="keyword">or</span> counter-initial default-count) <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>))
    (ui-countdown-button counter)))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Root [this {<span class="symbol">::keys</span> [all-counters]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {})
   <span class="symbol">:query</span>         [{<span class="symbol">::all-counters</span> (comp/get-query Countdown)}]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">if</span> (<span class="keyword">seq</span> all-counters)
      (dom/div {<span class="symbol">:style</span> {<span class="symbol">:display</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">flex</span><span class="delimiter">&quot;</span></span> <span class="symbol">:alignItems</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">center</span><span class="delimiter">&quot;</span></span> <span class="symbol">:justifyContent</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">space-between</span><span class="delimiter">&quot;</span></span>}}
        (mapv ui-countdown all-counters))
      (dom/button {<span class="symbol">:onClick</span> #(df/load! this <span class="symbol">::all-counters</span> Countdown)}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Load many counters</span><span class="delimiter">&quot;</span></span>))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 29. <a id="Premerge-initial"></a><a href="#Premerge-initial">Pre merge - initial</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('countdown-initial-state')">Focus Inspector</button>
<div class="short narrow example" id="countdown-initial-state"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.countdown-initial-state</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    [com.fulcrologic.fulcro.algorithms.merge <span class="symbol">:as</span> <span class="keyword">merge</span>]
    [com.fulcrologic.fulcro.algorithms.tempid <span class="symbol">:as</span> tempid]
    [taoensso.timbre <span class="symbol">:as</span> log]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">all-counters</span>
  [{<span class="symbol">::counter-id</span> <span class="integer">1</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}
   {<span class="symbol">::counter-id</span> <span class="integer">2</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span> <span class="symbol">::counter-initial</span> <span class="integer">10</span>}
   {<span class="symbol">::counter-id</span> <span class="integer">3</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span> <span class="symbol">::counter-initial</span> <span class="integer">2</span>}
   {<span class="symbol">::counter-id</span> <span class="integer">4</span> <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>}])

(pc/defresolver counter-resolver [env _]
  {<span class="symbol">::pc/output</span> [{<span class="symbol">::all-counters</span> [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span>]}]}
  {<span class="symbol">::all-counters</span> all-counters})

(<span class="keyword">def</span> <span class="function">resolvers</span> [counter-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">default-count</span> <span class="integer">5</span>)

(defsc CountdownButton [this {<span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">:ui/id</span> <span class="symbol">:ui/id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">:ui/id</span> <span class="symbol">:ui/count</span>]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">merge</span>
                  {<span class="symbol">:ui/id</span>    (random-uuid)
                   <span class="symbol">:ui/count</span> default-count}
                  current-normalized
                  data-tree))}
  (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
    (dom/button {<span class="symbol">:disabled</span> done?
                 <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
      (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>)))))

(<span class="keyword">def</span> <span class="function">ui-countdown-button</span> (comp/factory CountdownButton {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label counter-initial]
                        <span class="symbol">:ui/keys</span> [counter]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">::counter-initial</span>
               {<span class="symbol">:ui/counter</span> (comp/get-query CountdownButton)}]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">let</span> [initial (merge/nilify-not-found (<span class="symbol">::counter-initial</span> data-tree))]
                  (log/spy <span class="symbol">:info</span> (<span class="keyword">merge</span>
                                   {<span class="symbol">:ui/counter</span> (cond-&gt; {} initial (<span class="keyword">assoc</span> <span class="symbol">:ui/count</span> initial))}
                                   current-normalized
                                   data-tree))))}
  (dom/div
    (dom/h4 (<span class="keyword">str</span> counter-label <span class="string"><span class="delimiter">&quot;</span><span class="content"> [</span><span class="delimiter">&quot;</span></span> (<span class="keyword">or</span> counter-initial default-count) <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>))
    (ui-countdown-button counter)))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Root [this {<span class="symbol">::keys</span> [all-counters]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {<span class="symbol">::all-counters</span>
                           [{<span class="symbol">::counter-id</span>    (tempid/tempid)
                             <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">X</span><span class="delimiter">&quot;</span></span>}
                            {<span class="symbol">::counter-id</span>    (tempid/tempid)
                             <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Y</span><span class="delimiter">&quot;</span></span>}
                            {<span class="symbol">::counter-id</span>      (tempid/tempid)
                             <span class="symbol">::counter-label</span>   <span class="string"><span class="delimiter">&quot;</span><span class="content">Z</span><span class="delimiter">&quot;</span></span>
                             <span class="symbol">::counter-initial</span> <span class="integer">9</span>}]})
   <span class="symbol">:query</span>         [{<span class="symbol">::all-counters</span> (comp/get-query Countdown)}]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">when</span> (<span class="keyword">seq</span> all-counters)
      (dom/div {<span class="symbol">:style</span> {<span class="symbol">:display</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">flex</span><span class="delimiter">&quot;</span></span> <span class="symbol">:alignItems</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">center</span><span class="delimiter">&quot;</span></span> <span class="symbol">:justifyContent</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">space-between</span><span class="delimiter">&quot;</span></span>}}
        (mapv ui-countdown all-counters)))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 30. <a id="Premerge-mutation"></a><a href="#Premerge-mutation">Pre merge - mutation</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('countdown-mutation')">Focus Inspector</button>
<div class="short narrow example" id="countdown-mutation"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.pre-merge.countdown-mutation</span>
  (<span class="symbol">:require</span>
    [book.demos.util <span class="symbol">:refer</span> [now]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.algorithms.merge <span class="symbol">:as</span> <span class="keyword">merge</span>]
    [com.fulcrologic.fulcro.algorithms.tempid <span class="symbol">:as</span> tempid]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">default-count</span> <span class="integer">5</span>)

(defsc CountdownButton [this {<span class="symbol">:ui/keys</span> [<span class="keyword">count</span>]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">:ui/id</span> <span class="symbol">:ui/id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">:ui/id</span> <span class="symbol">:ui/count</span>]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree]}]
                (<span class="keyword">merge</span>
                  {<span class="symbol">:ui/id</span>    (random-uuid)
                   <span class="symbol">:ui/count</span> default-count}
                  current-normalized
                  data-tree))}
  (<span class="keyword">let</span> [done? (<span class="keyword">zero?</span> <span class="keyword">count</span>)]
    (dom/button {<span class="symbol">:disabled</span> done?
                 <span class="symbol">:onClick</span>  #(m/set-value! this <span class="symbol">:ui/count</span> (<span class="keyword">dec</span> <span class="keyword">count</span>))}
      (<span class="keyword">if</span> done? <span class="string"><span class="delimiter">&quot;</span><span class="content">Done!</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> <span class="keyword">count</span>)))))

(<span class="keyword">def</span> <span class="function">ui-countdown-button</span> (comp/factory CountdownButton {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(defsc Countdown [this {<span class="symbol">::keys</span>   [counter-label counter-initial]
                        <span class="symbol">:ui/keys</span> [counter]}]
  {<span class="symbol">:ident</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-id</span>]
   <span class="symbol">:query</span>     [<span class="symbol">::counter-id</span> <span class="symbol">::counter-label</span> <span class="symbol">::counter-initial</span>
               {<span class="symbol">:ui/counter</span> (comp/get-query CountdownButton)}]
   <span class="symbol">:pre-merge</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [current-normalized data-tree] <span class="symbol">:as</span> x}]
                (<span class="keyword">let</span> [initial (merge/nilify-not-found (<span class="symbol">::counter-initial</span> data-tree))]
                  (<span class="keyword">merge</span>
                    {<span class="symbol">:ui/counter</span> (cond-&gt; {} initial (<span class="keyword">assoc</span> <span class="symbol">:ui/count</span> initial))}
                    current-normalized
                    data-tree)))}
  (dom/div
    (dom/h4 (<span class="keyword">str</span> counter-label <span class="string"><span class="delimiter">&quot;</span><span class="content"> [</span><span class="delimiter">&quot;</span></span> (<span class="keyword">or</span> counter-initial default-count) <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>))
    (ui-countdown-button counter)))

(<span class="keyword">def</span> <span class="function">ui-countdown</span> (comp/factory Countdown {<span class="symbol">:keyfn</span> <span class="symbol">::counter-id</span>}))

(m/defmutation create-countdown [countdown]
  (action [{<span class="symbol">:keys</span> [state <span class="keyword">ref</span>]}]
    (<span class="keyword">swap!</span> state merge/merge-component Countdown countdown <span class="symbol">:append</span> [<span class="symbol">::all-counters</span>])
    (<span class="keyword">swap!</span> state <span class="keyword">update-in</span> <span class="keyword">ref</span> <span class="keyword">assoc</span> <span class="symbol">:ui/new-countdown-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)))

(defsc Root [this {<span class="symbol">::keys</span> [all-counters]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [_] {<span class="symbol">::all-counters</span>
                           [{<span class="symbol">::counter-id</span>    (tempid/tempid)
                             <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">X</span><span class="delimiter">&quot;</span></span>}
                            {<span class="symbol">::counter-id</span>    (tempid/tempid)
                             <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Y</span><span class="delimiter">&quot;</span></span>}
                            {<span class="symbol">::counter-id</span>      (tempid/tempid)
                             <span class="symbol">::counter-label</span>   <span class="string"><span class="delimiter">&quot;</span><span class="content">Z</span><span class="delimiter">&quot;</span></span>
                             <span class="symbol">::counter-initial</span> <span class="integer">9</span>}]})
   <span class="symbol">:query</span>         [{<span class="symbol">::all-counters</span> (comp/get-query Countdown)}
                   <span class="symbol">:ui/new-countdown-label</span>]}
  (dom/div
    (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Counters</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this [`(create-countdown ~{<span class="symbol">::counter-id</span>    (tempid/tempid)
                                                                      <span class="symbol">::counter-label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New</span><span class="delimiter">&quot;</span></span>})])}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Add counter</span><span class="delimiter">&quot;</span></span>)
    (dom/div {<span class="symbol">:style</span> {<span class="symbol">:display</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">flex</span><span class="delimiter">&quot;</span></span> <span class="symbol">:alignItems</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">center</span><span class="delimiter">&quot;</span></span> <span class="symbol">:justifyContent</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">space-between</span><span class="delimiter">&quot;</span></span>}}
      (mapv ui-countdown all-counters))))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>`</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. <a id="NetworkActivity"></a><a href="#NetworkActivity">Network Activity</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('network-activity')">Focus Inspector</button>
<div class="short narrow example" id="network-activity"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.server.network-activity</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.application <span class="symbol">:as</span> app]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    [taoensso.timbre <span class="symbol">:as</span> log]
    [clojure.pprint <span class="symbol">:refer</span> [pprint]]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]))

<span class="comment">;; Simulated server</span>

(pc/defresolver silly-resolver [_ _]
  {<span class="symbol">::pc/output</span> [<span class="symbol">::data</span>]}
  {<span class="symbol">::data</span> <span class="integer">42</span>})

<span class="comment">;; Client</span>

(defsc ActivityIndicator [this props]
  {<span class="symbol">:query</span>         [[<span class="symbol">::app/active-remotes</span> '_]]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::activity</span>])
   <span class="symbol">:initial-state</span> {}}
  (<span class="keyword">let</span> [active-remotes (<span class="symbol">::app/active-remotes</span> props)]
    (dom/div
      (dom/h3 <span class="string"><span class="delimiter">&quot;</span><span class="content">Active Remotes</span><span class="delimiter">&quot;</span></span>)
      (dom/pre (<span class="keyword">pr-str</span> active-remotes)))))

(<span class="keyword">def</span> <span class="function">ui-activity-indicator</span> (comp/factory ActivityIndicator {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [indicator]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:indicator</span> (comp/get-query ActivityIndicator)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:indicator</span> {}}}
  (dom/div {}
    (dom/p {} <span class="string"><span class="delimiter">&quot;</span><span class="content">Use the server controls to slow down the network, so you can see the activity</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(df/load! this <span class="symbol">::data</span> <span class="predefined-constant">nil</span>)} <span class="string"><span class="delimiter">&quot;</span><span class="content">Trigger a Load</span><span class="delimiter">&quot;</span></span>)
    (ui-activity-indicator indicator)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 32. <a id="UIBlocking"></a><a href="#UIBlocking">UI Blocking</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('ui-blocking-example')">Focus Inspector</button>
<div class="short narrow example" id="ui-blocking-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.server.ui-blocking-example</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    [taoensso.timbre <span class="symbol">:as</span> log]))

<span class="comment">;; SERVER</span>

(pc/defmutation submit-form-mutation [env params]
  {<span class="symbol">::pc/sym</span> `submit-form}
  (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Server got </span><span class="delimiter">&quot;</span></span> params)
  (<span class="keyword">if</span> (<span class="keyword">&gt;</span> <span class="float">0.5</span> (<span class="keyword">rand</span>))
    {<span class="symbol">:message</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Everything went swell!</span><span class="delimiter">&quot;</span></span>
     <span class="symbol">:ok?</span>     <span class="predefined-constant">true</span>}
    {<span class="symbol">:message</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Service temporarily unavailable!</span><span class="delimiter">&quot;</span></span>
     <span class="symbol">:ok?</span>     <span class="predefined-constant">false</span>}))

<span class="comment">;; CLIENT</span>

(defsc BlockingOverlay [this {<span class="symbol">:keys</span> [ui/active? ui/message]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/active?</span> <span class="symbol">:ui/message</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:ui/active?</span> <span class="predefined-constant">false</span> <span class="symbol">:ui/message</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Please wait...</span><span class="delimiter">&quot;</span></span>}}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:position</span>        <span class="symbol">:absolute</span>
                    <span class="symbol">:display</span>         (<span class="keyword">if</span> active? <span class="string"><span class="delimiter">&quot;</span><span class="content">block</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span>)
                    <span class="symbol">:zIndex</span>          <span class="integer">65000</span>
                    <span class="symbol">:width</span>           <span class="string"><span class="delimiter">&quot;</span><span class="content">400px</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:height</span>          <span class="string"><span class="delimiter">&quot;</span><span class="content">100px</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">rgba(0,0,0,0.5)</span><span class="delimiter">&quot;</span></span>}}
    (dom/div {<span class="symbol">:style</span> {<span class="symbol">:position</span>  <span class="symbol">:relative</span>
                      <span class="symbol">:top</span>       <span class="string"><span class="delimiter">&quot;</span><span class="content">40px</span><span class="delimiter">&quot;</span></span>
                      <span class="symbol">:color</span>     <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>
                      <span class="symbol">:textAlign</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">center</span><span class="delimiter">&quot;</span></span>}} message)))

(<span class="keyword">def</span> <span class="function">ui-overlay</span> (comp/factory BlockingOverlay))

(<span class="keyword">defn</span> <span class="function">set-overlay-visible*</span> [state tf] (<span class="keyword">assoc-in</span> state [<span class="symbol">:overlay</span> <span class="symbol">:ui/active?</span>] tf))
(<span class="keyword">defn</span> <span class="function">set-overlay-message*</span> [state message] (<span class="keyword">assoc-in</span> state [<span class="symbol">:overlay</span> <span class="symbol">:ui/message</span>] message))

(defmutation submit-form [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                   (<span class="keyword">-&gt;</span> s
                     (set-overlay-message* <span class="string"><span class="delimiter">&quot;</span><span class="content">Working...</span><span class="delimiter">&quot;</span></span>)
                     (set-overlay-visible* <span class="predefined-constant">true</span>)))))
  (result-action [{<span class="symbol">:keys</span> [app state result]}]
    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Result:</span><span class="delimiter">&quot;</span></span> result)
    (<span class="keyword">let</span> [mutation-result (<span class="keyword">-&gt;</span> result <span class="symbol">:body</span> (<span class="keyword">get</span> `submit-form))
          {<span class="symbol">:keys</span> [message ok?]} mutation-result]
      (<span class="keyword">if</span> ok?
        (<span class="keyword">swap!</span> state set-overlay-visible* <span class="predefined-constant">false</span>)
        (<span class="keyword">do</span>
          (<span class="keyword">swap!</span> state set-overlay-message* (<span class="keyword">str</span> message <span class="string"><span class="delimiter">&quot;</span><span class="content">   Retrying submission in 1s.</span><span class="delimiter">&quot;</span></span>))
          <span class="comment">;; could use setTimeout or immediately do it</span>
          (js/setTimeout
            #(comp/transact! app [(submit-form params)])
            <span class="integer">1000</span>)))))
  (remote [_] <span class="predefined-constant">true</span>))

(defsc Root [this {<span class="symbol">:keys</span> [ui/name overlay]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/name</span> {<span class="symbol">:overlay</span> (comp/get-query BlockingOverlay)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:overlay</span> {} <span class="symbol">:ui/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Alicia</span><span class="delimiter">&quot;</span></span>}}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:width</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">400px</span><span class="delimiter">&quot;</span></span> <span class="symbol">:height</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">100px</span><span class="delimiter">&quot;</span></span>}}
    (ui-overlay overlay)
    (dom/p <span class="string"><span class="delimiter">&quot;</span><span class="content">Name: </span><span class="delimiter">&quot;</span></span> (dom/input {<span class="symbol">:value</span> <span class="keyword">name</span>}))
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this [(submit-form {<span class="symbol">:made-up-data</span> <span class="integer">42</span>})])}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Submit</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 33. <a id="ErrorHandling"></a><a href="#ErrorHandling">Error Handling</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('server-error-handling')">Focus Inspector</button>
<div class="short narrow example" id="server-error-handling"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.server-error-handling</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [taoensso.timbre <span class="symbol">:as</span> log]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    [com.wsscode.pathom.core <span class="symbol">:as</span> p]
    [com.fulcrologic.fulcro.application <span class="symbol">:as</span> app]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(pc/defmutation server-error-mutation [env params]
  {<span class="symbol">::pc/sym</span> `error-mutation}
  <span class="comment">;; Throw a mutation error for the client to handle</span>
  (<span class="keyword">throw</span> (ex-info <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation error</span><span class="delimiter">&quot;</span></span> {})))

(pc/defresolver child-resolver [env input]
  {<span class="symbol">::pc/output</span> [<span class="symbol">:fulcro/read-error</span>]}
  (<span class="keyword">throw</span> (ex-info <span class="string"><span class="delimiter">&quot;</span><span class="content">read error</span><span class="delimiter">&quot;</span></span> {})))

(<span class="keyword">def</span> <span class="function">resolvers</span> [server-error-mutation child-resolver])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="comment">;; Mutation used as a fallback for load error: In this case the `env` from the load result *is* the params to this mutation</span>
(defmutation read-error [params]
  (action [env]
    (js/alert <span class="string"><span class="delimiter">&quot;</span><span class="content">There was a read error</span><span class="delimiter">&quot;</span></span>)
    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Result from server:</span><span class="delimiter">&quot;</span></span> (<span class="symbol">:result</span> params))
    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Original load params:</span><span class="delimiter">&quot;</span></span> (<span class="symbol">:load-params</span> params))))

<span class="comment">;; an :error key is injected into the fallback mutation's params argument</span>
(defmutation error-mutation [params]
  (ok-action [env] (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Optimistic action ran ok</span><span class="delimiter">&quot;</span></span>))
  <span class="comment">;; Error action is only called if `:remote-error?` for the application is defined to consider the response an error.</span>
  (error-action [{<span class="symbol">:keys</span> [app <span class="keyword">ref</span> result]}]
    (js/alert <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation error</span><span class="delimiter">&quot;</span></span>)
    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Result </span><span class="delimiter">&quot;</span></span> result))
  (remote [env] <span class="predefined-constant">true</span>))

(defsc Child [this props]
  {<span class="symbol">:initial-state</span> {}
   <span class="symbol">:query</span>         ['<span class="keyword">*</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:error.child/by-id</span> <span class="symbol">:singleton</span>])}
  (dom/div
    <span class="comment">;; declare a tx/fallback in the same transact call as the mutation</span>
    <span class="comment">;; if the mutation fails, the fallback will be called</span>
    (dom/button {<span class="symbol">:onClick</span> #(df/load! this <span class="symbol">:fulcro/read-error</span> <span class="predefined-constant">nil</span> {<span class="symbol">:fallback</span> `read-error})}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Failing read with a fallback</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(error-mutation {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Failing mutation</span><span class="delimiter">&quot;</span></span>)
    ))

(<span class="keyword">def</span> <span class="function">ui-child</span> (comp/factory Child))

(defsc Root [this {<span class="symbol">:keys</span> [child]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:child</span> (comp/get-initial-state Child {})})
   <span class="symbol">:query</span>         [{<span class="symbol">:child</span> (comp/get-query Child)}]}
  (dom/div (ui-child child)))

(<span class="keyword">defn</span> <span class="function">contains-error?</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Check to see if the response contains Pathom error indicators.</span><span class="delimiter">&quot;</span></span>
  [body]
  (<span class="keyword">when</span> (<span class="keyword">map?</span> body)
    (<span class="keyword">let</span> [values (<span class="keyword">vals</span> body)]
      (<span class="keyword">reduce</span>
        (<span class="keyword">fn</span> [error? v]
          (<span class="keyword">if</span> (<span class="keyword">or</span>
                (<span class="keyword">and</span> (<span class="keyword">map?</span> v) (<span class="keyword">contains?</span> (<span class="keyword">set</span> (<span class="keyword">keys</span> v)) <span class="symbol">::p/reader-error</span>))
                (<span class="keyword">=</span> v <span class="symbol">::p/reader-error</span>))
            (reduced <span class="predefined-constant">true</span>)
            error?))
        <span class="predefined-constant">false</span>
        values))))

(<span class="keyword">def</span> <span class="function">SPA</span> (app/fulcro-app {<span class="symbol">:remote-error?</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [body] <span class="symbol">:as</span> result}]
                                           (<span class="keyword">or</span>
                                             (app/default-remote-error? result)
                                             (contains-error? body)))}))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 34. <a id="DynamicRouter"></a><a href="#DynamicRouter">Dynamic Router Example</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('dynamic-router-example')">Focus Inspector</button>
<div class="short narrow example" id="dynamic-router-example"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.dynamic-router-example</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.routing.dynamic-routing <span class="symbol">:as</span> dr <span class="symbol">:refer</span> [defrouter]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [taoensso.timbre <span class="symbol">:as</span> log]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]))

(defsc Settings [this props]
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::settings</span>])
   <span class="symbol">:query</span>         [<span class="symbol">:settings</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:settings</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stuff</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:route-segment</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">settings</span><span class="delimiter">&quot;</span></span>]
   <span class="symbol">:will-enter</span>    (<span class="keyword">fn</span> [app route-params]
                    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Will enter settings with route params </span><span class="delimiter">&quot;</span></span> route-params)
                    (dr/route-immediate [<span class="symbol">:component/id</span> <span class="symbol">::settings</span>]))
   <span class="symbol">:will-leave</span>    (<span class="keyword">fn</span> [this props]
                    (js/console.log (comp/get-ident this) <span class="string"><span class="delimiter">&quot;</span><span class="content">props</span><span class="delimiter">&quot;</span></span> props)
                    <span class="predefined-constant">true</span>)}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Settings</span><span class="delimiter">&quot;</span></span>))

(defsc Person [this {<span class="symbol">:ui/keys</span>      [modified?]
                     <span class="symbol">:person/keys</span>  [id <span class="keyword">name</span>]
                     <span class="symbol">:address/keys</span> [city state]
                     <span class="symbol">:as</span>           props}]
  {<span class="symbol">:query</span>           [<span class="symbol">:ui/modified?</span> <span class="symbol">:person/id</span> <span class="symbol">:person/name</span> <span class="symbol">:address/city</span> <span class="symbol">:address/state</span>]
   <span class="symbol">:ident</span>           <span class="symbol">:person/id</span>
   <span class="symbol">:route-segment</span>   [<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/id</span>]
   <span class="symbol">:route-cancelled</span> (<span class="keyword">fn</span> [{<span class="symbol">:person/keys</span> [id]}]
                      (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Routing cancelled to user </span><span class="delimiter">&quot;</span></span> id))
   <span class="symbol">:will-leave</span>      (<span class="keyword">fn</span> [this {<span class="symbol">:ui/keys</span> [modified?]}]
                      (<span class="keyword">when</span> modified?
                        (js/alert <span class="string"><span class="delimiter">&quot;</span><span class="content">You cannot navigate until the user is not modified!</span><span class="delimiter">&quot;</span></span>))
                      (<span class="keyword">not</span> modified?))
   <span class="symbol">:will-enter</span>      (<span class="keyword">fn</span> [app {<span class="symbol">:person/keys</span> [id] <span class="symbol">:as</span> route-params}]
                      (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Will enter user with route params </span><span class="delimiter">&quot;</span></span> route-params)
                      <span class="comment">;; be sure to convert strings to int for this case</span>
                      (<span class="keyword">let</span> [id (<span class="keyword">if</span> (<span class="keyword">string?</span> id) (js/parseInt id) id)]
                        (dr/route-deferred [<span class="symbol">:person/id</span> id]
                          #(df/load app [<span class="symbol">:person/id</span> id] Person
                             {<span class="symbol">:post-mutation</span> `dr/target-ready
                              <span class="symbol">:post-mutation-params</span>
                                             {<span class="symbol">:target</span> [<span class="symbol">:person/id</span> id]}}))))}
  (dom/div
    (dom/h3 (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Person </span><span class="delimiter">&quot;</span></span> id))
    (dom/div (<span class="keyword">str</span> <span class="keyword">name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content"> from </span><span class="delimiter">&quot;</span></span> city <span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span> state))
    (dom/div
      (dom/input {<span class="symbol">:type</span>     <span class="string"><span class="delimiter">&quot;</span><span class="content">checkbox</span><span class="delimiter">&quot;</span></span>
                  <span class="symbol">:onChange</span> (<span class="keyword">fn</span> []
                              (m/toggle! this <span class="symbol">:ui/modified?</span>))
                  <span class="symbol">:checked</span>  (<span class="keyword">boolean</span> modified?)})
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Modified (prevent routing)</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-person</span> (comp/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:person/id</span>}))

(defsc Main [this props]
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::main</span>])
   <span class="symbol">:query</span>         [<span class="symbol">:main</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:main</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stuff</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:route-segment</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>]
   <span class="symbol">:will-enter</span>    (<span class="keyword">fn</span> [app route-params]
                    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Will enter main</span><span class="delimiter">&quot;</span></span> route-params)
                    (dr/route-immediate [<span class="symbol">:component/id</span> <span class="symbol">::main</span>]))
   <span class="symbol">:will-leave</span>    (<span class="keyword">fn</span> [this props]
                    (log/info (comp/get-ident this) <span class="string"><span class="delimiter">&quot;</span><span class="content">props</span><span class="delimiter">&quot;</span></span> props)
                    <span class="predefined-constant">true</span>)}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Main</span><span class="delimiter">&quot;</span></span>))

(defrouter TopRouter [this {<span class="symbol">:keys</span> [current-state pending-path-segment]}]
  {<span class="symbol">:router-targets</span> [Main Settings Person]}
  (<span class="keyword">case</span> current-state
    <span class="symbol">:pending</span> (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Loading...</span><span class="delimiter">&quot;</span></span>)
    <span class="symbol">:failed</span> (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Loading seems to have failed. Try another route.</span><span class="delimiter">&quot;</span></span>)
    (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Unknown route</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-top-router</span> (comp/factory TopRouter))

(defsc Root [this {<span class="symbol">:root/keys</span> [router]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:root/router</span> (comp/get-query TopRouter)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:root/router</span> {}}}
  (dom/div
    (dom/button {<span class="symbol">:onClick</span> #(dr/change-route this [<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Go to main</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(dr/change-route this [<span class="string"><span class="delimiter">&quot;</span><span class="content">settings</span><span class="delimiter">&quot;</span></span>])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Go to settings</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(dr/change-route this [<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Go to person 1</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(dr/change-route this [<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Go to person 2</span><span class="delimiter">&quot;</span></span>)
    (ui-top-router router)))

(<span class="keyword">defn</span> <span class="function">client-did-mount</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Must be used as :client-did-mount parameter of app creation, or called just after you mount the app.</span><span class="delimiter">&quot;</span></span>
  [app]
  (dr/change-route app [<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>]))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 35. <a id="DynamicQuery"></a><a href="#DynamicQuery">Dynamic Query</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('dynamic-queries')">Focus Inspector</button>
<div class="short narrow example" id="dynamic-queries"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.dynamic-queries</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [goog.object]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]))

(<span class="keyword">declare</span> <span class="function">ui-leaf</span>)

<span class="comment">; This component allows you to toggle the query between [:x] and [:y]</span>
(defsc Leaf [this {<span class="symbol">:keys</span> [x y]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:x</span> <span class="integer">1</span> <span class="symbol">:y</span> <span class="integer">42</span>})
   <span class="symbol">:query</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:x</span>])                              <span class="comment">; avoid error checking so we can destructure both :x and :y in props</span>
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:LEAF</span> <span class="symbol">:ID</span>])}                      <span class="comment">; there is only one leaf in app state</span>
  (dom/div
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (comp/set-query! this ui-leaf {<span class="symbol">:query</span> [<span class="symbol">:x</span>]}))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Set query to :x</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (comp/set-query! this ui-leaf {<span class="symbol">:query</span> [<span class="symbol">:y</span>]}))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Set query to :y</span><span class="delimiter">&quot;</span></span>)
    <span class="comment">; If the query is [:x] then x will be defined, otherwise it will not.</span>
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [e] (<span class="keyword">if</span> x
                                    (m/set-value! this <span class="symbol">:x</span> (<span class="keyword">inc</span> x))
                                    (m/set-value! this <span class="symbol">:y</span> (<span class="keyword">inc</span> y))))}
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Count: </span><span class="delimiter">&quot;</span></span> (<span class="keyword">or</span> x y)))                             <span class="comment">; only one will be defined at a time</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content"> Leaf</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">def</span> <span class="function">ui-leaf</span> (comp/factory Leaf {<span class="symbol">:qualifier</span> <span class="symbol">:x</span>}))

(defsc Root [this {<span class="symbol">:keys</span> [root/leaf] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:root/leaf</span> (comp/get-initial-state Leaf {})})
   <span class="symbol">:query</span>         (<span class="keyword">fn</span> [] [{<span class="symbol">:root/leaf</span> (comp/get-query ui-leaf)}])}
  (dom/div (ui-leaf leaf)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 36. <a id="DynamicQueryParameters"></a><a href="#DynamicQueryParameters">Dynamic Query Parameters</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('dynamic-query-parameters')">Focus Inspector</button>
<div class="short narrow example" id="dynamic-query-parameters"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.dynamic-query-parameters</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [goog.object]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]))

<span class="comment">; This component has a query parameter that can be set to whatever we want dynamically</span>
(defsc Leaf [this {<span class="symbol">:keys</span> [x y] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:x</span> <span class="integer">1</span> <span class="symbol">:y</span> <span class="integer">99</span>})
   <span class="symbol">:query</span>         (<span class="keyword">fn</span> [] '[<span class="symbol">:x</span> ?additional-stuff])           <span class="comment">; the parameter ?additional-stuff starts out empty</span>
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:LEAF</span> <span class="symbol">:ID</span>])}
  (dom/div
    (dom/button  {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (comp/set-query! this Leaf {<span class="symbol">:params</span> {<span class="symbol">:additional-stuff</span> <span class="symbol">:y</span>}}))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Add :y to query</span><span class="delimiter">&quot;</span></span>)
    (dom/button  {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (comp/set-query! this Leaf {<span class="symbol">:params</span> {}}))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Drop :y from query</span><span class="delimiter">&quot;</span></span>)
    (dom/ul
      (dom/li  <span class="string"><span class="delimiter">&quot;</span><span class="content">x: </span><span class="delimiter">&quot;</span></span> x)
      (dom/li  <span class="string"><span class="delimiter">&quot;</span><span class="content">y: </span><span class="delimiter">&quot;</span></span> y))))

(<span class="keyword">def</span> <span class="function">ui-leaf</span> (comp/factory Leaf))

(defsc Root [this {<span class="symbol">:keys</span> [root/leaf] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:root/leaf</span> (comp/get-initial-state Leaf {})})
   <span class="symbol">:query</span>         (<span class="keyword">fn</span> [] [{<span class="symbol">:root/leaf</span> (comp/get-query ui-leaf)}])}
  (dom/div  (ui-leaf leaf)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 37. <a id="SimpleRouter"></a><a href="#SimpleRouter">Simple Router</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('simple-router-1')">Focus Inspector</button>
<div class="short narrow example" id="simple-router-1"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.simple-router-1</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.routing.legacy-ui-routers <span class="symbol">:as</span> r <span class="symbol">:refer-macros</span> [defsc-router]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]))

(defsc Index [this {<span class="symbol">:keys</span> [db/id router/page]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:router/page</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])                         <span class="comment">; IMPORTANT! Look up both things, don't use the shorthand for idents on screens!</span>
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:router/page</span> <span class="symbol">:PAGE/index</span>}}
  (dom/div <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Index Page</span><span class="delimiter">&quot;</span></span>))

(defsc Settings [this {<span class="symbol">:keys</span> [db/id router/page]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:router/page</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:router/page</span> <span class="symbol">:PAGE/settings</span>}}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Settings Page</span><span class="delimiter">&quot;</span></span>))

(defsc-router RootRouter [this {<span class="symbol">:keys</span> [router/page db/id]}]
  {<span class="symbol">:router-id</span>      <span class="symbol">:root/router</span>
   <span class="symbol">:default-route</span>  Index
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:router-targets</span> {<span class="symbol">:PAGE/index</span>    Index
                    <span class="symbol">:PAGE/settings</span> Settings}}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad route</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">def</span> <span class="function">ui-root-router</span> (comp/factory RootRouter))

(defsc Root [this {<span class="symbol">:keys</span> [router]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:router</span> (comp/get-initial-state RootRouter {})})
   <span class="symbol">:query</span>         [{<span class="symbol">:router</span> (comp/get-query RootRouter)}]}
  (dom/div
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this
                        `[(r/set-route {<span class="symbol">:router</span> <span class="symbol">:root/router</span>
                                        <span class="symbol">:target</span> [<span class="symbol">:PAGE/index</span> <span class="integer">1</span>]})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Index</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this
                        `[(r/set-route {<span class="symbol">:router</span> <span class="symbol">:root/router</span>
                                        <span class="symbol">:target</span> [<span class="symbol">:PAGE/settings</span> <span class="integer">1</span>]})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Settings</span><span class="delimiter">&quot;</span></span>)
    (ui-root-router router)))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Be sure to look at the database view in the example above.
Notice that all that has to happen is a change of a single ident.
This as the effect of switching the rendering, and choosing the subquery for the remainder of the visible UI.</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. <a id="NestedRouter"></a><a href="#NestedRouter">Nested Router</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('simple-router-2')">Focus Inspector</button>
<div class="short narrow example" id="simple-router-2"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.simple-router-2</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.routing.legacy-ui-routers <span class="symbol">:as</span> r <span class="symbol">:refer-macros</span> [defsc-router]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]))

(defsc Index [this {<span class="symbol">:keys</span> [router/page db/id]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:router/page</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:router/page</span> <span class="symbol">:PAGE/index</span>}}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Index Page</span><span class="delimiter">&quot;</span></span>))

(defsc EmailSettings [this {<span class="symbol">:keys</span> [db/id router/page]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:router/page</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:router/page</span> <span class="symbol">:PAGE/email</span>}}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Email Settings Page</span><span class="delimiter">&quot;</span></span>))

(defsc ColorSettings [this {<span class="symbol">:keys</span> [db/id router/page]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:router/page</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:router/page</span> <span class="symbol">:PAGE/color</span>}}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Color Settings</span><span class="delimiter">&quot;</span></span>))

(defsc-router SettingsRouter [this {<span class="symbol">:keys</span> [router/page db/id]}]
  {<span class="symbol">:router-id</span>      <span class="symbol">:settings/router</span>
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:router-targets</span> {<span class="symbol">:PAGE/email</span> EmailSettings
                    <span class="symbol">:PAGE/color</span> ColorSettings}
   <span class="symbol">:default-route</span>  EmailSettings}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad route</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">def</span> <span class="function">ui-settings-router</span> (comp/factory SettingsRouter))

(defsc Settings [this {<span class="symbol">:keys</span> [router/page db/id subpage]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:router/page</span> {<span class="symbol">:subpage</span> (comp/get-query SettingsRouter)}]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p]
                    {<span class="symbol">:db/id</span>       <span class="integer">1</span>
                     <span class="symbol">:router/page</span> <span class="symbol">:PAGE/settings</span>
                     <span class="symbol">:subpage</span>     (comp/get-initial-state SettingsRouter {})})}
  (dom/div
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this
                        `[(r/set-route {<span class="symbol">:router</span> <span class="symbol">:settings/router</span>
                                        <span class="symbol">:target</span> [<span class="symbol">:PAGE/email</span> <span class="integer">1</span>]})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Email</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this
                        `[(r/set-route {<span class="symbol">:router</span> <span class="symbol">:settings/router</span>
                                        <span class="symbol">:target</span> [<span class="symbol">:PAGE/color</span> <span class="integer">1</span>]})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Colors</span><span class="delimiter">&quot;</span></span>)
    (js/console.log <span class="symbol">:p</span> (comp/props this))
    (ui-settings-router subpage)))

(defsc-router RootRouter [this {<span class="symbol">:keys</span> [router/page db/id]}]
  {<span class="symbol">:router-id</span>      <span class="symbol">:root/router</span>
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:default-route</span>  Index
   <span class="symbol">:router-targets</span> {<span class="symbol">:PAGE/index</span>    Index
                    <span class="symbol">:PAGE/settings</span> Settings}}
  (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad route</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">def</span> <span class="function">ui-root-router</span> (comp/factory RootRouter))

(defsc Root [this {<span class="symbol">:keys</span> [router]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:router</span> (comp/get-initial-state RootRouter {})})
   <span class="symbol">:query</span>         [{<span class="symbol">:router</span> (comp/get-query RootRouter)}]}
  (dom/div
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this
                        `[(r/set-route {<span class="symbol">:router</span> <span class="symbol">:root/router</span>
                                        <span class="symbol">:target</span> [<span class="symbol">:PAGE/index</span> <span class="integer">1</span>]})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Index</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this
                        `[(r/set-route {<span class="symbol">:router</span> <span class="symbol">:root/router</span>
                                        <span class="symbol">:target</span> [<span class="symbol">:PAGE/settings</span> <span class="integer">1</span>]})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Settings</span><span class="delimiter">&quot;</span></span>)
    (ui-root-router router)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 39. <a id="RoutingDemo"></a><a href="#RoutingDemo">Routing Demo</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('ui-routing')">Focus Inspector</button>
<div class="short narrow example" id="ui-routing"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui-routing</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.routing.legacy-ui-routers <span class="symbol">:as</span> r <span class="symbol">:refer-macros</span> [defsc-router]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]))

(defsc Main [this {<span class="symbol">:keys</span> [label] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:page</span> <span class="symbol">:main</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">MAIN</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [(<span class="symbol">:page</span> props) <span class="symbol">:top</span>])
   <span class="symbol">:query</span>         [<span class="symbol">:page</span> <span class="symbol">:label</span>]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>}}
    label))

(defsc Login [this {<span class="symbol">:keys</span> [label] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:page</span> <span class="symbol">:login</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">LOGIN</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [(<span class="symbol">:page</span> props) <span class="symbol">:top</span>])
   <span class="symbol">:query</span>         [<span class="symbol">:page</span> <span class="symbol">:label</span>]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>}}
    label))

(defsc NewUser [this {<span class="symbol">:keys</span> [label] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:page</span> <span class="symbol">:new-user</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New User</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [(<span class="symbol">:page</span> props) <span class="symbol">:top</span>])
   <span class="symbol">:query</span>         [<span class="symbol">:page</span> <span class="symbol">:label</span>]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">skyblue</span><span class="delimiter">&quot;</span></span>}}
    label))

(defsc StatusReport [this {<span class="symbol">:keys</span> [id page]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:id</span> <span class="symbol">:a</span> <span class="symbol">:page</span> <span class="symbol">:status-report</span>}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:query</span>         [<span class="symbol">:id</span> <span class="symbol">:page</span> <span class="symbol">:label</span>]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>}}
    (dom/div (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Status </span><span class="delimiter">&quot;</span></span> id))))

(defsc GraphingReport [this {<span class="symbol">:keys</span> [id page]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:id</span> <span class="symbol">:a</span> <span class="symbol">:page</span> <span class="symbol">:graphing-report</span>}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page id])
   <span class="symbol">:query</span>         [<span class="symbol">:id</span> <span class="symbol">:page</span> <span class="symbol">:label</span>]}                       <span class="comment">; make sure you query for everything need by the router's ident function!</span>
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">orange</span><span class="delimiter">&quot;</span></span>}}
    (dom/div (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Graph </span><span class="delimiter">&quot;</span></span> id))))

(defsc-router ReportRouter [this props]
  {<span class="symbol">:router-id</span>      <span class="symbol">:report-router</span>
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [(<span class="symbol">:page</span> props) (<span class="symbol">:id</span> props)])
   <span class="symbol">:default-route</span>  StatusReport
   <span class="symbol">:router-targets</span> {<span class="symbol">:status-report</span>   StatusReport
                    <span class="symbol">:graphing-report</span> GraphingReport}})

(<span class="keyword">def</span> <span class="function">ui-report-router</span> (comp/factory ReportRouter))

<span class="comment">; BIG GOTCHA: Make sure you query for the prop (in this case :page) that the union needs in order to decide. It won't pull it itself!</span>
(defsc ReportsMain [this {<span class="symbol">:keys</span> [page report-router]}]
  <span class="comment">; nest the router under any arbitrary key, just be consistent in your query and props extraction.</span>
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:page</span> <span class="symbol">:report</span> <span class="symbol">:report-router</span> (comp/get-initial-state ReportRouter {})})
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [page <span class="symbol">:top</span>])
   <span class="symbol">:query</span>         [<span class="symbol">:page</span> {<span class="symbol">:report-router</span> (comp/get-query ReportRouter)}]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">grey</span><span class="delimiter">&quot;</span></span>}}
    <span class="comment">; Screen-specific content to be shown &quot;around&quot; or &quot;above&quot; the subscreen</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">REPORT MAIN SCREEN</span><span class="delimiter">&quot;</span></span>
    <span class="comment">; Render the sub-router. You can also def a factory for the router (e.g. ui-report-router)</span>
    (ui-report-router report-router)))

(defsc-router TopRouter [this props]
  {<span class="symbol">:router-id</span>      <span class="symbol">:top-router</span>
   <span class="symbol">:default-route</span>  Main
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [(<span class="symbol">:page</span> props) <span class="symbol">:top</span>])
   <span class="symbol">:router-targets</span> {<span class="symbol">:main</span>     Main
                    <span class="symbol">:login</span>    Login
                    <span class="symbol">:new-user</span> NewUser
                    <span class="symbol">:report</span>   ReportsMain}})

(<span class="keyword">def</span> <span class="function">ui-top</span> (comp/factory TopRouter))

(<span class="keyword">def</span> <span class="function">routing-tree</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">A map of route handling instructions. The top key is the handler name of the route which can be
  thought of as the terminal leaf in the UI graph of the screen that should be </span><span class="content">\&quot;</span><span class="content">foremost</span><span class="content">\&quot;</span><span class="content">.

  The value is a vector of routing-instructions to tell the UI routers which ident
  of the route that should be made visible.

  A value in this ident using the `param` namespace will be replaced with the incoming route parameter
  (without the namespace). E.g. the incoming route-param :report-id will replace :param/report-id</span><span class="delimiter">&quot;</span></span>
  (r/routing-tree
    (r/make-route <span class="symbol">:main</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:main</span> <span class="symbol">:top</span>])])
    (r/make-route <span class="symbol">:login</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:login</span> <span class="symbol">:top</span>])])
    (r/make-route <span class="symbol">:new-user</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:new-user</span> <span class="symbol">:top</span>])])
    (r/make-route <span class="symbol">:graph</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:report</span> <span class="symbol">:top</span>])
                          (r/router-instruction <span class="symbol">:report-router</span> [<span class="symbol">:graphing-report</span> <span class="symbol">:param/report-id</span>])])
    (r/make-route <span class="symbol">:status</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:report</span> <span class="symbol">:top</span>])
                           (r/router-instruction <span class="symbol">:report-router</span> [<span class="symbol">:status-report</span> <span class="symbol">:param/report-id</span>])])))

(defsc Root [this {<span class="symbol">:keys</span> [top-router]}]
  <span class="comment">; r/routing-tree-key implies the alias of com.fulcrologic.fulcro.routing.legacy-ui-routers as r.</span>
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] (<span class="keyword">merge</span> routing-tree
                                 {<span class="symbol">:top-router</span> (comp/get-initial-state TopRouter {})}))
   <span class="symbol">:query</span>         [r/routing-tree-key
                   {<span class="symbol">:top-router</span> (comp/get-query TopRouter)}]}
  (dom/div
    <span class="comment">; Sample nav mutations</span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:main</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Main</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:new-user</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">New User</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:login</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Login</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:status</span> <span class="symbol">:route-params</span> {<span class="symbol">:report-id</span> <span class="symbol">:a</span>}})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Status A</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:graph</span> <span class="symbol">:route-params</span> {<span class="symbol">:report-id</span> <span class="symbol">:a</span>}})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Graph A</span><span class="delimiter">&quot;</span></span>)
    (ui-top top-router)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 40. <a id="EditingExistingData"></a><a href="#EditingExistingData">Editing Existing Data</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('form-state-demo-1')">Focus Inspector</button>
<div class="short narrow example" id="form-state-demo-1"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.forms.form-state-demo-1</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.semantic-ui.modules.dropdown.ui-dropdown <span class="symbol">:as</span> dropdown]
    [book.elements <span class="symbol">:as</span> ele]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.algorithms.form-state <span class="symbol">:as</span> fs]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [cljs.spec.alpha <span class="symbol">:as</span> s]
    [taoensso.timbre <span class="symbol">:as</span> log]))

(<span class="keyword">declare</span> <span class="function">Root</span> PhoneForm)

(<span class="keyword">defn</span> <span class="function">field-attrs</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">A helper function for getting aspects of a particular field.</span><span class="delimiter">&quot;</span></span>
  [component field]
  (<span class="keyword">let</span> [form         (comp/props component)
        entity-ident (comp/get-ident component form)
        id           (<span class="keyword">str</span> (<span class="keyword">first</span> entity-ident) <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> (<span class="keyword">second</span> entity-ident))
        is-dirty?    (fs/dirty? form field)
        clean?       (<span class="keyword">not</span> is-dirty?)
        validity     (fs/get-spec-validity form field)
        is-invalid?  (<span class="keyword">=</span> <span class="symbol">:invalid</span> validity)
        value        (<span class="keyword">get</span> form field <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)]
    {<span class="symbol">:dirty?</span>   is-dirty?
     <span class="symbol">:ident</span>    entity-ident
     <span class="symbol">:id</span>       id
     <span class="symbol">:clean?</span>   clean?
     <span class="symbol">:validity</span> validity
     <span class="symbol">:invalid?</span> is-invalid?
     <span class="symbol">:value</span>    value}))

(s/def <span class="symbol">:phone/number</span> #(<span class="keyword">re-matches</span> <span class="regexp"><span class="delimiter">#&quot;</span><span class="content">\(</span><span class="content">?[0-9]{3}[-.)]? *[0-9]{3}-?[0-9]{4}</span><span class="delimiter">&quot;</span></span> %))

(defmutation abort-phone-edit [{<span class="symbol">:keys</span> [id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                   (<span class="keyword">-&gt;</span> s
                     <span class="comment">; stop editing</span>
                     (<span class="keyword">dissoc</span> <span class="symbol">:root/phone</span>)
                     <span class="comment">; revert to the pristine state</span>
                     (fs/pristine-&gt;entity* [<span class="symbol">:phone/id</span> id])))))
  (refresh [env] [<span class="symbol">:root/phone</span>]))

(defmutation submit-phone [{<span class="symbol">:keys</span> [id delta]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                   (<span class="keyword">-&gt;</span> s
                     <span class="comment">; stop editing</span>
                     (<span class="keyword">dissoc</span> <span class="symbol">:root/phone</span>)
                     <span class="comment">; update the pristine state</span>
                     (fs/entity-&gt;pristine* [<span class="symbol">:phone/id</span> id])))))
  (remote [env] <span class="predefined-constant">true</span>)
  (refresh [env] [<span class="symbol">:root/phone</span> [<span class="symbol">:phone/id</span> id]]))

(<span class="keyword">defn</span> <span class="function">input-with-label</span>
  [component field label validation-message input]
  (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [dirty? invalid?]} (field-attrs component field)]
    (comp/fragment
      (dom/div <span class="symbol">:.</span>field {<span class="symbol">:classes</span> [(<span class="keyword">when</span> invalid? <span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>) (<span class="keyword">when</span> dirty? <span class="string"><span class="delimiter">&quot;</span><span class="content">warning</span><span class="delimiter">&quot;</span></span>)]}
        (dom/label {<span class="symbol">:htmlFor</span> (<span class="keyword">str</span> field)} label)
        input)
      (<span class="keyword">when</span> invalid?
        (dom/div <span class="symbol">:.</span>ui.error.message {} validation-message))
      (<span class="keyword">when</span> dirty?
        (dom/div <span class="symbol">:.</span>ui.warning.message {} <span class="string"><span class="delimiter">&quot;</span><span class="content">(dirty)</span><span class="delimiter">&quot;</span></span>)))))

(defsc PhoneForm [this {<span class="symbol">:phone/keys</span> [id <span class="keyword">type</span> number] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>       [<span class="symbol">:phone/id</span> <span class="symbol">:phone/type</span> <span class="symbol">:phone/number</span> fs/form-config-join]
   <span class="symbol">:form-fields</span> #{<span class="symbol">:phone/number</span> <span class="symbol">:phone/type</span>}
   <span class="symbol">:ident</span>       <span class="symbol">:phone/id</span>}
  (<span class="keyword">let</span> [dirty?   (fs/dirty? props)
        invalid? (<span class="keyword">=</span> <span class="symbol">:invalid</span> (fs/get-spec-validity props))]
    (dom/div <span class="symbol">:.</span>ui.form {<span class="symbol">:classes</span> [(<span class="keyword">when</span> invalid? <span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>) (<span class="keyword">when</span> dirty? <span class="string"><span class="delimiter">&quot;</span><span class="content">warning</span><span class="delimiter">&quot;</span></span>)]}
      (input-with-label this <span class="symbol">:phone/number</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Phone:</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">10-digit phone number is required.</span><span class="delimiter">&quot;</span></span>
        (dom/input {<span class="symbol">:value</span>    (<span class="keyword">or</span> (<span class="keyword">str</span> number) <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
                    <span class="symbol">:onChange</span> #(m/set-string! this <span class="symbol">:phone/number</span> <span class="symbol">:event</span> %)}))
      (input-with-label this <span class="symbol">:phone/type</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Type:</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        (dropdown/ui-dropdown {<span class="symbol">:value</span>     (<span class="keyword">name</span> <span class="keyword">type</span>)
                               <span class="symbol">:selection</span> <span class="predefined-constant">true</span>
                               <span class="symbol">:options</span>   [{<span class="symbol">:text</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Home</span><span class="delimiter">&quot;</span></span> <span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">home</span><span class="delimiter">&quot;</span></span>}
                                           {<span class="symbol">:text</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Work</span><span class="delimiter">&quot;</span></span> <span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span>}]
                               <span class="symbol">:onChange</span>  (<span class="keyword">fn</span> [_ v]
                                            (<span class="keyword">when-let</span> [v (some-&gt; (<span class="keyword">.</span>-value v) <span class="keyword">keyword</span>)]
                                              (m/set-value! this <span class="symbol">:phone/type</span> v)))}))
      (dom/button <span class="symbol">:.</span>ui.button {<span class="symbol">:onClick</span> #(comp/transact! this [(abort-phone-edit {<span class="symbol">:id</span> id})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Cancel</span><span class="delimiter">&quot;</span></span>)
      (dom/button <span class="symbol">:.</span>ui.button {<span class="symbol">:disabled</span> (<span class="keyword">or</span> (<span class="keyword">not</span> (fs/checked? props)) (fs/invalid-spec? props))
                               <span class="symbol">:onClick</span>  #(comp/transact! this [(submit-phone {<span class="symbol">:id</span> id <span class="symbol">:delta</span> (fs/dirty-fields props <span class="predefined-constant">true</span>)})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Commit!</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">def</span> <span class="function">ui-phone-form</span> (comp/factory PhoneForm {<span class="symbol">:keyfn</span> <span class="symbol">:phone/id</span>}))

(defsc PhoneNumber [this {<span class="symbol">:phone/keys</span> [id <span class="keyword">type</span> number]} {<span class="symbol">:keys</span> [onSelect]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:phone/id</span> <span class="symbol">:phone/number</span> <span class="symbol">:phone/type</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:phone/id</span> <span class="symbol">:param/id</span> <span class="symbol">:phone/number</span> <span class="symbol">:param/number</span> <span class="symbol">:phone/type</span> <span class="symbol">:param/type</span>}
   <span class="symbol">:ident</span>         <span class="symbol">:phone/id</span>}
  (dom/li <span class="symbol">:.</span>ui.item
    (dom/a {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (onSelect id))}
      (<span class="keyword">str</span> number <span class="string"><span class="delimiter">&quot;</span><span class="content"> (</span><span class="delimiter">&quot;</span></span> (<span class="keyword">get</span> {<span class="symbol">:home</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Home</span><span class="delimiter">&quot;</span></span> <span class="symbol">:work</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Work</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Unknown</span><span class="delimiter">&quot;</span></span>} <span class="keyword">type</span>) <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">def</span> <span class="function">ui-phone-number</span> (comp/factory PhoneNumber {<span class="symbol">:keyfn</span> <span class="symbol">:phone/id</span>}))

(defsc PhoneBook [this {<span class="symbol">:phonebook/keys</span> [id phone-numbers]} {<span class="symbol">:keys</span> [onSelect]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:phonebook/id</span> {<span class="symbol">:phonebook/phone-numbers</span> (comp/get-query PhoneNumber)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:phonebook/id</span>            <span class="symbol">:main</span>
                   <span class="symbol">:phonebook/phone-numbers</span> [{<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:number</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">541-555-1212</span><span class="delimiter">&quot;</span></span> <span class="symbol">:type</span> <span class="symbol">:home</span>}
                                             {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:number</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">541-555-5533</span><span class="delimiter">&quot;</span></span> <span class="symbol">:type</span> <span class="symbol">:work</span>}]}
   <span class="symbol">:ident</span>         <span class="symbol">:phonebook/id</span>}
  (dom/div
    (dom/h4 <span class="string"><span class="delimiter">&quot;</span><span class="content">Phone Book (click a number to edit)</span><span class="delimiter">&quot;</span></span>)
    (dom/ul
      (<span class="keyword">map</span> (<span class="keyword">fn</span> [n] (ui-phone-number (comp/computed n {<span class="symbol">:onSelect</span> onSelect}))) phone-numbers))))

(<span class="keyword">def</span> <span class="function">ui-phone-book</span> (comp/factory PhoneBook {<span class="symbol">:keyfn</span> <span class="symbol">:phonebook/id</span>}))

(defmutation edit-phone-number [{<span class="symbol">:keys</span> [id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [phone-type (<span class="keyword">get-in</span> @state [<span class="symbol">:phone/id</span> id <span class="symbol">:phone/type</span>])]
      (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                     (<span class="keyword">-&gt;</span> s
                       <span class="comment">; make sure the form config is with the entity</span>
                       (fs/add-form-config* PhoneForm [<span class="symbol">:phone/id</span> id])
                       <span class="comment">; since we're editing an existing thing, we should start it out complete (validations apply)</span>
                       (fs/mark-complete* [<span class="symbol">:phone/id</span> id])
                       <span class="comment">; tell the root UI that we're editing a phone number by linking it in</span>
                       (<span class="keyword">assoc</span> <span class="symbol">:root/phone</span> [<span class="symbol">:phone/id</span> id])))))))

(defsc Root [this {<span class="symbol">:keys</span> [<span class="symbol">:root/phone</span> <span class="symbol">:root/phonebook</span>]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:root/phonebook</span> (comp/get-query PhoneBook)}
                   {<span class="symbol">:root/phone</span> (comp/get-query PhoneForm)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:root/phonebook</span> {}
                   <span class="symbol">:root/phone</span>     {}}}
  (ele/ui-iframe {<span class="symbol">:frameBorder</span> <span class="integer">0</span> <span class="symbol">:width</span> <span class="integer">500</span> <span class="symbol">:height</span> <span class="integer">400</span>}
    (dom/div
      (dom/link {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css</span><span class="delimiter">&quot;</span></span>})
      (<span class="keyword">if</span> (<span class="keyword">contains?</span> phone <span class="symbol">:phone/number</span>)
        (ui-phone-form phone)
        (ui-phone-book (comp/computed phonebook {<span class="symbol">:onSelect</span> (<span class="keyword">fn</span> [id] (comp/transact! this [(edit-phone-number {<span class="symbol">:id</span> id})]))}))))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 41. <a id="NetworkInteractionsandForms"></a><a href="#NetworkInteractionsandForms">Network Interactions and Forms</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('form-state-demo-2')">Focus Inspector</button>
<div class="tall wide example" id="form-state-demo-2"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.forms.form-state-demo-2</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.semantic-ui.modules.dropdown.ui-dropdown <span class="symbol">:as</span> dropdown]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.algorithms.form-state <span class="symbol">:as</span> fs]
    [com.fulcrologic.fulcro.algorithms.tempid <span class="symbol">:as</span> tempid]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [clojure.string <span class="symbol">:as</span> <span class="keyword">str</span>]
    [cljs.spec.alpha <span class="symbol">:as</span> s]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    [book.elements <span class="symbol">:as</span> ele]
    [taoensso.timbre <span class="symbol">:as</span> log]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; Server Code</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="comment">; a simple query for any person, that will return valid-looking data</span>
(pc/defresolver person-resolver [env {<span class="symbol">:person/keys</span> [id]}]
  {<span class="symbol">::pc/input</span>  #{<span class="symbol">:person/id</span>}
   <span class="symbol">::pc/output</span> [<span class="symbol">:person/name</span> <span class="symbol">:person/age</span> <span class="symbol">:person/phone-numbers</span>]}
  {<span class="symbol">:person/id</span>            id
   <span class="symbol">:person/name</span>          (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">User </span><span class="delimiter">&quot;</span></span> id)
   <span class="symbol">:person/age</span>           <span class="integer">56</span>
   <span class="symbol">:person/phone-numbers</span> [{<span class="symbol">:phone/id</span> <span class="integer">1</span> <span class="symbol">:phone/number</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">555-111-1212</span><span class="delimiter">&quot;</span></span> <span class="symbol">:phone/type</span> <span class="symbol">:work</span>}
                          {<span class="symbol">:phone/id</span> <span class="integer">2</span> <span class="symbol">:phone/number</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">555-333-4444</span><span class="delimiter">&quot;</span></span> <span class="symbol">:phone/type</span> <span class="symbol">:home</span>}]})

(<span class="keyword">defonce</span> <span class="function">id</span> (<span class="keyword">atom</span> <span class="integer">1000</span>))
(<span class="keyword">defn</span> <span class="function">next-id</span> [] (<span class="keyword">swap!</span> id <span class="keyword">inc</span>))

<span class="comment">; Server submission...just prints delta for demo, and remaps tempids (forms with tempids are always considered dirty)</span>
(pc/defmutation submit-person-mutation [env inputs]
  {<span class="symbol">::pc/sym</span> `submit-person}
  (<span class="keyword">let</span> [params (<span class="keyword">-&gt;</span> env <span class="symbol">:ast</span> <span class="symbol">:params</span>)]
    (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">Server received form submission with content: </span><span class="delimiter">&quot;</span></span>)
    (cljs.pprint/pprint params)
    (<span class="keyword">let</span> [ids    (<span class="keyword">map</span> (<span class="keyword">fn</span> [[k v]] (<span class="keyword">second</span> k)) (<span class="symbol">:diff</span> params))
          remaps (<span class="keyword">into</span> {} (keep (<span class="keyword">fn</span> [v] (<span class="keyword">when</span> (tempid/tempid? v) [v (next-id)])) ids))]
      {<span class="symbol">:tempids</span> remaps})))

(<span class="keyword">def</span> <span class="function">resolvers</span> [person-resolver submit-person-mutation])

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; Client Code</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(s/def <span class="symbol">:person/name</span> (s/and <span class="keyword">string?</span> #(<span class="keyword">seq</span> (str/trim %))))
(s/def <span class="symbol">:person/age</span> #(s/int-in-range? <span class="integer">1</span> <span class="integer">120</span> %))

(<span class="keyword">defn</span> <span class="function">field-attrs</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">A helper function for getting aspects of a particular field.</span><span class="delimiter">&quot;</span></span>
  [component field]
  (<span class="keyword">let</span> [form         (comp/props component)
        entity-ident (comp/get-ident component form)
        id           (<span class="keyword">str</span> (<span class="keyword">first</span> entity-ident) <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> (<span class="keyword">second</span> entity-ident))
        is-dirty?    (fs/dirty? form field)
        clean?       (<span class="keyword">not</span> is-dirty?)
        validity     (fs/get-spec-validity form field)
        is-invalid?  (<span class="keyword">=</span> <span class="symbol">:invalid</span> validity)
        value        (<span class="keyword">get</span> form field <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)]
    {<span class="symbol">:dirty?</span>   is-dirty?
     <span class="symbol">:ident</span>    entity-ident
     <span class="symbol">:id</span>       id
     <span class="symbol">:clean?</span>   clean?
     <span class="symbol">:validity</span> validity
     <span class="symbol">:invalid?</span> is-invalid?
     <span class="symbol">:value</span>    value}))

(<span class="keyword">def</span> <span class="function">integer-fields</span> #{<span class="symbol">:person/age</span>})

(<span class="keyword">defn</span> <span class="function">input-with-label</span>
  [component field label validation-message input]
  (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [dirty? invalid?]} (field-attrs component field)]
    (comp/fragment
      (dom/div <span class="symbol">:.</span>field {<span class="symbol">:classes</span> [(<span class="keyword">when</span> invalid? <span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>) (<span class="keyword">when</span> dirty? <span class="string"><span class="delimiter">&quot;</span><span class="content">warning</span><span class="delimiter">&quot;</span></span>)]}
        (dom/label {<span class="symbol">:htmlFor</span> (<span class="keyword">str</span> field)} label)
        input)
      (<span class="keyword">when</span> invalid?
        (dom/div <span class="symbol">:.</span>ui.error.message {} validation-message))
      (<span class="keyword">when</span> dirty?
        (dom/div <span class="symbol">:.</span>ui.warning.message {} <span class="string"><span class="delimiter">&quot;</span><span class="content">(dirty)</span><span class="delimiter">&quot;</span></span>)))))

(s/def <span class="symbol">:phone/number</span> #(<span class="keyword">re-matches</span> <span class="regexp"><span class="delimiter">#&quot;</span><span class="content">\(</span><span class="content">?[0-9]{3}[-.)]? *[0-9]{3}-?[0-9]{4}</span><span class="delimiter">&quot;</span></span> %))

(defsc PhoneForm [this {<span class="symbol">:phone/keys</span> [id number <span class="keyword">type</span>] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>       [<span class="symbol">:phone/id</span> <span class="symbol">:phone/number</span> <span class="symbol">:phone/type</span> fs/form-config-join]
   <span class="symbol">:form-fields</span> #{<span class="symbol">:phone/number</span> <span class="symbol">:phone/type</span>}
   <span class="symbol">:ident</span>       <span class="symbol">:phone/id</span>}
  (dom/div <span class="symbol">:.</span>ui.segment
    (dom/div <span class="symbol">:.</span>ui.form
      (input-with-label this <span class="symbol">:phone/number</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Phone:</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">10-digit phone number is required.</span><span class="delimiter">&quot;</span></span>
        (dom/input {<span class="symbol">:value</span>    (<span class="keyword">or</span> (<span class="keyword">str</span> number) <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
                    <span class="symbol">:onBlur</span>   #(comp/transact! this [(fs/mark-complete! {<span class="symbol">:entity-ident</span> [<span class="symbol">:phone/id</span> id]
                                                                         <span class="symbol">:field</span>        <span class="symbol">:phone/number</span>})])
                    <span class="symbol">:onChange</span> #(m/set-string! this <span class="symbol">:phone/number</span> <span class="symbol">:event</span> %)}))
      (input-with-label this <span class="symbol">:phone/type</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Type:</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        (dropdown/ui-dropdown {<span class="symbol">:value</span>     (<span class="keyword">name</span> <span class="keyword">type</span>)
                               <span class="symbol">:selection</span> <span class="predefined-constant">true</span>
                               <span class="symbol">:options</span>   [{<span class="symbol">:text</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Home</span><span class="delimiter">&quot;</span></span> <span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">home</span><span class="delimiter">&quot;</span></span>}
                                           {<span class="symbol">:text</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Work</span><span class="delimiter">&quot;</span></span> <span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span>}]
                               <span class="symbol">:onChange</span>  (<span class="keyword">fn</span> [_ v]
                                            (<span class="keyword">when-let</span> [v (some-&gt; (<span class="keyword">.</span>-value v) <span class="keyword">keyword</span>)]
                                              (m/set-value! this <span class="symbol">:phone/type</span> v)
                                              (comp/transact! this [(fs/mark-complete! {<span class="symbol">:field</span> <span class="symbol">:phone/type</span>})])))})))))

(<span class="keyword">def</span> <span class="function">ui-phone-form</span> (comp/factory PhoneForm {<span class="symbol">:keyfn</span> <span class="symbol">:phone/id</span>}))

(<span class="keyword">defn</span> <span class="function">add-phone*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Add the given phone info to a person.</span><span class="delimiter">&quot;</span></span>
  [state-map phone-id person-id <span class="keyword">type</span> number]
  (<span class="keyword">let</span> [phone-ident      [<span class="symbol">:phone/id</span> phone-id]
        new-phone-entity {<span class="symbol">:phone/id</span> phone-id <span class="symbol">:phone/type</span> <span class="keyword">type</span> <span class="symbol">:phone/number</span> number}]
    (<span class="keyword">-&gt;</span> state-map
      (<span class="keyword">update-in</span> [<span class="symbol">:person/id</span> person-id <span class="symbol">:person/phone-numbers</span>] (fnil <span class="keyword">conj</span> []) phone-ident)
      (<span class="keyword">assoc-in</span> phone-ident new-phone-entity))))

(defmutation add-phone
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation: Add a phone number to a person, and initialize it as a working form.</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [person-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [phone-id (tempid/tempid)]
      (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                     (<span class="keyword">-&gt;</span> s
                       (add-phone* phone-id person-id <span class="symbol">:home</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
                       (fs/add-form-config* PhoneForm [<span class="symbol">:phone/id</span> phone-id])))))))

(defsc PersonForm [this {<span class="symbol">:person/keys</span> [id <span class="keyword">name</span> age phone-numbers]}]
  {<span class="symbol">:query</span>       [<span class="symbol">:person/id</span> <span class="symbol">:person/name</span> <span class="symbol">:person/age</span>
                 {<span class="symbol">:person/phone-numbers</span> (comp/get-query PhoneForm)}
                 fs/form-config-join]
   <span class="symbol">:form-fields</span> #{<span class="symbol">:person/name</span> <span class="symbol">:person/age</span> <span class="symbol">:person/phone-numbers</span>} <span class="comment">; phone-numbers here becomes a subform because it is a join in the query.</span>
   <span class="symbol">:ident</span>       <span class="symbol">:person/id</span>}
  (dom/div <span class="symbol">:.</span>ui.form
    (input-with-label this <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Name:</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Name is required.</span><span class="delimiter">&quot;</span></span>
      (dom/input {<span class="symbol">:value</span>    (<span class="keyword">or</span> <span class="keyword">name</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
                  <span class="symbol">:onBlur</span>   #(comp/transact! this [(fs/mark-complete! {<span class="symbol">:entity-ident</span> [<span class="symbol">:person/id</span> id]
                                                                       <span class="symbol">:field</span>        <span class="symbol">:person/name</span>})
                                                   <span class="symbol">:root/person</span>])
                  <span class="symbol">:onChange</span> (<span class="keyword">fn</span> [evt]
                              (m/set-string! this <span class="symbol">:person/name</span> <span class="symbol">:event</span> evt))}))
    (input-with-label this <span class="symbol">:person/age</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Age:</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Age must be between 1 and 120</span><span class="delimiter">&quot;</span></span>
      (dom/input {<span class="symbol">:value</span>    (<span class="keyword">or</span> age <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
                  <span class="symbol">:onBlur</span>   #(comp/transact! this [(fs/mark-complete! {<span class="symbol">:entity-ident</span> [<span class="symbol">:person/id</span> id]
                                                                       <span class="symbol">:field</span>        <span class="symbol">:person/age</span>})
                                                   <span class="symbol">:root/person</span>])
                  <span class="symbol">:onChange</span> #(m/set-integer! this <span class="symbol">:person/age</span> <span class="symbol">:event</span> %)}))
    (dom/h4 <span class="string"><span class="delimiter">&quot;</span><span class="content">Phone numbers:</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">when</span> (<span class="keyword">seq</span> phone-numbers)
      (<span class="keyword">map</span> ui-phone-form phone-numbers))
    (dom/button <span class="symbol">:.</span>ui.button {<span class="symbol">:onClick</span> #(comp/transact! this `[(add-phone {<span class="symbol">:person-id</span> ~id})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">+</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-person-form</span> (comp/factory PersonForm {<span class="symbol">:keyfn</span> <span class="symbol">:person/id</span>}))

(<span class="keyword">defn</span> <span class="function">add-person*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Add a person with the given details to the state database.</span><span class="delimiter">&quot;</span></span>
  [state-map id <span class="keyword">name</span> age]
  (<span class="keyword">let</span> [person-ident [<span class="symbol">:person/id</span> id]
        person       {<span class="symbol">:person/id</span> id <span class="symbol">:person/name</span> <span class="keyword">name</span> <span class="symbol">:person/age</span> age}]
    (<span class="keyword">assoc-in</span> state-map person-ident person)))

(defmutation edit-new-person [_]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [person-id    (tempid/tempid)
          person-ident [<span class="symbol">:person/id</span> person-id]
          phone-id     (tempid/tempid)]
      (<span class="keyword">swap!</span> state
        (<span class="keyword">fn</span> [s] (<span class="keyword">-&gt;</span> s
                  (add-person* person-id <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="integer">0</span>)
                  (add-phone* phone-id person-id <span class="symbol">:home</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
                  (<span class="keyword">assoc</span> <span class="symbol">:root/person</span> person-ident)         <span class="comment">; join it into the UI as the person to edit</span>
                  (fs/add-form-config* PersonForm [<span class="symbol">:person/id</span> person-id])))))))

(defmutation edit-existing-person
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Turn an existing person with phone numbers into an editable form with phone subforms.</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [person-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state
      (<span class="keyword">fn</span> [s] (<span class="keyword">-&gt;</span> s
                (<span class="keyword">assoc</span> <span class="symbol">:root/person</span> [<span class="symbol">:person/id</span> person-id])
                (fs/add-form-config* PersonForm [<span class="symbol">:person/id</span> person-id]) <span class="comment">; will not re-add config to entities that were present</span>
                (fs/entity-&gt;pristine* [<span class="symbol">:person/id</span> person-id]) <span class="comment">; in case we're re-loading it, make sure the pristine copy it up-to-date</span>
                <span class="comment">;; it just came from server, so all fields should be valid</span>
                (fs/mark-complete* [<span class="symbol">:person/id</span> person-id]))))))

(defmutation submit-person [{<span class="symbol">:keys</span> [id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state fs/entity-&gt;pristine* [<span class="symbol">:person/id</span> id]))
  (remote [env] <span class="predefined-constant">true</span>))

(defsc Root [this {<span class="symbol">:keys</span> [root/person]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:root/person</span> (comp/get-query PersonForm)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {})}
  (ele/ui-iframe {<span class="symbol">:frameBorder</span> <span class="integer">0</span> <span class="symbol">:width</span> <span class="integer">800</span> <span class="symbol">:height</span> <span class="integer">820</span>}
    (dom/div <span class="symbol">:.</span>ui.container.segments
      (dom/link {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css</span><span class="delimiter">&quot;</span></span>})
      (dom/button <span class="symbol">:.</span>ui.button
        {<span class="symbol">:onClick</span> #(df/load! this [<span class="symbol">:person/id</span> <span class="integer">21</span>] PersonForm {<span class="symbol">:target</span>               [<span class="symbol">:root/person</span>]
                                                              <span class="symbol">:post-mutation</span>        `edit-existing-person
                                                              <span class="symbol">:post-mutation-params</span> {<span class="symbol">:person-id</span> <span class="integer">21</span>}})}
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Simulate Edit (existing) Person from Server</span><span class="delimiter">&quot;</span></span>)
      (dom/button <span class="symbol">:.</span>ui.buton {<span class="symbol">:onClick</span> #(comp/transact! this `[(edit-new-person {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Simulate New Person Creation</span><span class="delimiter">&quot;</span></span>)

      (<span class="keyword">when</span> (<span class="symbol">:person/id</span> person)
        (dom/div <span class="symbol">:.</span>ui.segment
          (ui-person-form person)))

      (dom/div <span class="symbol">:.</span>ui.segment
        (dom/button <span class="symbol">:.</span>ui.button {<span class="symbol">:onClick</span>  #(comp/transact! this `[(fs/reset-form! {<span class="symbol">:form-ident</span> [<span class="symbol">:person/id</span> ~(<span class="symbol">:person/id</span> person)]})])
                                 <span class="symbol">:disabled</span> (<span class="keyword">not</span> (fs/dirty? person))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Reset</span><span class="delimiter">&quot;</span></span>)
        (dom/button <span class="symbol">:.</span>ui.button {<span class="symbol">:onClick</span>  #(comp/transact! this `[(submit-person {<span class="symbol">:id</span> ~(<span class="symbol">:person/id</span> person) <span class="symbol">:diff</span> ~(fs/dirty-fields person <span class="predefined-constant">false</span>)})])
                                 <span class="symbol">:disabled</span> (<span class="keyword">or</span>
                                             (fs/invalid-spec? person)
                                             (<span class="keyword">not</span> (fs/dirty? person)))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Submit</span><span class="delimiter">&quot;</span></span>)))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 42. <a id="DynamicUIRouting"></a><a href="#DynamicUIRouting">Dynamic UI Routing</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('dynamic-ui-routing')">Focus Inspector</button>
<div class="short narrow example" id="dynamic-ui-routing"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.dynamic-ui-routing</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.routing.legacy-ui-routers <span class="symbol">:as</span> r]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [cljs.loader <span class="symbol">:as</span> loader]
    [taoensso.timbre <span class="symbol">:as</span> log]))

(defsc Login [this {<span class="symbol">:keys</span> [label login-prop]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {r/dynamic-route-key <span class="symbol">:login</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">LOGIN</span><span class="delimiter">&quot;</span></span> <span class="symbol">:login-prop</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">login data</span><span class="delimiter">&quot;</span></span>})
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:login</span> <span class="symbol">:singleton</span>])
   <span class="symbol">:query</span>         [r/dynamic-route-key <span class="symbol">:label</span> <span class="symbol">:login-prop</span>]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>}}
    (<span class="keyword">str</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> login-prop)))

(defsc NewUser [this {<span class="symbol">:keys</span> [label new-user-prop]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {r/dynamic-route-key <span class="symbol">:new-user</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New User</span><span class="delimiter">&quot;</span></span> <span class="symbol">:new-user-prop</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">new user data</span><span class="delimiter">&quot;</span></span>})
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:new-user</span> <span class="symbol">:singleton</span>])
   <span class="symbol">:query</span>         [r/dynamic-route-key <span class="symbol">:label</span> <span class="symbol">:new-user-prop</span>]}
  (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">skyblue</span><span class="delimiter">&quot;</span></span>}}
    (<span class="keyword">str</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> new-user-prop)))

(defsc Root [this {<span class="symbol">:keys</span> [top-router <span class="symbol">:com.fulcrologic.fulcro.routing.legacy-ui-routers/pending-route</span>]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] (<span class="keyword">merge</span>
                                 (r/routing-tree
                                   (r/make-route <span class="symbol">:ui-main</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:ui-main</span> <span class="symbol">:singleton</span>])])
                                   (r/make-route <span class="symbol">:login</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:login</span> <span class="symbol">:singleton</span>])])
                                   (r/make-route <span class="symbol">:new-user</span> [(r/router-instruction <span class="symbol">:top-router</span> [<span class="symbol">:new-user</span> <span class="symbol">:singleton</span>])]))
                                 {<span class="symbol">:top-router</span> (comp/get-initial-state r/DynamicRouter {<span class="symbol">:id</span> <span class="symbol">:top-router</span>})}))
   <span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span> {<span class="symbol">:top-router</span> (r/get-dynamic-router-query <span class="symbol">:top-router</span>)}
                   <span class="symbol">:com.fulcrologic.fulcro.routing.legacy-ui-routers/pending-route</span>
                   r/routing-tree-key]}
  (dom/div <span class="predefined-constant">nil</span>
    <span class="comment">; Sample nav mutations</span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:ui-main</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Main</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:new-user</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">New User</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/a {<span class="symbol">:onClick</span> #(comp/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:login</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Login</span><span class="delimiter">&quot;</span></span>) <span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class="delimiter">&quot;</span></span>
    (dom/div (<span class="keyword">if</span> pending-route <span class="string"><span class="delimiter">&quot;</span><span class="content">Loading</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Done</span><span class="delimiter">&quot;</span></span>))
    (r/ui-dynamic-router top-router)))

<span class="comment">; Use this as started-callback. These would happen as a result of module loads:</span>
(<span class="keyword">defn</span> <span class="function">application-loaded</span> [app]
  <span class="comment">; Let the dynamic router know that two of the routes are already loaded.</span>
  (comp/transact! app `[(r/install-route {<span class="symbol">:target-kw</span> <span class="symbol">:new-user</span> <span class="symbol">:component</span> ~NewUser})
                        (r/install-route {<span class="symbol">:target-kw</span> <span class="symbol">:login</span> <span class="symbol">:component</span> ~Login})
                        (r/route-to {<span class="symbol">:handler</span> <span class="symbol">:login</span>})]))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 43. <a id="Autocomplete"></a><a href="#Autocomplete">Autocomplete</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('autocomplete-demo')">Focus Inspector</button>
<div class="short narrow example" id="autocomplete-demo"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.autocomplete</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [book.demos.airports <span class="symbol">:refer</span> [airports]]
    [clojure.string <span class="symbol">:as</span> <span class="keyword">str</span>]
    [goog.functions <span class="symbol">:as</span> gf]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]
    ))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
(<span class="keyword">defn</span> <span class="function">airport-search</span> [s]
  (<span class="keyword">-&gt;&gt;</span> airports
    (<span class="keyword">filter</span> (<span class="keyword">fn</span> [i] (str/includes? (str/lower-case i) (str/lower-case s))))
    (<span class="keyword">take</span> <span class="integer">10</span>)
    <span class="keyword">vec</span>))

(pc/defresolver list-resolver [env params]
  {<span class="symbol">::pc/output</span> [<span class="symbol">:autocomplete/airports</span>]}
  (<span class="keyword">let</span> [search (<span class="keyword">get-in</span> env [<span class="symbol">:ast</span> <span class="symbol">:params</span> <span class="symbol">:search</span>])]
    {<span class="symbol">:autocomplete/airports</span> (airport-search search)}))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">defn</span> <span class="function">autocomplete-ident</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns the ident for an autocomplete control. Can be passed a map of props, or a raw ID.</span><span class="delimiter">&quot;</span></span>
  [id-or-props]
  (<span class="keyword">if</span> (<span class="keyword">map?</span> id-or-props)
    [<span class="symbol">:autocomplete/by-id</span> (<span class="symbol">:db/id</span> id-or-props)]
    [<span class="symbol">:autocomplete/by-id</span> id-or-props]))

(defsc CompletionList [this {<span class="symbol">:keys</span> [values onValueSelect]}]
  (dom/ul <span class="predefined-constant">nil</span>
    (<span class="keyword">map</span> (<span class="keyword">fn</span> [v]
           (dom/li {<span class="symbol">:key</span> v}
             (dom/a {<span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">javascript:void(0)</span><span class="delimiter">&quot;</span></span> <span class="symbol">:onClick</span> #(onValueSelect v)} v))) values)))

(<span class="keyword">def</span> <span class="function">ui-completion-list</span> (comp/factory CompletionList))

(m/defmutation populate-loaded-suggestions
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation: Autocomplete suggestions are loaded in a non-visible property to prevent flicker. This is
  used as a post mutation to move them to the active UI field so they appear.</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [autocomplete-path (autocomplete-ident id)
          source-path       (<span class="keyword">conj</span> autocomplete-path <span class="symbol">:autocomplete/loaded-suggestions</span>)
          target-path       (<span class="keyword">conj</span> autocomplete-path <span class="symbol">:autocomplete/suggestions</span>)]
      (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span> target-path (<span class="keyword">get-in</span> @state source-path)))))

(<span class="keyword">def</span> <span class="function">get-suggestions</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">A debounced function that will trigger a load of the server suggestions into a temporary locations and fire
   a post mutation when that is complete to move them into the main UI view.</span><span class="delimiter">&quot;</span></span>
  (<span class="keyword">letfn</span> [(load-suggestions [<span class="keyword">comp</span> new-value id]
            (df/load! <span class="keyword">comp</span> <span class="symbol">:autocomplete/airports</span> <span class="predefined-constant">nil</span>
              {<span class="symbol">:params</span>               {<span class="symbol">:search</span> new-value}
               <span class="symbol">:marker</span>               <span class="predefined-constant">false</span>
               <span class="symbol">:post-mutation</span>        `populate-loaded-suggestions
               <span class="symbol">:post-mutation-params</span> {<span class="symbol">:id</span> id}
               <span class="symbol">:target</span>               (<span class="keyword">conj</span> (autocomplete-ident id) <span class="symbol">:autocomplete/loaded-suggestions</span>)}))]
    (gf/debounce load-suggestions <span class="integer">500</span>)))

(defsc Autocomplete [this {<span class="symbol">:keys</span> [db/id autocomplete/suggestions autocomplete/value] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span>                                   <span class="comment">; the component's ID</span>
                   <span class="symbol">:autocomplete/loaded-suggestions</span>         <span class="comment">; A place to do the loading, so we can prevent flicker in the UI</span>
                   <span class="symbol">:autocomplete/suggestions</span>                <span class="comment">; the current completion suggestions</span>
                   <span class="symbol">:autocomplete/value</span>]                     <span class="comment">; the current user-entered value</span>
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] (autocomplete-ident props))
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id]}] {<span class="symbol">:db/id</span> id <span class="symbol">:autocomplete/suggestions</span> [] <span class="symbol">:autocomplete/value</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>})}
  (<span class="keyword">let</span> [field-id             (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">autocomplete-</span><span class="delimiter">&quot;</span></span> id)       <span class="comment">; for html label/input association</span>
        <span class="comment">;; server gives us a few, and as the user types we need to filter it further.</span>
        filtered-suggestions (<span class="keyword">when</span> (<span class="keyword">vector?</span> suggestions)
                               (<span class="keyword">filter</span> #(str/includes? (str/lower-case %) (str/lower-case value)) suggestions))
        <span class="comment">; We want to not show the list if they've chosen something valid</span>
        exact-match?         (<span class="keyword">and</span> (<span class="keyword">=</span> <span class="integer">1</span> (<span class="keyword">count</span> filtered-suggestions)) (<span class="keyword">=</span> value (<span class="keyword">first</span> filtered-suggestions)))
        <span class="comment">; When they select an item, we place it's value in the input</span>
        onSelect             (<span class="keyword">fn</span> [v] (m/set-string! this <span class="symbol">:autocomplete/value</span> <span class="symbol">:value</span> v))]
    (dom/div {<span class="symbol">:style</span> {<span class="symbol">:height</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">600px</span><span class="delimiter">&quot;</span></span>}}
      (dom/label {<span class="symbol">:htmlFor</span> field-id} <span class="string"><span class="delimiter">&quot;</span><span class="content">Airport: </span><span class="delimiter">&quot;</span></span>)
      (dom/input {<span class="symbol">:id</span>       field-id
                  <span class="symbol">:value</span>    value
                  <span class="symbol">:onChange</span> (<span class="keyword">fn</span> [evt]
                              (<span class="keyword">let</span> [new-value (<span class="keyword">..</span> evt -target -value)]
                                <span class="comment">; we avoid even looking for help until they've typed a couple of letters</span>
                                (<span class="keyword">if</span> (<span class="keyword">&gt;=</span> (<span class="keyword">.</span>-length new-value) <span class="integer">2</span>)
                                  (get-suggestions this new-value id)
                                  <span class="comment">; if they shrink the value too much, clear suggestions</span>
                                  (m/set-value! this <span class="symbol">:autocomplete/suggestions</span> []))
                                <span class="comment">; always update the input itself (controlled)</span>
                                (m/set-string! this <span class="symbol">:autocomplete/value</span> <span class="symbol">:value</span> new-value)))})
      <span class="comment">; show the completion list when it exists and isn't just exactly what they've chosen</span>
      (<span class="keyword">when</span> (<span class="keyword">and</span> (<span class="keyword">vector?</span> suggestions) (<span class="keyword">seq</span> suggestions) (<span class="keyword">not</span> exact-match?))
        (ui-completion-list {<span class="symbol">:values</span> filtered-suggestions <span class="symbol">:onValueSelect</span> onSelect})))))

(<span class="keyword">def</span> <span class="function">ui-autocomplete</span> (comp/factory Autocomplete))

(defsc AutocompleteRoot [this {<span class="symbol">:keys</span> [airport-input]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:airport-input</span> (comp/get-initial-state Autocomplete {<span class="symbol">:id</span> <span class="symbol">:airports</span>})})
   <span class="symbol">:query</span>         [{<span class="symbol">:airport-input</span> (comp/get-query Autocomplete)}]}
  (dom/div
    (dom/h4 <span class="string"><span class="delimiter">&quot;</span><span class="content">Airport Autocomplete</span><span class="delimiter">&quot;</span></span>)
    (ui-autocomplete airport-input)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 44. <a id="CascadingDropdowns"></a><a href="#CascadingDropdowns">Cascading Dropdowns</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('cascading-dropdowns')">Focus Inspector</button>
<div class="short narrow example" id="cascading-dropdowns"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.cascading-dropdowns</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.semantic-ui.modules.dropdown.ui-dropdown <span class="symbol">:as</span> dropdown]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:refer</span> [defmutation]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [book.elements <span class="symbol">:as</span> ele]
    [taoensso.timbre <span class="symbol">:as</span> log]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; Server</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">defn</span> <span class="function">option</span> [value text]
  {<span class="symbol">:text</span> text <span class="symbol">:value</span> value})

(pc/defresolver model-resolver [env _]
  {<span class="symbol">::pc/output</span> [<span class="symbol">:models</span>]}
  (<span class="keyword">let</span> [make (<span class="keyword">-&gt;</span> env <span class="symbol">:ast</span> <span class="symbol">:params</span> <span class="symbol">:make</span>)]
    {<span class="symbol">:models</span> (<span class="keyword">case</span> make
               <span class="symbol">:ford</span> [(option <span class="symbol">:escort</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Escort</span><span class="delimiter">&quot;</span></span>) (option <span class="symbol">:F-150</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">F-150</span><span class="delimiter">&quot;</span></span>)]
               <span class="symbol">:honda</span> [(option <span class="symbol">:civic</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Civic</span><span class="delimiter">&quot;</span></span>) (option <span class="symbol">:accort</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Accord</span><span class="delimiter">&quot;</span></span>)])}))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; Client</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">defn</span> <span class="function">render-example</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Wrap an example in an iframe so we can load external CSS without affecting the containing page.</span><span class="delimiter">&quot;</span></span>
  [width height &amp; children]
  (ele/ui-iframe {<span class="symbol">:frameBorder</span> <span class="integer">0</span> <span class="symbol">:height</span> height <span class="symbol">:width</span> width}
    (<span class="keyword">apply</span> dom/div {<span class="symbol">:key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">example-frame-key</span><span class="delimiter">&quot;</span></span>}
      (dom/style <span class="string"><span class="delimiter">&quot;</span><span class="content">.boxed {border: 1px solid black}</span><span class="delimiter">&quot;</span></span>)
      (dom/link {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css</span><span class="delimiter">&quot;</span></span>})
      children)))

(<span class="keyword">comment</span>

  (defmutation show-list-loading
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Change the items of the dropdown with the given ID to a single item that indicates Loading...</span><span class="delimiter">&quot;</span></span>
    [{<span class="symbol">:keys</span> [id]}]
    (action [{<span class="symbol">:keys</span> [state]}]
      (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span>
        [<span class="symbol">:bootstrap.dropdown/by-id</span> id <span class="symbol">:fulcro.ui.bootstrap3/items</span>]
        [(<span class="keyword">assoc</span> (bs/dropdown-item <span class="symbol">:loading</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Loading...</span><span class="delimiter">&quot;</span></span>) <span class="symbol">:fulcro.ui.bootstrap3/disabled?</span> <span class="predefined-constant">true</span>)])))

  (defsc Root [this {<span class="symbol">:keys</span> [make-dropdown model-dropdown]}]
    {<span class="symbol">:initial-state</span> {}
     <span class="symbol">:query</span>         [<span class="comment">; initial state for two Bootstrap dropdowns</span>
                     {<span class="symbol">:make-dropdown</span> (comp/get-query bs/Dropdown)}
                     {<span class="symbol">:model-dropdown</span> (comp/get-query bs/Dropdown)}]}
    (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [<span class="symbol">:fulcro.ui.bootstrap3/items</span>]} model-dropdown]
      (render-example <span class="string"><span class="delimiter">&quot;</span><span class="content">200px</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">200px</span><span class="delimiter">&quot;</span></span>
        (dom/div
          (dropdown/ui-dropdown
            {<span class="symbol">:onSelect</span>  (<span class="keyword">fn</span> [item]
                          <span class="comment">; Update the state of the model dropdown to show a loading indicator</span>
                          (comp/transact! this `[(show-list-loading {<span class="symbol">:id</span> <span class="symbol">:model</span>})])
                          <span class="comment">; Issue the remote load. Note the use of DropdownItem as the query, so we get proper normalization</span>
                          <span class="comment">; The targeting is used to make sure we hit the correct dropdown's items</span>
                          (df/load this <span class="symbol">:models</span> bs/DropdownItem {<span class="symbol">:target</span> [<span class="symbol">:bootstrap.dropdown/by-id</span> <span class="symbol">:model</span> <span class="symbol">:fulcro.ui.bootstrap3/items</span>]
                                                                 <span class="comment">; don't overwrite state with loading markers...we're doing that manually to structure it specially</span>
                                                                 <span class="symbol">:marker</span> <span class="predefined-constant">false</span>
                                                                 <span class="comment">; A server parameter on the query</span>
                                                                 <span class="symbol">:params</span> {<span class="symbol">:make</span> item}}))
             <span class="symbol">:stateful?</span> <span class="predefined-constant">true</span>})
          (dropdown/ui-dropdown model-dropdown
            {<span class="symbol">:onSelect</span>  (<span class="keyword">fn</span> [item] (log/info item))
             <span class="symbol">:stateful?</span> <span class="predefined-constant">true</span>}))))))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 45. <a id="LoadingInResponseToUIRouting"></a><a href="#LoadingInResponseToUIRouting">Loading In Response To UI Routing</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('loading-in-response-to-UI-routing')">Focus Inspector</button>
<div class="short narrow example" id="loading-in-response-to-UI-routing"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.loading-in-response-to-UI-routing</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.routing.legacy-ui-routers <span class="symbol">:as</span> r]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(pc/defresolver all-settings-resolver [env input]
  {<span class="symbol">::pc/output</span> [{<span class="symbol">:all-settings</span> [<span class="symbol">:id</span> <span class="symbol">:value</span>]}]}
  {<span class="symbol">:all-settings</span> [{<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Gorgon</span><span class="delimiter">&quot;</span></span>}
                  {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Thraser</span><span class="delimiter">&quot;</span></span>}
                  {<span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:value</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Under</span><span class="delimiter">&quot;</span></span>}]})

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(defsc SomeSetting [this {<span class="symbol">:keys</span> [id value]}]
  {<span class="symbol">:query</span> [<span class="symbol">:ui/fetch-state</span> <span class="symbol">:id</span> <span class="symbol">:value</span>]
   <span class="symbol">:ident</span> [<span class="symbol">:setting/by-id</span> <span class="symbol">:id</span>]}
  (dom/p <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Setting </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content"> from server has value: </span><span class="delimiter">&quot;</span></span> value))

(<span class="keyword">def</span> <span class="function">ui-setting</span> (comp/factory SomeSetting {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

(defsc SettingsTab [this {<span class="symbol">:keys</span> [settings-content settings]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:kind</span>             <span class="symbol">:settings</span>
                   <span class="symbol">:settings-content</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Settings Tab</span><span class="delimiter">&quot;</span></span>
                   <span class="symbol">:settings</span>         []}
   <span class="comment">; This query uses a &quot;link&quot;...a special ident with '_ as the ID. This indicates the item is at the database</span>
   <span class="comment">; root, not inside of the &quot;settings&quot; database object. This is not needed as a matter of course...it is only used</span>
   <span class="comment">; for convenience (since it is trivial to load something into the root of the database)</span>
   <span class="symbol">:query</span>         [<span class="symbol">:kind</span> <span class="symbol">:settings-content</span> {<span class="symbol">:settings</span> (comp/get-query SomeSetting)}]}
  (dom/div <span class="predefined-constant">nil</span>
    settings-content
    (<span class="keyword">if</span> (<span class="keyword">seq</span> settings)
      (<span class="keyword">map</span> ui-setting settings)
      (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">No settings.</span><span class="delimiter">&quot;</span></span>))))

(defsc MainTab [this {<span class="symbol">:keys</span> [main-content]}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:kind</span> <span class="symbol">:main</span> <span class="symbol">:main-content</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Main Tab</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:query</span>         [<span class="symbol">:kind</span> <span class="symbol">:main-content</span>]}
  (dom/div <span class="predefined-constant">nil</span> main-content))

(r/defsc-router UITabs [this props]
  {<span class="symbol">:router-id</span>      <span class="symbol">:ui-router</span>
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [(<span class="symbol">:kind</span> props) <span class="symbol">:tab</span>])
   <span class="symbol">:default-route</span>  MainTab
   <span class="symbol">:router-targets</span> {<span class="symbol">:main</span>     MainTab
                    <span class="symbol">:settings</span> SettingsTab}})

(<span class="keyword">def</span> <span class="function">ui-tabs</span> (comp/factory UITabs))

(m/defmutation choose-tab [{<span class="symbol">:keys</span> [tab]}]
  (action [{<span class="symbol">:keys</span> [state]}] (<span class="keyword">swap!</span> state r/set-route <span class="symbol">:ui-router</span> [tab <span class="symbol">:tab</span>])))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; LAZY LOADING TAB CONTENT</span>
<span class="comment">;; This is the shape of what to do. We define a method that can examine the</span>
<span class="comment">;; state to decide if we want to trigger a load. Then we define a mutation</span>
<span class="comment">;; that the UI can call during transact (see the transact! call for Settings on Root in ui.cljs).</span>
<span class="comment">;; The mutation itself (app/lazy-load-tab) below uses a data-fetch helper function to</span>
<span class="comment">;; set :remote to the right thing, and can then give one or more load-data-action's to</span>
<span class="comment">;; indicate what should actually be retrieved. The server implementation is trivial in</span>
<span class="comment">;; this case. See api.clj.</span>

<span class="comment">;; When to consider the data missing? Check the state and find out.</span>
(<span class="keyword">defn</span> <span class="function">missing-tab?</span> [state tab]
  (<span class="keyword">let</span> [settings (<span class="keyword">-&gt;</span> @state <span class="symbol">:settings</span> <span class="symbol">:tab</span> <span class="symbol">:settings</span>)]
    (<span class="keyword">or</span> (<span class="keyword">not</span> (<span class="keyword">vector?</span> settings))
      (<span class="keyword">and</span> (<span class="keyword">vector?</span> settings) (<span class="keyword">empty?</span> settings)))))

(m/defmutation lazy-load-tab [{<span class="symbol">:keys</span> [tab]}]
  (action [{<span class="symbol">:keys</span> [app state] <span class="symbol">:as</span> env}]
    <span class="comment">; Specify what you want to load as one or more calls to load-action (each call adds an item to load):</span>
    (<span class="keyword">when</span> (missing-tab? state tab)
      (df/load! app <span class="symbol">:all-settings</span> SomeSetting
        {<span class="symbol">:target</span>  [<span class="symbol">:settings</span> <span class="symbol">:tab</span> <span class="symbol">:settings</span>]
         <span class="symbol">:refresh</span> [<span class="symbol">:settings</span>]}))))

(defsc Root [this {<span class="symbol">:keys</span> [current-tab] <span class="symbol">:as</span> props}]
  <span class="comment">; Construction MUST compose to root, just like the query. The resulting tree will automatically be normalized into the</span>
  <span class="comment">; app state graph database.</span>
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:current-tab</span> (comp/get-initial-state UITabs <span class="predefined-constant">nil</span>)})
   <span class="symbol">:query</span>         [{<span class="symbol">:current-tab</span> (comp/get-query UITabs)}]}
  (dom/div
    <span class="comment">; The selection of tabs can be rendered in a child, but the transact! must be done from the parent (to</span>
    <span class="comment">; ensure proper re-render of the tab body). See comp/computed for passing callbacks.</span>
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(choose-tab {<span class="symbol">:tab</span> <span class="symbol">:main</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Main</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(choose-tab {<span class="symbol">:tab</span> <span class="symbol">:settings</span>})
                                                  <span class="comment">; extra mutation: sample of what you would do to lazy load the tab content</span>
                                                  (lazy-load-tab {<span class="symbol">:tab</span> <span class="symbol">:settings</span>})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Settings</span><span class="delimiter">&quot;</span></span>)
    (ui-tabs current-tab)))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 46. <a id="PaginatingListsFromServer"></a><a href="#PaginatingListsFromServer">Paginating Lists From Server</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('paginating-large-lists-from-server')">Focus Inspector</button>
<div class="short narrow example" id="paginating-large-lists-from-server"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.paginating-large-lists-from-server</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.mutations <span class="symbol">:as</span> m]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span>]
    [com.wsscode.pathom.connect <span class="symbol">:as</span> pc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(pc/defresolver infinite-pages [env input]
  {<span class="symbol">::pc/output</span> [{<span class="symbol">:paginate/items</span> [<span class="symbol">:item/id</span>]}]}
  (<span class="keyword">let</span> [params (<span class="keyword">-&gt;</span> env <span class="symbol">:ast</span> <span class="symbol">:params</span>)
        {<span class="symbol">:keys</span> [start end]} params]
    {<span class="symbol">:paginate/items</span> (mapv (<span class="keyword">fn</span> [id] {<span class="symbol">:item/id</span> id}) (<span class="keyword">range</span> start end))}))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">defn</span> <span class="function">page-exists?</span> [state-map page-number]
  (<span class="keyword">let</span> [page-items (<span class="keyword">get-in</span> state-map [<span class="symbol">:page/by-number</span> page-number <span class="symbol">:page/items</span>])]
    (<span class="keyword">boolean</span> (<span class="keyword">seq</span> page-items))))

(<span class="keyword">defn</span> <span class="function">init-page</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">An idempotent init function that just ensures enough of a page exists to make the UI work.
   Doesn't affect the items.</span><span class="delimiter">&quot;</span></span>
  [state-map page-number]
  (<span class="keyword">assoc-in</span> state-map [<span class="symbol">:page/by-number</span> page-number <span class="symbol">:page/number</span>] page-number))

(<span class="keyword">defn</span> <span class="function">set-current-page</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Point the current list's current page to the correct page entity in the db (via ident).</span><span class="delimiter">&quot;</span></span>
  [state-map page-number]
  (<span class="keyword">assoc-in</span> state-map [<span class="symbol">:list/by-id</span> <span class="integer">1</span> <span class="symbol">:list/current-page</span>] [<span class="symbol">:page/by-number</span> page-number]))

(<span class="keyword">defn</span> <span class="function">clear-item</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Removes the given item from the item table.</span><span class="delimiter">&quot;</span></span>
  [state-map item-id] (update state-map <span class="symbol">:items/by-id</span> <span class="keyword">dissoc</span> item-id))

(<span class="keyword">defn</span> <span class="function">clear-page</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Clear the given page (and associated items) from the app database.</span><span class="delimiter">&quot;</span></span>
  [state-map page-number]
  (<span class="keyword">let</span> [page        (<span class="keyword">get-in</span> state-map [<span class="symbol">:page/by-number</span> page-number])
        item-idents (<span class="symbol">:page/items</span> page)
        item-ids    (<span class="keyword">map</span> <span class="keyword">second</span> item-idents)]
    (as-&gt; state-map s
      (update s <span class="symbol">:page/by-number</span> <span class="keyword">dissoc</span> page-number)
      (<span class="keyword">reduce</span> (<span class="keyword">fn</span> [acc id] (update acc <span class="symbol">:items/by-id</span> <span class="keyword">dissoc</span> id)) s item-ids))))

(<span class="keyword">defn</span> <span class="function">gc-distant-pages</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Clears loaded items from pages 5 or more steps away from the given page number.</span><span class="delimiter">&quot;</span></span>
  [state-map page-number]
  (<span class="keyword">reduce</span> (<span class="keyword">fn</span> [s n]
            (<span class="keyword">if</span> (<span class="keyword">&lt;</span> <span class="integer">4</span> (Math/abs (<span class="keyword">-</span> page-number n)))
              (clear-page s n)
              s)) state-map (<span class="keyword">keys</span> (<span class="symbol">:page/by-number</span> state-map))))

(<span class="keyword">declare</span> <span class="function">ListItem</span>)

(<span class="keyword">defn</span> <span class="function">load-if-missing</span> [{<span class="symbol">:keys</span> [app state] <span class="symbol">:as</span> env} page-number]
  (<span class="keyword">when-not</span> (page-exists? @state page-number)
    (<span class="keyword">let</span> [start (<span class="keyword">inc</span> (<span class="keyword">*</span> <span class="integer">10</span> (<span class="keyword">dec</span> page-number)))
          end   (<span class="keyword">+</span> start <span class="integer">9</span>)]
      (df/load! app <span class="symbol">:paginate/items</span> ListItem {<span class="symbol">:params</span> {<span class="symbol">:start</span> start <span class="symbol">:end</span> end}
                                              <span class="symbol">:marker</span> <span class="symbol">:page</span>
                                              <span class="symbol">:target</span> [<span class="symbol">:page/by-number</span> page-number <span class="symbol">:page/items</span>]}))))

(m/defmutation goto-page [{<span class="symbol">:keys</span> [page-number]}]
  (action [{<span class="symbol">:keys</span> [state] <span class="symbol">:as</span> env}]
    (load-if-missing env page-number)
    (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                   (<span class="keyword">-&gt;</span> s
                     (init-page page-number)
                     (set-current-page page-number)
                     (gc-distant-pages page-number))))))

(defsc ListItem [this {<span class="symbol">:keys</span> [item/id]}]
  {<span class="symbol">:query</span> [<span class="symbol">:item/id</span> <span class="symbol">:ui/fetch-state</span>]
   <span class="symbol">:ident</span> [<span class="symbol">:items/by-id</span> <span class="symbol">:item/id</span>]}
  (dom/li (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Item </span><span class="delimiter">&quot;</span></span> id)))

(<span class="keyword">def</span> <span class="function">ui-list-item</span> (comp/factory ListItem {<span class="symbol">:keyfn</span> <span class="symbol">:item/id</span>}))

(defsc ListPage [this {<span class="symbol">:keys</span> [page/number page/items] <span class="symbol">:as</span> props}]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:page/number</span> <span class="integer">1</span> <span class="symbol">:page/items</span> []}
   <span class="symbol">:query</span>         [<span class="symbol">:page/number</span> {<span class="symbol">:page/items</span> (comp/get-query ListItem)}
                   [df/marker-table <span class="symbol">:page</span>]]
   <span class="symbol">:ident</span>         [<span class="symbol">:page/by-number</span> <span class="symbol">:page/number</span>]}
  (<span class="keyword">let</span> [status (<span class="keyword">get</span> props [df/marker-table <span class="symbol">:page</span>])]
    (dom/div
      (dom/p <span class="string"><span class="delimiter">&quot;</span><span class="content">Page number </span><span class="delimiter">&quot;</span></span> number)
      (<span class="keyword">if</span> (df/loading? status)
        (dom/div <span class="string"><span class="delimiter">&quot;</span><span class="content">Loading...</span><span class="delimiter">&quot;</span></span>)
        (dom/ul (mapv ui-list-item items))))))

(<span class="keyword">def</span> <span class="function">ui-list-page</span> (comp/factory ListPage {<span class="symbol">:keyfn</span> <span class="symbol">:page/number</span>}))

(defsc LargeList [this {<span class="symbol">:keys</span> [list/current-page]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:list/current-page</span> (comp/get-initial-state ListPage {})})
   <span class="symbol">:query</span>         [{<span class="symbol">:list/current-page</span> (comp/get-query ListPage)}]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:list/by-id</span> <span class="integer">1</span>])}
  (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [page/number]} current-page]
    (dom/div
      (dom/button {<span class="symbol">:disabled</span> (<span class="keyword">=</span> <span class="integer">1</span> number) <span class="symbol">:onClick</span> #(comp/transact! this `[(goto-page {<span class="symbol">:page-number</span> ~(<span class="keyword">dec</span> number)})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Prior Page</span><span class="delimiter">&quot;</span></span>)
      (dom/button {<span class="symbol">:onClick</span> #(comp/transact! this `[(goto-page {<span class="symbol">:page-number</span> ~(<span class="keyword">inc</span> number)})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Next Page</span><span class="delimiter">&quot;</span></span>)
      (ui-list-page current-page))))

(<span class="keyword">def</span> <span class="function">ui-list</span> (comp/factory LargeList))

(defsc Root [this {<span class="symbol">:keys</span> [pagination/list]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:pagination/list</span> (comp/get-initial-state LargeList {})})
   <span class="symbol">:query</span>         [{<span class="symbol">:pagination/list</span> (comp/get-query LargeList)}]}
  (dom/div (ui-list <span class="keyword">list</span>)))

(<span class="keyword">defn</span> <span class="function">initialize</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">To be used as started-callback. Load the first page.</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [app]}]
  (comp/transact! app `[(goto-page {<span class="symbol">:page-number</span> <span class="integer">1</span>})]))</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 47. <a id="QuerySecurity"></a><a href="#QuerySecurity">Query Security</a></div>
<div class="content">
<button class="inspector" onClick="book.main.focus('server-query-security')">Focus Inspector</button>
<div class="short narrow example" id="server-query-security"></div>
<br/>
<div class="listingblock source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.demos.server-query-security</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
    [com.fulcrologic.fulcro.mutations <span class="symbol">:refer</span> [defmutation]]
    [clojure.set <span class="symbol">:as</span> <span class="keyword">set</span>]
    [clojure.walk <span class="symbol">:as</span> walk]
    [com.fulcrologic.fulcro.dom <span class="symbol">:as</span> dom]
    [fulcro.server <span class="symbol">:as</span> server]
    [com.stuartsierra.component <span class="symbol">:as</span> c]
    [com.fulcrologic.fulcro.data-fetch <span class="symbol">:as</span> df]
    [fulcro.logging <span class="symbol">:as</span> log]
    [fulcro.client <span class="symbol">:as</span> fc]))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; SERVER:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="comment">; A map from &quot;entry-level&quot; concept/entity to a set of the allowed graph read/navigation keywords</span>
(<span class="keyword">def</span> <span class="function">whitelist</span> {<span class="symbol">:person</span> #{<span class="symbol">:name</span> <span class="symbol">:address</span> <span class="symbol">:mate</span>}})

(<span class="keyword">defn</span> <span class="function">keywords-in-query</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns all of the keywords in the given (arbitrarily nested) query.</span><span class="delimiter">&quot;</span></span>
  [query]
  (<span class="keyword">let</span> [result (<span class="keyword">atom</span> #{})
        _      (walk/prewalk
                 (<span class="keyword">fn</span> [k] (<span class="keyword">if</span> (<span class="keyword">keyword?</span> k) (<span class="keyword">swap!</span> result <span class="keyword">conj</span> k)))
                 query)]
    @result))

<span class="comment">; TODO: determine if the user is allowed to start at the given keyword for entity with given ID</span>
(<span class="keyword">defn</span> <span class="function">authorized-root-entity?</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns true if the given user is allowed to run a query rooted at the entity indicated by the combination of
  query keyword and entity ID.

  TODO: Implement some logic here.</span><span class="delimiter">&quot;</span></span>
  [user <span class="keyword">keyword</span> id] <span class="predefined-constant">true</span>)

(<span class="keyword">defn</span> <span class="function">is-authorized-query?</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns true if the given query is ok with respect to the top-level key of the API query (which should have already
  been authorized by `authorized-root-entity?`.</span><span class="delimiter">&quot;</span></span>
  [query top-key]
  (<span class="keyword">let</span> [keywords-allowed  (<span class="keyword">get</span> whitelist top-key #{})
        insecure-keywords (set/difference (keywords-in-query query) keywords-allowed)]
    (<span class="keyword">empty?</span> insecure-keywords)))

(<span class="keyword">defprotocol</span> <span class="class">Auth</span>
  (can-access-entity? [this user <span class="keyword">key</span> entityid] <span class="string"><span class="delimiter">&quot;</span><span class="content">Check if the given user is allowed to access the entity designated by the given key and entity id</span><span class="delimiter">&quot;</span></span>)
  (authorized-query? [this user top-key query] <span class="string"><span class="delimiter">&quot;</span><span class="content">Check if the given user is allowed to access all of the data in the query that starts at the given join key</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defrecord</span> <span class="class">Authorizer</span> []
  c/Lifecycle
  (start [this] this)
  (stop [this] this)
  Auth
  (can-access-entity? [this user <span class="keyword">key</span> entityid] (authorized-root-entity? user <span class="keyword">key</span> entityid))
  (authorized-query? [this user top-key query] (is-authorized-query? query top-key)))

(<span class="keyword">defn</span> <span class="function">make-authorizer</span> [] (map-&gt;Authorizer {}))

(<span class="keyword">def</span> <span class="function">pretend-database</span> {<span class="symbol">:person</span> {<span class="symbol">:id</span> <span class="integer">42</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:address</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">111 Nowhere</span><span class="delimiter">&quot;</span></span> <span class="symbol">:cc-number</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1234-4444-5555-2222</span><span class="delimiter">&quot;</span></span>}})

(server/defquery-root <span class="symbol">:person</span>
  (value [{<span class="symbol">:keys</span> [request query] <span class="symbol">:as</span> env} params]
    (<span class="keyword">let</span> [authorization (make-authorizer)
          user          (<span class="symbol">:user</span> request)]
      (log/info (<span class="keyword">str</span> authorization <span class="string"><span class="delimiter">&quot;</span><span class="content">w/user</span><span class="delimiter">&quot;</span></span> user))
      (<span class="keyword">or</span>
        (<span class="keyword">and</span>
          <span class="comment">;; of course, the params would be derived from the request/headers/etc.</span>
          (can-access-entity? authorization user <span class="symbol">:person</span> <span class="integer">42</span>)
          (authorized-query? authorization user <span class="symbol">:person</span> query))
        (<span class="keyword">throw</span> (ex-info <span class="string"><span class="delimiter">&quot;</span><span class="content">Unauthorized query!</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:status</span> <span class="integer">401</span> <span class="symbol">:body</span> {<span class="symbol">:query</span> query}})))
      <span class="comment">;; Emulate a datomic pull kind of operation...</span>
      (<span class="keyword">select-keys</span> (<span class="keyword">get</span> pretend-database <span class="symbol">:person</span>) query))))

<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="comment">;; CLIENT:</span>
<span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(<span class="keyword">def</span> <span class="function">initial-state</span> {<span class="symbol">:ui/react-key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">abc</span><span class="delimiter">&quot;</span></span>})

(<span class="keyword">defonce</span> <span class="function">app</span> (<span class="keyword">atom</span> (fc/make-fulcro-client
                     {<span class="symbol">:initial-state</span>    initial-state
                      <span class="symbol">:started-callback</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [reconciler]}]
                                          <span class="comment">; TODO</span>
                                          )})))

(defsc Person [this {<span class="symbol">:keys</span> [<span class="keyword">name</span> address cc-number]}]
  {<span class="symbol">:query</span> [<span class="symbol">:ui/fetch-state</span> <span class="symbol">:name</span> <span class="symbol">:address</span> <span class="symbol">:cc-number</span>]}
  (dom/div
    (dom/ul
      (dom/li (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">name: </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))
      (dom/li (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">address: </span><span class="delimiter">&quot;</span></span> address))
      (dom/li (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">cc-number: </span><span class="delimiter">&quot;</span></span> cc-number)))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (comp/factory Person))

(defmutation clear-error [params] (action [{<span class="symbol">:keys</span> [state]}] (<span class="keyword">swap!</span> state <span class="keyword">dissoc</span> <span class="symbol">:fulcro/server-error</span>)))

(defsc Root [this {<span class="symbol">:keys</span> [person fulcro/server-error] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span> [{<span class="symbol">:person</span> (comp/get-query Person)} <span class="symbol">:fulcro/server-error</span>]}
  (dom/div
    (<span class="keyword">when</span> server-error
      (dom/p (<span class="keyword">pr-str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">SERVER ERROR: </span><span class="delimiter">&quot;</span></span> server-error)))
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> []
                            (comp/transact! this `[(clear-error {})])
                            (df/load this <span class="symbol">:person</span> Person {<span class="symbol">:refresh</span> [<span class="symbol">:person</span>]}))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Query for person with credit card</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> []
                            (comp/transact! this `[(clear-error {})])
                            (df/load this <span class="symbol">:person</span> Person {<span class="symbol">:refresh</span> [<span class="symbol">:person</span>] <span class="symbol">:without</span> #{<span class="symbol">:cc-number</span>}}))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Query for person WITHOUT credit card</span><span class="delimiter">&quot;</span></span>)
    (df/lazily-loaded ui-person person)))</code></pre>
</div>
</div>
</div>
</div>
<style>
.com-rigsomelight-rendered-edn .keyval > .keyword {
 color: rgb(196,33,0);
 padding-right: 10px;
}

.com-rigsomelight-rendered-edn .collection {
  position: relative;
}

.com-rigsomelight-rendered-edn .vector,
.com-rigsomelight-rendered-edn .set,
.com-rigsomelight-rendered-edn .seq  {
  padding-left: 0.9em;
  padding-right: 0.9em;
}

.com-rigsomelight-rendered-edn .set {
  padding-left: 1.2em;
}


.com-rigsomelight-rendered-edn .collection.map {
  padding-left: 0.8em;
  display: inline-block;
  vertical-align: top;
}

.com-rigsomelight-rendered-edn .vector,
.com-rigsomelight-rendered-edn .set,
.com-rigsomelight-rendered-edn .seq {
  display: inline-block;
  vertical-align: top;
}

.com-rigsomelight-rendered-edn .vector > .contents {
  background-color: rgba(0,0,0,0.01);
}

.com-rigsomelight-rendered-edn .keyval {
  display: inline-block;
}

.com-rigsomelight-rendered-edn .collection.map > .contents > .separator  {
padding-right: 10px;
}

.com-rigsomelight-rendered-edn .collection .collection > .contents {
/*  background-color: rgba(0,0,0,0.02); */
}

.com-rigsomelight-rendered-edn .collection .contents > .collection:nth-child(even) {
background-color: rgba(0,0,0,0.04);
}

.com-rigsomelight-rendered-edn .contents {
  display: inline-block;
}

.com-rigsomelight-rendered-edn .opener,
.com-rigsomelight-rendered-edn .closer {
 color: #999;
}

.com-rigsomelight-rendered-edn .collection.map > .opener,
.com-rigsomelight-rendered-edn .collection.vector > .opener,
.com-rigsomelight-rendered-edn .collection.seq > .opener,
.com-rigsomelight-rendered-edn .collection.set > .opener {
 position: absolute;
 top: 0px;
 left: 3px;
}
.com-rigsomelight-rendered-edn .collection.map > .closer {
 bottom: 0px;
 right: 0px;
 display: block;
}

.com-rigsomelight-rendered-edn .collection.vector > .closer,
.com-rigsomelight-rendered-edn .collection.seq > .closer,
.com-rigsomelight-rendered-edn .collection.set > .closer {
 position: absolute;
 bottom: 0px;
 right: 0px;
 display: block;
}
</style>

<!-- Stripe API for Book Demo -->
<script src="https://js.stripe.com/v3/"></script>
<!-- The book demos -->
<script src="js/book/book.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-107376541-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107376541-3');
</script>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 37<br>
Last updated 2019-09-03 12:59:46 +0530
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>